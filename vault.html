<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTYLD Vault • Mechanical Temp</title>

  <link rel="icon" href="https://i.imgur.com/YJvJw7V.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    canvas { background: transparent; }
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">

  <header class="sticky top-0 z-30 bg-slate-900/80 backdrop-blur border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="https://www.mechanicaltemp.com" class="flex items-center gap-3">
        <img src="https://i.imgur.com/YJvJw7V.png" alt="Mechanical Temp" class="h-10 w-auto">
        <span class="font-bold tracking-wide text-slate-200 hidden sm:inline"></span>
      </a>
      <nav class="flex items-center gap-2">
        <a href="https://vault.mechanicaltemp.com" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">Home</a>
        <a href="lend.html" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">Credit</a>
        <button id="btnAbout" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">About</button>
      </nav>
    </div>
  </header>

  <section class="bg-gradient-to-b from-slate-900 to-sky-900 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-12 sm:py-16 text-center">
      <h1 class="mt-1 text-4xl sm:text-5xl md:text-6xl font-black tracking-tight text-white">
        MTYLD Vault
      </h1>
      <p class="mt-3 md:mt-4 text-base md:text-lg text-sky-200">
        Yield backed by <span class="font-semibold text-sky-100">Mechanical Temp</span> revenue
      </p>
    </div>
  </section>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-4">

    <div class="grid md:grid-cols-3 gap-4 items-start">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 h-full">
        <div class="flex items-center gap-2 mb-3">
          <button id="btnConnect" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Connect Wallet</button>
          <button id="btnRefresh" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">↻</button>
        </div>
        <div class="text-slate-400 font-mono text-sm truncate" id="addr">Not connected</div>
        <div class="mt-2 text-xs text-slate-500">Vault Contract:</div>
        <div class="font-mono text-slate-300 truncate text-sm">0xdFD1C01678e713FDe1630c9db921e6206f3795b4</div>
        <div class="mt-2 text-xs text-slate-500">Owner:</div>
        <div class="font-mono text-slate-300 truncate text-sm" id="ownerLine">—</div>
      </div>

      <div class="md:col-span-2 bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-center sm:text-left">
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Price (NAV)</div>
            <div class="font-mono text-lg text-slate-100" id="price">$–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Active Treasury</div>
            <div class="font-mono text-lg text-slate-100" id="treasuryActive">$–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Pending Revenue</div>
            <div class="font-mono text-lg text-slate-100" id="pending">$–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Pending Release In</div>
            <div class="font-mono text-lg text-slate-100" id="countdown">–</div>
          </div>
        </div>
        <div class="mt-2 text-xs text-amber-300" id="tinyWarn" style="display:none">
          Note: Treasury has sub-$0.001 “dust”. With very low supply this can make NAV appear jumpy.
        </div>
      </div>
    </div>

    <div id="userPanel" class="hidden bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="text-slate-300 font-semibold mb-2">Your Position</div>
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-center sm:text-left">
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">MTYLD Balance</div>
          <div class="font-mono text-lg text-slate-100" id="userBal">—</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Value (USDC)</div>
          <div class="font-mono text-lg text-slate-100" id="userVal">$—</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Share of Vault</div>
          <div class="font-mono text-lg text-slate-100" id="userShare">—</div>
        </div>
      </div>
    </div>

    <div class="border-t border-slate-800"></div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 font-semibold">USDC → MTYLD (Mint)</div>
        <div class="mt-2 flex gap-2">
          <input id="mintAmount" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
          <button id="btnMintMax" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Max</button>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <input id="mintSlippage" value="0.5" placeholder="Slippage %" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
          <button id="btnPreviewMint" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Preview</button>
        </div>
        <div class="font-mono text-slate-300 mt-2" id="mintPreview"></div>
        <button id="btnMint" disabled class="mt-2 w-full px-4 py-2 rounded-lg bg-sky-500 disabled:bg-slate-700 hover:bg-sky-600 text-white font-semibold">Mint</button>
      </div>

      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 font-semibold">MTYLD → USDC (Redeem)</div>
        <div class="mt-2 flex gap-2">
          <input id="redeemAmount" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
          <button id="btnRedeemMax" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Max</button>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <input id="redeemSlippage" value="0.5" placeholder="Slippage %" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
          <button id="btnPreviewRedeem" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Preview</button>
        </div>
        <div class="font-mono text-slate-300 mt-2" id="redeemPreview"></div>
        <button id="btnRedeem" disabled class="mt-2 w-full px-4 py-2 rounded-lg bg-sky-500 disabled:bg-slate-700 hover:bg-sky-600 text-white font-semibold">Redeem</button>
      </div>
    </div>

    <div id="ownerPanel" class="hidden bg-slate-900 border border-slate-800 rounded-2xl p-4">
      
      <div class="flex items-center justify-between gap-3">
        <div class="font-semibold text-lg text-white">
          Admin Command Center
          <span class="ml-2 text-xs px-2 py-1 rounded-full bg-sky-900 text-sky-200 border border-sky-700">Owner</span>
        </div>
        <div class="text-right">
             <div class="font-mono text-slate-300 text-sm" id="epochState">Epoch: —</div>
             <div class="font-mono text-red-400 text-xs font-bold uppercase" id="pausedState" style="display:none">⚠ PAUSED ⚠</div>
        </div>
      </div>
      <div class="h-px bg-slate-800 my-3"></div>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="text-slate-300 font-medium">1. Revenue Injection</div>
          <div class="text-xs text-slate-500 mb-2">Queues USDC. Does not affect NAV until Applied.</div>
          <div class="flex gap-2">
              <input id="revAmount" placeholder="Amount (USDC)" inputmode="decimal" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="btnQueueRev" class="px-4 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold whitespace-nowrap">Queue</button>
          </div>
          <div class="font-mono text-xs text-slate-400 mt-1" id="revMsg"></div>
        </div>

        <div>
          <div class="text-slate-300 font-medium">2. Epoch Controls</div>
          <div class="text-xs text-slate-500 mb-2">Manage pending revenue and close windows.</div>
          <div class="flex flex-wrap gap-2">
            <button id="btnApply" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 border border-slate-700">Apply Pending</button>
            <button id="btnBeginClose" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 border border-slate-700">Begin Close</button>
            <button id="btnEndClose" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 border border-slate-700">End Close</button>
          </div>
          <div id="pendingHint" class="font-mono text-xs text-slate-400 mt-1">—</div>
        </div>
      </div>

      <div class="h-px bg-slate-800 my-4"></div>

      <div class="bg-slate-800/30 border border-slate-700/50 rounded-xl p-3 mb-4">
        <div class="text-slate-200 font-semibold mb-1">Employee Payroll (Batch Sender)</div>
        <p class="text-xs text-slate-400 mb-2">Distribute MTYLD tokens to multiple wallets in one click. Mint tokens to yourself first.</p>
        
        <textarea id="batchInput" rows="3" 
          placeholder="0xAddress1, 100&#10;0xAddress2, 50.5" 
          class="w-full px-3 py-2 rounded-lg bg-slate-900 border border-slate-700 text-slate-100 font-mono text-xs placeholder-slate-600 focus:outline-none focus:border-sky-500"></textarea>
        
        <div class="flex items-center justify-between mt-2">
            <div class="text-xs text-slate-400" id="batchStats">Wait: 0 | Total: 0</div>
            <button id="btnSendBatch" class="px-4 py-1.5 rounded-lg bg-sky-600 hover:bg-sky-500 text-white font-semibold text-xs">Send Batch</button>
        </div>
        <div id="batchLog" class="mt-2 text-xs font-mono text-slate-300 max-h-24 overflow-y-auto whitespace-pre-wrap hidden"></div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="bg-slate-800/30 border border-slate-700/50 rounded-xl p-3">
             <div class="text-slate-200 font-semibold text-sm">Supply Cap (TVL Limit)</div>
             <div class="text-xs text-slate-500 mb-2">Max MTYLD tokens allowed.</div>
             <div class="flex gap-2">
                 <input id="maxSupplyIn" placeholder="e.g. 1000000" class="w-full px-3 py-1.5 rounded-lg bg-slate-900 border border-slate-700 text-slate-100 text-sm">
                 <button id="btnSetCap" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600 text-white text-xs whitespace-nowrap">Set Cap</button>
             </div>
             <div id="capLine" class="text-xs font-mono text-slate-400 mt-1">Current Cap: —</div>
        </div>

        <div class="bg-red-900/10 border border-red-900/30 rounded-xl p-3 flex flex-col justify-between">
             <div>
                <div class="text-red-200 font-semibold text-sm">Emergency Controls</div>
                <div class="text-xs text-red-300/60 mb-2">Freeze all Mint/Redeem actions.</div>
             </div>
             <div class="flex items-center gap-2">
                 <button id="btnPause" class="flex-1 px-3 py-2 rounded-lg bg-red-600/20 hover:bg-red-600/40 text-red-200 border border-red-800 text-xs font-bold transition-colors">PAUSE CONTRACT</button>
                 <button id="btnUnpause" class="flex-1 px-3 py-2 rounded-lg bg-emerald-600/20 hover:bg-emerald-600/40 text-emerald-200 border border-emerald-800 text-xs font-bold transition-colors">UNPAUSE</button>
             </div>
        </div>
      </div>
      
      <div class="mt-4 bg-slate-800/30 border border-slate-700/50 rounded-xl p-3">
          <div class="flex items-center justify-between cursor-pointer" onclick="document.getElementById('rescueBody').classList.toggle('hidden')">
             <div class="text-slate-200 font-semibold text-sm">⚠️ Token Rescue</div>
             <div class="text-xs text-slate-500">Recover lost tokens (accidental sends) ▼</div>
          </div>
          <div id="rescueBody" class="hidden mt-3 space-y-3">
              <div class="p-2 bg-slate-900/50 rounded text-xs text-slate-400 border border-slate-800">
                  <span class="text-amber-400">Status:</span> <span id="rescueStatus" class="font-mono">No active rescue</span>
              </div>
              
              <div id="rescueForm" class="grid grid-cols-2 gap-2">
                  <input id="resToken" placeholder="Token Address (0x...)" class="col-span-2 px-3 py-1.5 rounded bg-slate-900 border border-slate-700 text-xs text-slate-100">
                  <input id="resAmt" placeholder="Amount (Wei)" class="px-3 py-1.5 rounded bg-slate-900 border border-slate-700 text-xs text-slate-100">
                  <input id="resTo" placeholder="Recipient (0x...)" class="px-3 py-1.5 rounded bg-slate-900 border border-slate-700 text-xs text-slate-100">
                  <button id="btnAnnounceRescue" class="col-span-2 py-1.5 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded text-xs font-semibold">Announce Rescue</button>
              </div>

              <button id="btnExecuteRescue" disabled class="hidden w-full py-2 bg-amber-600 hover:bg-amber-500 text-white rounded text-xs font-bold">EXECUTE PENDING RESCUE</button>
          </div>
      </div>

      <div class="h-px bg-slate-800 my-4"></div>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="text-slate-300 font-medium text-sm">Configuration</div>
          <div class="mt-2 flex items-center gap-2">
            <input id="navDelay" placeholder="Delay (sec)" class="w-20 px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 text-sm">
            <button id="btnSetDelay" class="px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs">Set Delay</button>
          </div>
          <div id="delayLine" class="text-xs text-slate-500 mt-1">Current: —</div>
          
          <div class="mt-2 flex items-center gap-2">
             <button id="btnGuardOn" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs border border-slate-700">Guard On</button>
             <button id="btnGuardOff" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs border border-slate-700">Guard Off</button>
             <span id="guardedLine" class="text-xs text-slate-500 ml-1">Avg: -</span>
          </div>
        </div>

        <div>
          <div class="text-slate-300 font-medium text-sm">Fees & Whitelist</div>
          <div class="flex gap-2 mt-2">
            <input id="mintFee" placeholder="Mint Bps" class="w-16 px-2 py-1.5 rounded bg-slate-800 border border-slate-700 text-slate-100 text-xs">
            <input id="redeemFee" placeholder="Redeem Bps" class="w-16 px-2 py-1.5 rounded bg-slate-800 border border-slate-700 text-slate-100 text-xs">
            <button id="btnSetFees" class="px-2 py-1.5 rounded bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs">Update</button>
          </div>
          <div class="mt-2 flex gap-2">
             <input id="wlAddr" placeholder="Whitelist Addr" class="flex-1 px-2 py-1.5 rounded bg-slate-800 border border-slate-700 text-slate-100 text-xs">
             <button id="btnWhitelistOn" class="px-2 py-1.5 rounded bg-slate-800 hover:bg-slate-700 text-green-400/20 text-green-400 text-xs">+</button>
             <button id="btnWhitelistOff" class="px-2 py-1.5 rounded bg-slate-800 hover:bg-slate-700 text-red-400/20 text-red-400 text-xs">-</button>
          </div>
          <div id="wlMsg" class="text-xs text-slate-500 mt-1"></div>
        </div>
      </div>
    </div>

    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <div class="text-slate-300">Performance</div>
          <div id="apyLine" class="font-mono text-slate-200">APY (30d annualized): —</div>
          <div id="changeLine" class="font-mono text-slate-400">Δ 24h: —  •  Δ 7d: —  •  Δ 30d: —</div>
        </div>
        <div class="flex gap-2">
          <button id="btnExportCSV" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Export NAV CSV</button>
          <button id="btnResetHistory" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Reset History</button>
        </div>
      </div>
      <div class="mt-4">
        <canvas id="navChart" height="120"></canvas>
      </div>
    </div>

    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="text-slate-300">USDC (Arbitrum)</div>
      <div class="font-mono text-slate-200">0xaf88d065e77c8cC2239327C5EDb3A432268e5831</div>
    </div>

  </main>

  <section id="aboutMTYLD" class="bg-slate-950 border-t border-slate-800 py-12 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-8">
        <h2 class="text-3xl sm:text-4xl font-black text-white">About the MTYLD Vault</h2>
        <p class="mt-2 text-sky-300 text-lg">Real yield, powered by Mechanical Temp HVAC revenue</p>
      </div>
      <div class="max-w-3xl mx-auto space-y-4">
        <details class="group bg-slate-900 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between p-4 cursor-pointer">
            <h3 class="font-semibold text-slate-200">How does the yield work?</h3>
            <span class="text-sky-500 group-open:rotate-180 transition-transform">▼</span>
          </summary>
          <div class="px-4 pb-4 text-slate-400">
            Mechanical Temp generates revenue from real-world HVAC contracts. A portion of this revenue is converted to USDC and injected into the vault. This increases the <b>Net Asset Value (NAV)</b> of the vault, meaning every MTYLD token is worth more USDC.
          </div>
        </details>
        <details class="group bg-slate-900 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between p-4 cursor-pointer">
            <h3 class="font-semibold text-slate-200">Is my deposit locked?</h3>
            <span class="text-sky-500 group-open:rotate-180 transition-transform">▼</span>
          </summary>
          <div class="px-4 pb-4 text-slate-400">
            No. You can redeem your MTYLD for USDC at any time, unless the vault is in "Epoch Close" mode (a brief window when revenue is being added to prevent front-running).
          </div>
        </details>
        <details class="group bg-slate-900 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between p-4 cursor-pointer">
            <h3 class="font-semibold text-slate-200">What is the "First Mint" tax?</h3>
            <span class="text-sky-500 group-open:rotate-180 transition-transform">▼</span>
          </summary>
          <div class="px-4 pb-4 text-slate-400">
            To protect the protocol from "inflation attacks," the very first depositor burns a tiny amount of shares (1000 wei, less than $0.000001). This is a standard security practice.
          </div>
        </details>
      </div>
    </div>
  </section>

  <footer class="mt-10 border-t border-slate-800 bg-slate-900">
    <div class="max-w-7xl mx-auto px-4 py-8 text-center">
      <p class="text-slate-300">
        Powered by <a href="https://www.mechanicaltemp.com" class="text-sky-400 hover:text-sky-300 font-semibold">Mechanical Temp</a>
        <span class="text-slate-500">•</span> Southfield, MI
      </p>
      <p class="mt-2 text-xs text-slate-500">© <span id="yr"></span> Mechanical Temp • All Rights Reserved</p>
    </div>
  </footer>

  <script>
  document.getElementById('yr').textContent = new Date().getFullYear();
  const aboutBtn = document.getElementById("btnAbout");
  const aboutSection = document.querySelector("#aboutMTYLD");
  if (aboutBtn && aboutSection) {
    aboutBtn.addEventListener("click", () => {
      aboutSection.scrollIntoView({ behavior: "smooth", block: "start" });
      aboutSection.querySelectorAll("details").forEach(d => d.open = true);
    });
  }

  (async () => {
    // ===== Config =====
    const VAULT = "0xdFD1C01678e713FDe1630c9db921e6206f3795b4";
    const USDC  = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831";
    const CHAIN_ID_ARBITRUM = 42161;

    // ABIs
    const VAULT_ABI = [
      "function MAX_FEE_BPS() view returns (uint16)",
      "function RESCUE_DELAY() view returns (uint256)",
      "function allowance(address,address) view returns (uint256)",
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function epochClosing() view returns (bool)",
      "function feeRecipient() view returns (address)",
      "function feeRoundUp() view returns (bool)",
      "function guardedLaunch() view returns (bool)",
      "function isWhitelistedMinter(address) view returns (bool)",
      "function maxSupply() view returns (uint256)",
      "function mintFeeBps() view returns (uint16)",
      "function name() view returns (string)",
      "function navDelaySec() view returns (uint256)",
      "function owner() view returns (address)",
      "function paused() view returns (bool)",
      "function pendingReleaseAt() view returns (uint64)",
      "function pendingReleaseReady() view returns (bool)",
      "function pendingRevenueUSDC() view returns (uint256)",
      "function previewMint(uint256 usdcAmount) view returns (uint256 mtyldOut, uint256 price)",
      "function previewRedeem(uint256 mtyldAmount) view returns (uint256 usdcOut, uint256 price)",
      "function pricePerToken() view returns (uint256)",
      "function redeemFeeBps() view returns (uint16)",
      "function rescuable(address) view returns (bool)",
      "function rescueReq() view returns (address token, uint256 amount, address to, uint64 eta)",
      "function stable() view returns (address)",
      "function stableDecimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function totalSupply() view returns (uint256)",
      "function treasury18() view returns (uint256)",
      "function treasuryActiveUSDC() view returns (uint256)",
      "function treasuryUSDC() view returns (uint256)",
      "function approve(address s, uint256 a) returns (bool)",
      "function announceRescue(address token, uint256 amount, address to)",
      "function applyPendingRevenue()",
      "function beginEpochClose()",
      "function endEpochClose()",
      "function executeRescue()",
      "function injectRevenue(uint256 usdcAmount)",
      "function mint(uint256 usdcAmount, uint256 minMtyldOut)",
      "function pause()",
      "function redeem(uint256 mtyldAmount, uint256 minUsdcOut)",
      "function setFees(uint16 _mintFeeBps, uint16 _redeemFeeBps, address _recipient, bool _roundUp)",
      "function setGuardedLaunch(bool on)",
      "function setMaxSupply(uint256 cap)",
      "function setNavDelay(uint256 seconds_)",
      "function setWhitelist(address user, bool allowed)",
      "function transfer(address to, uint256 a) returns (bool)",
      "function transferFrom(address f, address t, uint256 a) returns (bool)",
      "function transferOwnership(address n)",
      "function unpause()",
      "function whitelistRescuable(address token, bool allowed)",
      "constructor(address usdc)",
      "error BadDecimals()", "error EpochClosing()", "error Guarded()",
      "error InsufficientTreasury()", "error InvalidAddress()", "error InvalidFee()",
      "error NotRescuable()", "error TooEarly()", "error ZeroAmount()", "error InitLiquidityTooLow()"
    ];

    const ERC20_ABI = [
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 amount) returns (bool)",
      "function balanceOf(address account) view returns (uint256)",
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)"
    ];

    // ===== DOM =====
    const el = (id) => document.getElementById(id);
    const addrEl = el("addr"), priceEl = el("price"), actEl = el("treasuryActive"), pendEl = el("pending"), cdEl = el("countdown");
    const tinyWarn = el("tinyWarn");
    const userPanel = el("userPanel"), userBalEl = el("userBal"), userValEl = el("userVal"), userShareEl = el("userShare");
    const mintAmt = el("mintAmount"), mintSlip = el("mintSlippage"), mintPrev = el("mintPreview"), mintBtn = el("btnMint");
    const redAmt = el("redeemAmount"), redSlip = el("redeemSlippage"), redPrev = el("redeemPreview"), redBtn = el("btnRedeem");
    
    // Admin DOM
    const ownerPanel = el("ownerPanel"), ownerLine = el("ownerLine");
    const revAmount = el("revAmount"), revMsg = el("revMsg");
    const btnApply = el("btnApply"), btnBeginClose = el("btnBeginClose"), btnEndClose = el("btnEndClose"), epochState = el("epochState"), pendingHint = el("pendingHint");
    const navDelay = el("navDelay"), delayLine = el("delayLine");
    const mintFee = el("mintFee"), redeemFee = el("redeemFee"), btnSetFees = el("btnSetFees"), wlAddr = el("wlAddr"), wlMsg = el("wlMsg");
    const btnGuardOn = el("btnGuardOn"), btnGuardOff = el("btnGuardOff"), guardedLine = el("guardedLine");
    const btnMintMax = el("btnMintMax"), btnRedeemMax = el("btnRedeemMax");
    // New Admin DOM
    const pausedState = el("pausedState"), btnPause = el("btnPause"), btnUnpause = el("btnUnpause");
    const maxSupplyIn = el("maxSupplyIn"), btnSetCap = el("btnSetCap"), capLine = el("capLine");
    const rescueStatus = el("rescueStatus"), btnAnnounceRescue = el("btnAnnounceRescue"), btnExecuteRescue = el("btnExecuteRescue");
    const resToken = el("resToken"), resAmt = el("resAmt"), resTo = el("resTo"), rescueForm = el("rescueForm");
    const batchInput = el("batchInput"), btnSendBatch = el("btnSendBatch"), batchStats = el("batchStats"), batchLog = el("batchLog");

    // ===== Safer unit helpers =====
    const f6  = (x) => ethers.formatUnits(x, 6);
    const f18 = (x) => ethers.formatUnits(x, 18);
    const p6  = (s) => ethers.parseUnits(String(s||"0"), 6);
    const p18 = (s) => ethers.parseUnits(String(s||"0"), 18);

    // ===== NAV history =====
    const NAV_HISTORY_KEY = "mtyld_nav_history_" + VAULT;
    let navHistory = []; 
    let navChart;

    function loadHistory(){ try{ navHistory = JSON.parse(localStorage.getItem(NAV_HISTORY_KEY) || "[]"); }catch{ navHistory = []; } }
    function saveHistory(){ try{ localStorage.setItem(NAV_HISTORY_KEY, JSON.stringify(navHistory)); }catch{} }
    function pruneHistory(){ const cutoff = Math.floor(Date.now()/1000) - 370*24*3600; navHistory = navHistory.filter(pt => pt.t >= cutoff); }
    function recordNavSample(price1e18){
      const val = +ethers.formatUnits(price1e18, 18);
      if (!isFinite(val) || val <= 0 || val > 10000) return;
      const now = Math.floor(Date.now()/1000);
      const last = navHistory[navHistory.length-1];
      if (!last || now - last.t >= 300 || last.p !== val) {
        navHistory.push({ t: now, p: val });
        pruneHistory(); saveHistory(); drawNavChart();
      }
    }
    function lookupPriceAgo(secondsBack){
      const target = Math.floor(Date.now()/1000) - secondsBack;
      if (!navHistory.length) return null;
      for (let i=navHistory.length-1;i>=0;i--) if (navHistory[i].t <= target) return navHistory[i].p;
      return navHistory[0]?.p ?? null;
    }
    function pctChange(curr, prev){ if (!curr || !prev || prev===0) return null; return ((curr - prev)/prev)*100; }
    function annualizedFromWindow(curr, past, seconds){
      if (!curr || !past || past===0) return null;
      const ratio = curr/past, years = seconds / (365*24*3600);
      return (Math.pow(ratio, 1/years) - 1) * 100;
    }
    function drawNavChart(){
      const c = document.getElementById("navChart"); if (!c) return;
      const labels = navHistory.map(p => new Date(p.t*1000).toLocaleString());
      const data = navHistory.map(p => p.p);
      if (!navChart){
        navChart = new Chart(c.getContext("2d"), {
          type: 'line',
          data: { labels, datasets: [{ label: "NAV ($ per MTYLD)", data, tension: 0.25, fill: false, pointRadius: 0, borderWidth: 2 }]},
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false }},
            scales: {
              x: { grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { color: '#94a3b8' } },
              y: { beginAtZero: false, grid: { color: 'rgba(148,163,184,0.1)' }, ticks: { color: '#94a3b8' } }
            }
          }
        });
      } else {
        navChart.data.labels = labels;
        navChart.data.datasets[0].data = data;
        navChart.update();
      }
    }
    function updatePerformanceLines(currentPrice1e18){
      const curr = +ethers.formatUnits(currentPrice1e18, 18);
      const p24h = lookupPriceAgo(24*3600);
      const p7d  = lookupPriceAgo(7*24*3600);
      const p30d = lookupPriceAgo(30*24*3600);
      const fmt = v => (v===null ? "—" : ((v>=0?"+":"") + v.toFixed(2) + "%"));
      const c24 = p24h ? pctChange(curr, p24h) : null;
      const c7  = p7d  ? pctChange(curr, p7d)  : null;
      const c30 = p30d ? pctChange(curr, p30d) : null;
      const elChange = el("changeLine");
      if (elChange) elChange.textContent = `Δ 24h: ${fmt(c24)}  •  Δ 7d: ${fmt(c7)}  •  Δ 30d: ${fmt(c30)}`;
      let apy = null;
      if (p30d) apy = annualizedFromWindow(curr, p30d, 30*24*3600);
      else if (p7d) apy = annualizedFromWindow(curr, p7d, 7*24*3600);
      else if (p24h) apy = annualizedFromWindow(curr, p24h, 24*3600);
      const elApy = el("apyLine");
      if (elApy) elApy.textContent = "APY (30d annualized): " + (apy===null ? "—" : apy.toFixed(2) + "%");
    }

    // ===== Ethers =====
    let provider, signer, acct, vault, usdc, vaultOwner;

    const trunc = (a) => a ? a.slice(0,6)+"…"+a.slice(-4) : "—";
    const shortErr = (e) => {
      const s = (e && (e.info?.error?.message || e.shortMessage || e.message)) || String(e);
      return "Error: " + s.replace(/execution reverted: /i,'').slice(0,180);
    };
    function humanize(s){
      const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60;
      return (h?`${h}h `:"") + (m?`${m}m `:"") + `${sec}s`;
    }

    async function ensureProvider(){
      if (!window.ethereum) { alert("No wallet found. Please install/enable MetaMask."); throw new Error("no wallet"); }
      provider = new ethers.BrowserProvider(window.ethereum);
      const net = await provider.getNetwork();
      if (Number(net.chainId) !== CHAIN_ID_ARBITRUM) {
        try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xa4b1' }] }); }
        catch (e) { alert("Please switch to Arbitrum One."); throw e; }
      }
      signer = await provider.getSigner();
      acct = await signer.getAddress();
      vault = new ethers.Contract(VAULT, VAULT_ABI, signer);
      usdc  = new ethers.Contract(USDC, ERC20_ABI, signer);
      addrEl.textContent = trunc(acct);

      vaultOwner = await vault.owner();
      ownerLine.textContent = trunc(vaultOwner);
      ownerPanel.classList.toggle("hidden", vaultOwner.toLowerCase() !== acct.toLowerCase());
      userPanel.classList.remove("hidden");
    }

    async function loadOwnerState(){
      if (!vault) return;
      try {
        const [mf, rf, fr, gl, delay, closing, pending, relAt, isPaused, cap, res] = await Promise.all([
          vault.mintFeeBps(), vault.redeemFeeBps(), vault.feeRecipient(),
          vault.guardedLaunch(), vault.navDelaySec(), vault.epochClosing(),
          vault.pendingRevenueUSDC(), vault.pendingReleaseAt(),
          vault.paused(), vault.maxSupply(), vault.rescueReq()
        ]);
        
        // Basic Settings
        mintFee.value = Number(mf); redeemFee.value = Number(rf);
        guardedLine.textContent = gl ? "Guarded: ON" : "Guarded: OFF";
        delayLine.textContent = "Current: " + Number(delay) + "s";
        epochState.textContent = "Epoch: " + (closing ? "Closing (paused)" : "Open");

        // Paused State
        pausedState.style.display = isPaused ? "block" : "none";
        btnPause.style.display = isPaused ? "none" : "block";
        btnUnpause.style.display = isPaused ? "block" : "none";

        // Pending Rev
        const now = Math.floor(Date.now()/1000);
        const secs = Number(relAt) > now ? (Number(relAt)-now) : 0;
        const ready = secs === 0 && BigInt(pending) > 0n;
        pendingHint.textContent = ready ? "Ready to apply ✅" : (BigInt(pending)>0n ? "Waiting for release…" : "No pending revenue");

        // Supply Cap
        capLine.textContent = "Current Cap: " + ethers.formatUnits(cap, 18);

        // Rescue
        const rAmt = res[1]; // amount
        const rEta = Number(res[3]); // eta
        if (rAmt > 0n) {
           rescueForm.classList.add("hidden");
           btnExecuteRescue.classList.remove("hidden");
           const wait = rEta - now;
           if (wait > 0) {
              rescueStatus.textContent = `Pending: ${humanize(wait)} wait.`;
              btnExecuteRescue.disabled = true;
              btnExecuteRescue.textContent = `WAIT ${humanize(wait)}`;
           } else {
              rescueStatus.textContent = "Rescue Ready to Execute!";
              btnExecuteRescue.disabled = false;
              btnExecuteRescue.textContent = "EXECUTE RESCUE NOW";
           }
        } else {
           rescueForm.classList.remove("hidden");
           btnExecuteRescue.classList.add("hidden");
           rescueStatus.textContent = "No active rescue.";
        }

      } catch (e) { console.error("Owner load err", e); }
    }

    async function loadUserPanel(price){
      if (!vault || !acct) return;
      try{
        const [bal, ts] = await Promise.all([ vault.balanceOf(acct), vault.totalSupply() ]);
        const bal18 = +ethers.formatUnits(bal, 18);
        userBalEl.textContent = bal18.toLocaleString(undefined,{maximumFractionDigits:6}) + " MTYLD";
        const navUsd = +ethers.formatUnits(price, 18);
        const valUsd = bal18 * navUsd;
        userValEl.textContent = "$" + valUsd.toFixed(2);
        const supply = +ethers.formatUnits(ts, 18);
        const share = supply > 0 ? (bal18 / supply) * 100 : 0;
        userShareEl.textContent = (isFinite(share) ? share.toFixed(4) : "0.0000") + "%";
      } catch(e){ console.error(e); }
    }

    async function refresh(){
      try{
        if (!provider){
          provider = window.ethereum ? new ethers.BrowserProvider(window.ethereum)
                                     : new ethers.JsonRpcProvider("https://arb1.arbitrum.io/rpc");
        }
        const readVault = new ethers.Contract(VAULT, VAULT_ABI, provider);
        const [price, active, pending, relAt, supply] = await Promise.all([
          readVault.pricePerToken(),
          readVault.treasuryActiveUSDC(),
          readVault.pendingRevenueUSDC(),
          readVault.pendingReleaseAt(),
          readVault.totalSupply()
        ]);

        const priceUsd = +ethers.formatUnits(price, 18);
        priceEl.textContent = `$${priceUsd.toFixed(6)}`;
        const activeUsd = +ethers.formatUnits(active, 6);
        const pendingUsd = +ethers.formatUnits(pending, 6);

        actEl.textContent  = `$${activeUsd.toLocaleString(undefined,{minimumFractionDigits:6, maximumFractionDigits:6})}`;
        pendEl.textContent = `$${pendingUsd.toLocaleString(undefined,{minimumFractionDigits:6, maximumFractionDigits:6})}`;
        tinyWarn.style.display = (activeUsd > 0 && activeUsd < 0.001) ? '' : 'none';

        const now = Math.floor(Date.now()/1000);
        const secs = Number(relAt) > now ? (Number(relAt)-now) : 0;
        cdEl.textContent = secs ? humanize(secs) : (BigInt(pending)>0n ? "Queued (awaiting apply)" : "—");

        if (vault && signer && acct) { await loadUserPanel(price); }
        if (vault && vaultOwner && signer && vaultOwner.toLowerCase() === (await signer.getAddress()).toLowerCase()) {
          await loadOwnerState();
        }

        recordNavSample(price);
        updatePerformanceLines(price);
      }catch(e){ console.error(e); }
    }

    // ===== Mint/Redeem =====
    document.getElementById("btnPreviewMint").onclick = async () => {
      try {
        if (!provider) await ensureProvider();
        const usdcAmt = p6(mintAmt.value);
        if (usdcAmt <= 0n) { mintPrev.textContent = "Enter amount"; return; }
        const [mtyldOut, price] = await vault.previewMint(usdcAmt);
        mintPrev.textContent = `Est. MTYLD: ${ethers.formatUnits(mtyldOut,18)} @ $${(+ethers.formatUnits(price,18)).toFixed(6)}`;
        mintBtn.disabled = false;
      } catch (e) { console.error(e); mintPrev.textContent = shortErr(e); }
    };
    document.getElementById("btnMint").onclick = async () => {
      try {
        mintBtn.disabled = true;
        if (!provider) await ensureProvider();
        const usdcAmt = p6(mintAmt.value);
        const slipBps = Math.round((+mintSlip.value || 0.5) * 100);
        const [mtyldOut] = await vault.previewMint(usdcAmt);
        const minOut = mtyldOut - (mtyldOut * BigInt(slipBps) / 10000n);
        const allowance = await usdc.allowance(acct, VAULT);
        if (allowance < usdcAmt) { const txa = await usdc.approve(VAULT, usdcAmt); await txa.wait(); }
        const tx = await vault.mint(usdcAmt, minOut); await tx.wait();
        mintPrev.textContent = "Minted ✅"; await refresh();
      } catch (e) { console.error(e); mintPrev.textContent = shortErr(e); }
      finally { mintBtn.disabled = false; }
    };
    document.getElementById("btnPreviewRedeem").onclick = async () => {
      try {
        if (!provider) await ensureProvider();
        const mtyldAmt = p18(redAmt.value);
        if (mtyldAmt <= 0n) { redPrev.textContent = "Enter amount"; return; }
        const [usdcOut, price] = await vault.previewRedeem(mtyldAmt);
        redPrev.textContent = `Est. USDC: ${ethers.formatUnits(usdcOut,6)} @ $${(+ethers.formatUnits(price,18)).toFixed(6)}`;
        redBtn.disabled = false;
      } catch (e) { console.error(e); redPrev.textContent = shortErr(e); }
    };
    document.getElementById("btnRedeem").onclick = async () => {
      try {
        redBtn.disabled = true;
        if (!provider) await ensureProvider();
        const mtyldAmt = p18(redAmt.value);
        const slipBps = Math.round((+redSlip.value || 0.5) * 100);
        const [usdcOut] = await vault.previewRedeem(mtyldAmt);
        const minUsdc  = usdcOut - (usdcOut * BigInt(slipBps) / 10000n);
        const tx = await vault.redeem(mtyldAmt, minUsdc); await tx.wait();
        redPrev.textContent = "Redeemed ✅"; await refresh();
      } catch (e) { console.error(e); redPrev.textContent = shortErr(e); }
      finally { redBtn.disabled = false; }
    };
    btnMintMax.onclick = async () => { try{ if (!provider) await ensureProvider(); const bal = await usdc.balanceOf(acct); mintAmt.value = ethers.formatUnits(bal, 6); }catch(e){} };
    btnRedeemMax.onclick = async () => { try{ if (!provider) await ensureProvider(); const bal = await vault.balanceOf(acct); redAmt.value = ethers.formatUnits(bal, 18); }catch(e){} };

    // ===== ADMIN ACTIONS =====
    document.getElementById("btnQueueRev").onclick = async () => {
      try {
        revMsg.textContent = ""; if (!provider) await ensureProvider();
        const amt = p6(revAmount.value); if (amt <= 0n) { revMsg.textContent = "Enter amount"; return; }
        const allowance = await usdc.allowance(acct, VAULT);
        if (allowance < amt) { const txa = await usdc.approve(VAULT, amt); await txa.wait(); }
        const tx = await vault.injectRevenue(amt); await tx.wait();
        revMsg.textContent = "Queued ✅"; await refresh();
      } catch (e) { console.error(e); revMsg.textContent = shortErr(e); }
    };
    btnApply.onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.applyPendingRevenue(); await tx.wait(); pendingHint.textContent="Applied ✅"; await refresh(); } catch (e) { pendingHint.textContent = shortErr(e); } };
    btnBeginClose.onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.beginEpochClose(); await tx.wait(); await refresh(); } catch (e) { alert(shortErr(e)); } };
    btnEndClose.onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.endEpochClose(); await tx.wait(); await refresh(); } catch (e) { alert(shortErr(e)); } };
    
    document.getElementById("btnSetDelay").onclick = async () => {
      try { if (!provider) await ensureProvider(); const s = Number(navDelay.value); if(!(s>0)){alert("Invalid");return;} const tx = await vault.setNavDelay(s); await tx.wait(); await refresh(); } catch (e) { alert(shortErr(e)); }
    };
    btnSetFees.onclick = async () => {
      try { if (!provider) await ensureProvider(); const m = Number(mintFee.value), r = Number(redeemFee.value); const recip = await vault.feeRecipient(); const ru = await vault.feeRoundUp();
      const tx = await vault.setFees(m, r, recip, ru); await tx.wait(); await refresh(); } catch (e) { alert(shortErr(e)); }
    };
    btnGuardOn.onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.setGuardedLaunch(true); await tx.wait(); await refresh(); } catch (e) { alert(shortErr(e)); } };
    btnGuardOff.onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.setGuardedLaunch(false); await tx.wait(); await refresh(); } catch (e) { alert(shortErr(e)); } };
    document.getElementById("btnWhitelistOn").onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.setWhitelist(wlAddr.value, true); await tx.wait(); wlMsg.textContent="Added"; } catch(e){ wlMsg.textContent=shortErr(e); }};
    document.getElementById("btnWhitelistOff").onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.setWhitelist(wlAddr.value, false); await tx.wait(); wlMsg.textContent="Removed"; } catch(e){ wlMsg.textContent=shortErr(e); }};

    // New Admin Actions
    btnSetCap.onclick = async () => { try { if (!provider) await ensureProvider(); const c = p18(maxSupplyIn.value); const tx = await vault.setMaxSupply(c); await tx.wait(); await refresh(); } catch(e){ alert(shortErr(e)); }};
    btnPause.onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.pause(); await tx.wait(); await refresh(); } catch(e){ alert(shortErr(e)); }};
    btnUnpause.onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.unpause(); await tx.wait(); await refresh(); } catch(e){ alert(shortErr(e)); }};
    
    btnAnnounceRescue.onclick = async () => {
        try {
            if (!provider) await ensureProvider();
            const t = resToken.value.trim(), a = resAmt.value.trim(), recipient = resTo.value.trim();
            if(!ethers.isAddress(t) || !ethers.isAddress(recipient)) return alert("Invalid addresses");
            const tx = await vault.announceRescue(t, BigInt(a), recipient);
            await tx.wait(); await refresh();
        } catch(e) { alert(shortErr(e)); }
    };
    btnExecuteRescue.onclick = async () => { try { if (!provider) await ensureProvider(); const tx = await vault.executeRescue(); await tx.wait(); await refresh(); } catch(e) { alert(shortErr(e)); } };

    // Batch Sender
    batchInput.addEventListener("input", () => {
        const text = batchInput.value, lines = text.split(/\r?\n/);
        let count = 0, total = 0n;
        for (let l of lines) {
            const parts = l.split(",");
            if (parts.length >= 2 && ethers.isAddress(parts[0].trim()) && !isNaN(parts[1].trim())) {
                count++; try { total += ethers.parseUnits(parts[1].trim(), 18); } catch {}
            }
        }
        batchStats.textContent = `Wait: ${count} | Total: ${ethers.formatUnits(total, 18)}`;
    });
    btnSendBatch.onclick = async () => {
        try {
            if (!provider) await ensureProvider();
            const lines = batchInput.value.split(/\r?\n/), recipients = [];
            for (let l of lines) {
                const parts = l.split(",");
                if (parts.length >= 2 && ethers.isAddress(parts[0].trim())) {
                    try { recipients.push({ to: parts[0].trim(), amount: ethers.parseUnits(parts[1].trim(), 18) }); } catch {}
                }
            }
            if (!recipients.length) return alert("No valid lines");
            if (!confirm(`Send to ${recipients.length} wallets?`)) return;
            btnSendBatch.disabled = true; batchLog.classList.remove("hidden");
            batchLog.textContent = "Starting...\n";
            for (let i = 0; i < recipients.length; i++) {
                try {
                    batchLog.textContent += `Sending to ${recipients[i].to.slice(0,6)}... `;
                    const tx = await vault.transfer(recipients[i].to, recipients[i].amount);
                    await tx.wait(); batchLog.textContent += `OK\n`;
                } catch (e) { batchLog.textContent += `FAIL\n`; }
            }
            await refresh();
        } catch (e) { alert(shortErr(e)); } finally { btnSendBatch.disabled = false; }
    };

    // Misc
    document.getElementById("btnExportCSV").onclick = () => {
      const rows = [["timestamp","iso","nav_usd"]];
      for (const p of navHistory) rows.push([p.t, new Date(p.t*1000).toISOString(), p.p.toFixed(8)]);
      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const url  = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "mtyld_nav_history.csv"; a.click();
      URL.revokeObjectURL(url);
    };
    document.getElementById("btnResetHistory").onclick = () => { if(confirm("Reset history?")) { navHistory=[]; saveHistory(); drawNavChart(); }};
    document.getElementById("btnConnect").onclick = async () => { try { await ensureProvider(); await refresh(); await loadOwnerState(); } catch(e){} };
    document.getElementById("btnRefresh").onclick = async () => { await refresh(); if (vaultOwner && signer) await loadOwnerState(); };

    loadHistory(); drawNavChart();
    setInterval(() => { refresh().catch(()=>{}); }, 10000);
    refresh().catch(()=>{});
  })();
  </script>
</body>
</html>
