<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTYLD Mini dApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <style>
    :root{--bg:#0b0e14;--card:#141a24;--text:#e6edf3;--muted:#94a3b8;--acc:#f59e0b;--br:#223043}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Inter,Arial}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 12px} .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--br);border-radius:12px;padding:14px;flex:1 1 300px;min-width:280px}
    .muted{color:var(--muted)} .btn{cursor:pointer;padding:10px 14px;border-radius:10px;border:1px solid var(--br);background:#111826;color:var(--text)}
    .btn:disabled{opacity:.6;cursor:not-allowed} .btn-primary{background:var(--acc);color:#111;border-color:#000}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--br);background:#0f1622;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    a{color:var(--acc);text-decoration:none}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--br);border-radius:999px;margin-left:8px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MTYLD Vault <span class="pill mono">Arbitrum</span></h1>
    <div class="row">
      <div class="card" style="flex:0 0 260px">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <button id="btnConnect" class="btn">Connect Wallet</button>
          <button id="btnRefresh" class="btn">↻</button>
        </div>
        <div class="muted" id="addr">Not connected</div>
        <div class="muted mono" style="margin-top:6px">
          Vault: 0xed33364f71275E8EA06a85a363Ec5C5a6c9AB880
        </div>
      </div>

      <div class="card">
        <div class="grid">
          <div>
            <div class="muted">Price (NAV)</div>
            <div class="mono" id="price">$–</div>
          </div>
          <div>
            <div class="muted">Active Treasury</div>
            <div class="mono" id="treasuryActive">$–</div>
          </div>
          <div>
            <div class="muted">Pending Revenue</div>
            <div class="mono" id="pending">$–</div>
          </div>
          <div>
            <div class="muted">Pending Release In</div>
            <div class="mono" id="countdown">–</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="muted">USDC → MTYLD (Mint)</div>
        <div style="margin-top:6px"><input id="mintAmount" placeholder="Amount (USDC)" inputmode="decimal" /></div>
        <div class="grid" style="margin-top:8px">
          <div><input id="mintSlippage" placeholder="Slippage % (e.g. 0.5)" value="0.5" /></div>
          <div><button id="btnPreviewMint" class="btn">Preview</button></div>
        </div>
        <div class="mono" id="mintPreview" style="margin-top:6px;min-height:20px"></div>
        <div style="margin-top:8px"><button id="btnMint" class="btn btn-primary" disabled>Mint</button></div>
      </div>

      <div class="card">
        <div class="muted">MTYLD → USDC (Redeem)</div>
        <div style="margin-top:6px"><input id="redeemAmount" placeholder="Amount (MTYLD)" inputmode="decimal" /></div>
        <div class="grid" style="margin-top:8px">
          <div><input id="redeemSlippage" placeholder="Slippage % (e.g. 0.5)" value="0.5" /></div>
          <div><button id="btnPreviewRedeem" class="btn">Preview</button></div>
        </div>
        <div class="mono" id="redeemPreview" style="margin-top:6px;min-height:20px"></div>
        <div style="margin-top:8px"><button id="btnRedeem" class="btn btn-primary" disabled>Redeem</button></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">Tips</div>
      <ul>
        <li>Be on <b>Arbitrum One</b>. If transactions fail, check network.</li>
        <li>Mint requires USDC allowance → we auto-approve exact amount.</li>
        <li>If you see <span class="mono">Guarded</span> / <span class="mono">EpochClosing</span>, it’s an owner setting.</li>
      </ul>
      <div class="muted">
        USDC: <span class="mono">0xaf88d065e77c8cC2239327C5EDb3A432268e5831</span>
      </div>
    </div>

  </div>

<script>
(async () => {
  // ===== Config =====
  const VAULT = "0xed33364f71275E8EA06a85a363Ec5C5a6c9AB880";
  const USDC  = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831"; // Arbitrum USDC
  const CHAIN_ID_ARBITRUM = 42161;

  // Minimal ABIs (only the funcs we use)
  const VAULT_ABI = [
    "function pricePerToken() view returns (uint256)",
    "function treasuryUSDC() view returns (uint256)",
    "function treasuryActiveUSDC() view returns (uint256)",
    "function pendingRevenueUSDC() view returns (uint256)",
    "function pendingReleaseAt() view returns (uint64)",
    "function previewMint(uint256 usdcAmount) view returns (uint256 mtyldOut, uint256 price)",
    "function previewRedeem(uint256 mtyldAmount) view returns (uint256 usdcOut, uint256 price)",
    "function mint(uint256 usdcAmount, uint256 minMtyldOut)",
    "function redeem(uint256 mtyldAmount, uint256 minUsdcOut)",
    "function name() view returns (string)",
    "function symbol() view returns (string)"
  ];
  const ERC20_ABI = [
    "function decimals() view returns (uint8)",
    "function balanceOf(address) view returns (uint256)",
    "function allowance(address,address) view returns (uint256)",
    "function approve(address,uint256) returns (bool)"
  ];

  // ===== DOM =====
  const el = (id) => document.getElementById(id);
  const addrEl = el("addr"), priceEl = el("price"), actEl = el("treasuryActive"), pendEl = el("pending"), cdEl = el("countdown");
  const connectBtn = el("btnConnect"), refreshBtn = el("btnRefresh");
  const mintAmt = el("mintAmount"), mintSlip = el("mintSlippage"), prevMintBtn = el("btnPreviewMint"), mintPrev = el("mintPreview"), mintBtn = el("btnMint");
  const redAmt = el("redeemAmount"), redSlip = el("redeemSlippage"), prevRedBtn = el("btnPreviewRedeem"), redPrev = el("redeemPreview"), redBtn = el("btnRedeem");

  // ===== Ethers setup =====
  let provider, signer, acct, vault, usdc;
  let usdcDecimals = 6n; // known; still fetchable

  function fmtUsd(x) { return `$${Number(x).toLocaleString(undefined,{maximumFractionDigits:2})}`; }
  function fmt6(bi)  { return Number(bi) / 1e6; }
  function fmt18(bi) { return Number(bi) / 1e18; }
  function to6(str)  { const v = Number(str || "0"); return BigInt(Math.round(v * 1e6)); }
  function to18(str) { const v = Number(str || "0"); return BigInt(Math.round(v * 1e18)); }

  async function ensureProvider() {
    if (!window.ethereum) { alert("No wallet found. Install MetaMask."); throw new Error("no wallet"); }
    provider = new ethers.BrowserProvider(window.ethereum);
    const net = await provider.getNetwork();
    if (Number(net.chainId) !== CHAIN_ID_ARBITRUM) {
      // Try to switch
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0xa4b1' }] });
      } catch (e) {
        alert("Please switch to Arbitrum One.");
        throw e;
      }
    }
    signer = await provider.getSigner();
    acct = await signer.getAddress();
    vault = new ethers.Contract(VAULT, VAULT_ABI, signer);
    usdc  = new ethers.Contract(USDC, ERC20_ABI, signer);
    // Optionally fetch decimals:
    try { const d = await usdc.decimals(); usdcDecimals = BigInt(d); } catch {}
    addrEl.textContent = acct.slice(0,6)+"…"+acct.slice(-4);
  }

  async function refresh() {
    try {
      if (!provider) await ensureProvider();
      const [price, active, pending, relAt] = await Promise.all([
        vault.pricePerToken(),
        vault.treasuryActiveUSDC(),
        vault.pendingRevenueUSDC(),
        vault.pendingReleaseAt()
      ]);
      priceEl.textContent = `$${fmt18(price).toFixed(6)}`;
      actEl.textContent = fmtUsd(fmt6(active));
      pendEl.textContent = fmtUsd(fmt6(pending));
      // countdown
      const now = Math.floor(Date.now()/1000);
      const secs = Number(relAt) > now ? (Number(relAt)-now) : 0;
      cdEl.textContent = secs ? humanize(secs) : (Number(pending)>0 ? "Queued (awaiting apply)" : "—");
    } catch (e) {
      console.error(e);
      alert("Refresh failed (check network/contract).");
    }
  }

  function humanize(s) {
    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
    const parts = [];
    if (h) parts.push(`${h}h`);
    if (m) parts.push(`${m}m`);
    parts.push(`${sec}s`);
    return parts.join(" ");
  }

  // ===== Preview & Actions =====
  prevMintBtn.onclick = async () => {
    try {
      if (!provider) await ensureProvider();
      const usdcAmt = to6(mintAmt.value);
      if (usdcAmt <= 0n) { mintPrev.textContent = "Enter amount"; return; }
      const [mtyldOut, price] = await vault.previewMint(usdcAmt);
      mintPrev.textContent = `Est. MTYLD: ${(fmt18(mtyldOut)).toFixed(6)} @ $${fmt18(price).toFixed(6)}`;
      mintBtn.disabled = false;
    } catch (e) { console.error(e); mintPrev.textContent = shortErr(e); }
  };

  mintBtn.onclick = async () => {
    try {
      mintBtn.disabled = true;
      if (!provider) await ensureProvider();
      const usdcAmt = to6(mintAmt.value);
      const slipPct = Number(mintSlip.value || "0.5");
      const [mtyldOut] = await vault.previewMint(usdcAmt);
      const minOut = BigInt(Math.floor(Number(mtyldOut) * (1 - slipPct/100)));

      // approve exact amount if needed
      const allowance = await usdc.allowance(acct, VAULT);
      if (allowance < usdcAmt) {
        const txa = await usdc.approve(VAULT, usdcAmt);
        await txa.wait();
      }
      const tx = await vault.mint(usdcAmt, minOut);
      await tx.wait();
      mintPrev.textContent = "Minted ✅";
      await refresh();
    } catch (e) { console.error(e); mintPrev.textContent = shortErr(e); }
    finally { mintBtn.disabled = false; }
  };

  prevRedBtn.onclick = async () => {
    try {
      if (!provider) await ensureProvider();
      const mtyldAmt = to18(redAmt.value);
      if (mtyldAmt <= 0n) { redPrev.textContent = "Enter amount"; return; }
      const [usdcOut, price] = await vault.previewRedeem(mtyldAmt);
      redPrev.textContent = `Est. USDC: ${(fmt6(usdcOut)).toFixed(6)} @ $${fmt18(price).toFixed(6)}`;
      redBtn.disabled = false;
    } catch (e) { console.error(e); redPrev.textContent = shortErr(e); }
  };

  redBtn.onclick = async () => {
    try {
      redBtn.disabled = true;
      if (!provider) await ensureProvider();
      const mtyldAmt = to18(redAmt.value);
      const slipPct = Number(redSlip.value || "0.5");
      const [usdcOut] = await vault.previewRedeem(mtyldAmt);
      const minOut = BigInt(Math.floor(Number(usdcOut) * (1 - slipPct/100)));
      const tx = await vault.redeem(mtyldAmt, minOut);
      await tx.wait();
      redPrev.textContent = "Redeemed ✅";
      await refresh();
    } catch (e) { console.error(e); redPrev.textContent = shortErr(e); }
    finally { redBtn.disabled = false; }
  };

  function shortErr(e){
    const s = (e && (e.info?.error?.message || e.shortMessage || e.message)) || String(e);
    return "Error: " + s.replace(/execution reverted: /i,'').slice(0,180);
  }

  connectBtn.onclick = async () => {
    try {
      await ensureProvider();
      await refresh();
    } catch (e) { console.error(e); }
  };
  refreshBtn.onclick = refresh;

  // Auto-refresh loop (10s)
  setInterval(() => { refresh().catch(()=>{}); }, 10000);

  // Try lazy init (read-only if wallet not connected)
  if (window.ethereum) {
    try {
      provider = new ethers.BrowserProvider(window.ethereum);
      const r = new ethers.Contract(VAULT, VAULT_ABI, provider);
      const [price, active, pending, relAt] = await Promise.all([
        r.pricePerToken(),
        r.treasuryActiveUSDC(),
        r.pendingRevenueUSDC(),
        r.pendingReleaseAt()
      ]);
      priceEl.textContent = `$${fmt18(price).toFixed(6)}`;
      actEl.textContent = fmtUsd(fmt6(active));
      pendEl.textContent = fmtUsd(fmt6(pending));
      const now = Math.floor(Date.now()/1000);
      const secs = Number(relAt) > now ? (Number(relAt)-now) : 0;
      cdEl.textContent = secs ? humanize(secs) : (Number(pending)>0 ? "Queued (awaiting apply)" : "—");
    } catch {}
  }
})();
</script>
</body>
</html>
