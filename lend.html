<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>MTYLD â€¢ Credit Line â€” Mechanical Temp</title>
Â  <link rel="icon" href="data:,">
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
Â  <style>
Â  Â  html { scroll-behavior: smooth; }
Â  Â  .tile { padding:.5rem; border-radius:.5rem; background:rgba(30,41,59,.4); border:1px solid rgba(51,65,85,.5); }
Â  Â  input[type="text"], input[type="number"] { outline:none }
Â  </style>
</head>

<body class="bg-slate-950 text-slate-100">
Â  Â  <header class="sticky top-0 z-30 bg-slate-900/80 backdrop-blur border-b border-slate-800">
Â  Â  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
Â  Â  Â  <a href="https://www.mechanicaltemp.com" class="flex items-center gap-3">
Â  Â  Â  Â  <img src="https://i.imgur.com/YJvJw7V.png" alt="Mechanical Temp" class="h-10 w-auto">
Â  Â  Â  Â  <span class="font-bold tracking-wide text-slate-200 hidden sm:inline"></span>
Â  Â  Â  </a>
Â  Â  Â  <nav class="flex items-center gap-2">
Â  Â  Â  Â  <a href="https://vault.mechanicaltemp.com" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">Home</a>
Â  Â  Â  Â  <a href="vault.html" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">Vault</a>
Â  Â  Â  Â  <button id="btnAbout" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">About</button>
Â  Â  Â  Â  <button id="btnConnect" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Connect</button>
Â  Â  Â  Â  <button id="btnRefresh" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">â†»</button>
Â  Â  Â  </nav>
Â  Â  </div>
Â  </header>

Â  Â  <section class="bg-gradient-to-b from-slate-900 to-sky-900 border-b border-slate-800">
Â  Â  <div class="max-w-7xl mx-auto px-4 py-12 sm:py-16 text-center">
Â  Â  Â  <h1 class="mt-1 text-4xl sm:text-5xl md:text-6xl font-black tracking-tight text-white">MTYLD Credit Line</h1>
Â  Â  Â  <p class="mt-3 md:mt-4 text-base md:text-lg text-sky-200">Borrow USDC against <span class="font-semibold text-sky-100">MTYLD</span> collateral</p>
Â  Â  </div>
Â  </section>

Â  Â  <main class="max-w-7xl mx-auto px-4 py-8 space-y-4">
Â  Â  Â  Â  <div class="grid md:grid-cols-3 gap-4 items-start">
Â  Â  Â  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 h-full">
Â  Â  Â  Â  <div class="text-slate-400 font-mono text-sm truncate" id="addr">Not connected</div>
Â  Â  Â  Â  <div class="mt-2 text-xs text-slate-500">Credit Contract</div>
Â  Â  Â  Â  <div class="font-mono text-slate-300 truncate text-sm" id="lendingAddr">â€”</div>

Â  Â  Â  Â  <div class="mt-2 text-xs text-slate-500">USDC / MTYLD / MTYLD Vault</div>
Â  Â  Â  Â  <div class="font-mono text-slate-300 text-xs break-all" id="tokenTriplet">â€”</div>

Â  Â  Â  Â  <div class="mt-2 text-xs text-slate-500">Treasury (funds borrows / receives repays)</div>
Â  Â  Â  Â  <div class="font-mono text-slate-300 text-xs break-all" id="treasuryAddr">â€”</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="md:col-span-2 bg-slate-900 border border-slate-800 rounded-2xl p-4">
Â  Â  Â  Â  <div class="grid grid-cols-2 sm:grid-cols-6 gap-3">
Â  Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">MTYLD Price (USD)</div><div id="mtyldPrice" class="font-mono text-lg">$â€“</div></div>
Â  Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Your MTYLD</div><div id="balMtyld" class="font-mono text-lg">â€“</div></div>
Â  Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Your USDC</div><div id="balUsdc" class="font-mono text-lg">â€“</div></div>
Â  Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Health (LTV)</div><div id="ltvLine" class="font-mono text-lg">â€“</div></div>
Â  Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Treasury USDC</div><div id="treasuryBal" class="font-mono text-lg">â€“</div></div>
Â  Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Available to Borrow</div><div id="availBorrow" class="font-mono text-lg">$â€“</div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="warnBar" class="mt-2 text-xs text-amber-300"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
Â  Â  Â  <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Collateral (MTYLD)</div><div class="font-mono text-lg" id="userColMtyld">â€“</div><div class="text-slate-400 text-xs" id="userColUsd">USD â€“</div></div>
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Debt (USDC)</div><div class="font-mono text-lg" id="userDebtUsdc">â€“</div><div class="text-slate-400 text-xs" id="userDebtUsd">USD â€“</div></div>
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Interest + Late</div><div class="font-mono text-lg" id="userInterestLate">â€“</div></div>
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Credit Score</div><div class="font-mono text-lg" id="userScore">â€“</div></div>
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Maturity</div><div class="font-mono text-lg" id="userMaturity">â€“</div></div>
Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
Â  Â  Â  <div class="text-slate-300 font-semibold mb-2">Protocol & User Stats</div>
Â  Â  Â  <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Borrow Limit (USDC)</div><div id="borrowLimit" class="font-mono text-lg">$â€“</div></div>
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Liq Threshold (LTV)</div><div id="liqThreshold" class="font-mono text-lg">â€“</div></div>
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Debt @ Liq Threshold (USD)</div><div id="debtAtLiq" class="font-mono text-lg">$â€“</div></div>
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">Days to Maturity</div><div id="daysToMat" class="font-mono text-lg">â€”</div></div>
Â  Â  Â  Â  <div class="tile"><div class="text-slate-400 text-xs">APR</div><div id="aprLine" class="font-mono text-lg">â€”</div></div>
Â  Â  Â  </div>
Â  Â  Â  <div class="text-xs text-slate-500 mt-2">â€œAvailable to Borrowâ€ = min(Borrow Limit âˆ’ Current Debt, Treasury USDC, Treasury Allowance). Assumes 1 USDC â‰ˆ $1.</div>
Â  Â  </div>

Â  Â  Â  Â  <div id="adminPanel" class="hidden bg-slate-900 border border-slate-800 rounded-2xl p-4">
Â  Â  Â  <div class="flex items-center justify-between gap-3 mb-2">
Â  Â  Â  Â  <div class="font-semibold">Admin Panel <span class="ml-2 text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-300">Owner</span></div>
Â  Â  Â  Â  <div class="text-xs text-slate-400">Contract: <span id="ownerOf" class="font-mono">â€”</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  <div class="h-px bg-slate-800 my-3"></div>

Â  Â  Â  Â  Â  Â  <div class="grid md:grid-cols-2 gap-4">
Â  Â  Â  Â  <div class="tile">
Â  Â  Â  Â  Â  <div class="text-slate-300 font-semibold mb-2">Current Roles</div>
Â  Â  Â  Â  Â  <div class="space-y-1 font-mono text-sm">
Â  Â  Â  Â  Â  Â  <div>Owner: <span id="ownerAddr">â€”</span></div>
Â  Â  Â  Â  Â  Â  <div>Treasury: <span id="roleTreasury">â€”</span></div>
Â  Â  Â  Â  Â  Â  <div>Rate Guardian: <span id="rateGuardian">â€”</span></div>
Â  Â  Â  Â  Â  Â  <div>Risk Guardian: <span id="riskGuardian">â€”</span></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="tile">
Â  Â  Â  Â  Â  <div class="text-slate-300 font-semibold mb-2">Set Roles</div>
Â  Â  Â  Â  Â  <input id="inTreasury" placeholder="Treasury 0xâ€¦" class="w-full mb-2 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  <input id="inRateG" placeholder="Rate Guardian 0xâ€¦" class="w-full mb-2 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  <input id="inRiskG" placeholder="Risk Guardian 0xâ€¦" class="w-full mb-2 px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  <button id="btnSetRoles" class="w-full px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Set Roles</button>
Â  Â  Â  Â  Â  <div id="rolesMsg" class="text-xs text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="h-px bg-slate-800 my-3"></div>

Â  Â  Â  Â  Â  Â  <div class="grid md:grid-cols-2 gap-4">
Â  Â  Â  Â  <div class="tile">
Â  Â  Â  Â  Â  <div class="text-slate-300 font-semibold mb-2">Rates & LTV</div>
Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-2">
Â  Â  Â  Â  Â  Â  <input id="inApr" type="number" placeholder="APR (bps)" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  Â  <input id="inMaxLtv" type="number" placeholder="Max LTV (bps)" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  Â  <input id="inLiqThresh" type="number" placeholder="Liq Thresh (bps)" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  Â  <input id="inLiqBonus" type="number" placeholder="Liq Bonus (bps)" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button id="btnSetParams" class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Set Params</button>
Â  Â  Â  Â  Â  <div id="paramsMsg" class="text-xs text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="tile">
Â  Â  Â  Â  Â  <div class="text-slate-300 font-semibold mb-2">Severe Liquidation</div>
Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-2">
Â  Â  Â  Â  Â  Â  <input id="inSevThresh" type="number" placeholder="Sev Thresh (bps)" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  Â  <input id="inSevBonus" type="number" placeholder="Sev Bonus (bps)" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <label class="inline-flex items-center gap-2 text-sm mt-2">
Â  Â  Â  Â  Â  Â  <input type="checkbox" id="inSevPublic" class="h-4 w-4 rounded border-slate-600 bg-slate-800">
Â  Â  Â  Â  Â  Â  Public Severe Liquidations
Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  <button id="btnSetSevere" class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Set Severe Params</button>
Â  Â  Â  Â  Â  <div id="severeMsg" class="text-xs text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="h-px bg-slate-800 my-3"></div>

Â  Â  Â  Â  Â  Â  <div class="grid md:grid-cols-2 gap-4">
Â  Â  Â  Â  <div class="tile">
Â  Â  Â  Â  Â  <div class="text-slate-300 font-semibold mb-2">Operational</div>
Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-2">
Â  Â  Â  Â  Â  Â  <button id="btnPause" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Pause</button>
Â  Â  Â  Â  Â  Â  <button id="btnUnpause" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Unpause</button>
Â  Â  Â  Â  Â  Â  <button id="btnPauseLiq" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Pause Liq</button>
Â  Â  Â  Â  Â  Â  <button id="btnUnpauseLiq" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Unpause Liq</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="opsMsg" class="text-xs text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="tile">
Â  Â  Â  Â  Â  <div class="text-slate-300 font-semibold mb-2">Whitelist & Credit</div>
Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-2">
Â  Â  Â  Â  Â  Â  <input id="inWL" placeholder="User 0xâ€¦" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  Â  <input id="inScore" type="number" placeholder="Credit Score" class="px-3 py-2 rounded-lg bg-slate-800 border border-slate-700">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-2 mt-2">
Â  Â  Â  Â  Â  Â  <button id="btnWLOn" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Allow</button>
Â  Â  Â  Â  Â  Â  <button id="btnWLOff" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Remove</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button id="btnSetCredit" class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Set Credit Score</button>
Â  Â  Â  Â  Â  <div id="wlMsg" class="text-xs text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div class="grid md:grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
Â  Â  Â  Â  <div class="text-slate-300 font-semibold">Collateral: MTYLD</div>
Â  Â  Â  Â  <div class="mt-3 grid grid-cols-2 gap-3">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="text-slate-400 text-xs mb-1">Deposit MTYLD</div>
Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  <input id="depAmt" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
Â  Â  Â  Â  Â  Â  Â  <button id="depMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="btnDeposit" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Approve & Deposit</button>
Â  Â  Â  Â  Â  Â  <div id="depMsg" class="text-sm text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="text-slate-400 text-xs mb-1">Withdraw MTYLD</div>
Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  <input id="wdAmt" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
Â  Â  Â  Â  Â  Â  Â  <button id="wdMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="btnWithdraw" class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Withdraw</button>
Â  Â  Â  Â  Â  Â  <div id="wdMsg" class="text-sm text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
Â  Â  Â  Â  <div class="text-slate-300 font-semibold">Borrow / Repay (USDC)</div>
Â  Â  Â  Â  <div class="mt-3 grid grid-cols-2 gap-3">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="text-slate-400 text-xs mb-1">Borrow USDC</div>
Â  Â  Â  Â  Â  Â  <input id="brAmt" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
Â  Â  Â  Â  Â  Â  <div class="flex gap-2 mt-2">
Â  Â  Â  Â  Â  Â  Â  <input id="brDays" inputmode="numeric" placeholder="Maturity (days)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
Â  Â  Â  Â  Â  Â  Â  <button id="btnBorrow" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Borrow</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="brMsg" class="text-sm text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="text-slate-400 text-xs mb-1">Repay USDC</div>
Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  <input id="rpAmt" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
Â  Â  Â  Â  Â  Â  Â  <button id="rpMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="btnRepay" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Approve & Repay</button>
Â  Â  Â  Â  Â  Â  <div id="rpMsg" class="text-sm text-slate-400 mt-1">â€”</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <p class="text-xs text-slate-500">Arbitrum One â€¢ MTYLD Credit Line UI</p>
Â  </main>

Â  Â  <section id="aboutCL" class="bg-slate-950 border-t border-slate-800 py-12 px-4">
Â  Â  <div class="max-w-7xl mx-auto">
Â  Â  Â  <div class="text-center mb-8">
Â  Â  Â  Â  <h2 class="text-3xl sm:text-4xl font-black text-white">About the MTYLD Credit Line</h2>
Â  Â  Â  Â  <p class="mt-2 text-sky-300 text-lg">Borrow USDC against MTYLD at transparent, on-chain terms</p>
Â  Â  Â  </div>

Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
Â  Â  Â  Â  Â  <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
Â  Â  Â  Â  Â  Â  <span class="text-sky-300 font-semibold">ğŸ¦ How it works</span>
Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
Â  Â  Â  Â  Â  </summary>
Â  Â  Â  Â  Â  <div class="px-5 pb-5 text-slate-300">
Â  Â  Â  Â  Â  Â  <ol class="list-decimal pl-5 space-y-2">
Â  Â  Â  Â  Â  Â  Â  <li>Deposit MTYLD as collateral.</li>
Â  Â  Â  Â  Â  Â  Â  <li>Borrow USDC up to your LTV limit (based on MTYLD price).</li>
Â  Â  Â  Â  Â  Â  Â  <li>Interest accrues; repay principal + interest (and any late fees) in USDC.</li>
Â  Â  Â  Â  Â  Â  Â  <li>If LTV exceeds liquidation threshold, positions can be liquidated.</li>
Â  Â  Â  Â  Â  Â  </ol>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </details>

Â  Â  Â  Â  <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
Â  Â  Â  Â  Â  <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
Â  Â  Â  Â  Â  Â  <span class="text-sky-300 font-semibold">ğŸ’§ Treasury funding</span>
Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
Â  Â  Â  Â  Â  </summary>
Â  Â  Â  Â  Â  <div class="px-5 pb-5 text-slate-300">
Â  Â  Â  Â  Â  Â  <p>The Treasury wallet supplies USDC to borrowers and receives all repayments. Admin must fund it with USDC and approve the Lending contract to spend USDC.</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </details>

Â  Â  Â  Â  <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
Â  Â  Â  Â  Â  <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
Â  Â  Â  Â  Â  Â  <span class="text-sky-300 font-semibold">âš™ï¸ Admin checklist</span>
Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
Â  Â  Â  Â  Â  </summary>
Â  Â  Â  Â  Â  <div class="px-5 pb-5 text-slate-300">
Â  Â  Â  Â  Â  Â  <ul class="list-disc pl-5 space-y-2">
Â  Â  Â  Â  Â  Â  Â  <li>Fund Treasury with USDC (Arbitrum: <span class="font-mono">0xaf88â€¦e5831</span>).</li>
Â  Â  Â  Â  Â  Â  Â  <li>From Treasury wallet: <span class="font-mono">USDC.approve(lending, MAX_UINT)</span>.</li>
Â  Â  Â  Â  Â  Â  Â  <li>Whitelist borrowers if gating is enabled.</li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </details>

Â  Â  Â  Â  <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
Â  Â  Â  Â  Â  <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
Â  Â  Â  Â  Â  Â  <span class="text-sky-300 font-semibold">âš ï¸ Risks & Disclosures</span>
Â  Â  Â  Â  Â  Â  <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/></svg>
Â  Â  Â  Â  Â  </summary>
Â  Â  Â  Â  Â  <div class="px-5 pb-5 text-slate-300">
Â  Â  Â  Â  Â  Â  <ul class="list-disc pl-5 space-y-2">
Â  Â  Â  Â  Â  Â  Â  <li>Price risk on MTYLD collateral</li>
Â  Â  Â  Â  Â  Â  Â  <li>Smart contract & operator risk</li>
Â  Â  Â  Â  Â  Â  Â  <li>Liquidation if LTV exceeds threshold</li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </details>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  Â  <footer class="mt-10 border-t border-slate-800 bg-slate-900">
Â  Â  <div class="max-w-7xl mx-auto px-4 py-8 text-center">
Â  Â  Â  <p class="text-slate-300">Powered by <a href="https://www.mechanicaltemp.com" class="text-sky-400 hover:text-sky-300 font-semibold">Mechanical Temp</a> <span class="text-slate-500">â€¢</span> Southfield, MI</p>
Â  Â  Â  <p class="mt-2 text-xs text-slate-500">Â© <span id="yr"></span> Mechanical Temp â€¢ All Rights Reserved</p>
Â  Â  </div>
Â  </footer>

<script>
const CHAIN_ID_ARBITRUM = 42161;
const LENDING_ADDR = "0xdDce144833975CfF4B729FD3c4D0A717Ac24BAaa";

// ABIs
const LENDING_VAULT_GATED_V3_ABI = [
Â  // --- Constructor ---
Â  "constructor(address usdc, address mtyld, address mtyldVault, address _treasury)",

Â  // --- View Functions (Read-Only) ---
Â  "function APR_MAX_BPS() view returns (uint16)",
Â  "function BPS_DENOMINATOR() view returns (uint256)",
Â  "function MAX_BPS_U16() view returns (uint16)",
Â  "function MTYLD() view returns (address)",
Â  "function MTYLD_VAULT() view returns (address)",
Â  "function SECONDS_PER_YEAR() view returns (uint256)",
Â  "function USDC() view returns (address)",
Â  "function USDC_6() view returns (uint256)",
Â  "function USD_18() view returns (uint256)",
Â  "function aprBps() view returns (uint16)",
Â  "function canBeLiquidated(address user) view returns (bool)",
Â  "function canBeSeverelyLiquidated(address user) view returns (bool)",
Â  "function collateralMTYLD_18(address) view returns (uint256)",
Â  "function collateralUsd_18(address user) view returns (uint256)",
Â  "function creditScore(address) view returns (uint32 score, uint32 lastUpdated)",
Â  "function debtUsd_18(address user) view returns (uint256)",
Â  "function isWhitelisted(address) view returns (bool)",
Â  "function lateFeeBpsFlat() view returns (uint16)",
Â  "function liqBonusBps() view returns (uint16)",
Â  "function liqThresholdBps() view returns (uint16)",
Â  "function liquidationAmountUSDC_6(address user) view returns (uint256)",
Â  "function liquidationPaused() view returns (bool)",
Â  "function loans(address) view returns (uint256 principalUSDC_6, uint256 interestUSDC_6, uint256 lateFeesUSDC_6, uint64 start, uint64 maturity, bool lateFeeApplied, bool active)",
Â  "function ltvBps(address user) view returns (uint16)",
Â  "function maxLtvBps() view returns (uint16)",
Â  "function mtyldUsdPrice_18() view returns (uint256)",
Â  "function owner() view returns (address)",
Â  "function paused() view returns (bool)",
Â  "function rateGuardian() view returns (address)",
Â  "function riskGuardian() view returns (address)",
Â  "function severeLiqBonusBps() view returns (uint16)",
Â  "function severeLiqThresholdBps() view returns (uint16)",
Â  "function severePublic() view returns (bool)",
Â  "function treasury() view returns (address)",
Â  "function userView(address user) view returns (tuple)", // Returns UserView struct

Â  // --- Write Functions (State-Changing) ---
Â  "function adminSetCredit(address user, uint32 score)",
Â  "function borrow(uint256 usdcAmount_6, uint64 maturity)",
Â  "function depositCollateral(uint256 amountMTYLD_18)",
Â  "function liquidate(address user, uint256 repayUSDC_6, uint256 minSeizeMTYLD_18)",
Â  "function pause()",
Â  "function repay(uint256 usdcAmount_6)",
Â  "function setLateFeeBps(uint16 _lateFeeBpsFlat)",
Â  "function setLiquidationPaused(bool on)",
Â  "function setParams(uint16 _aprBps, uint16 _maxLtvBps, uint16 _liqThresholdBps, uint16 _liqBonusBps)",
Â  "function setRoles(address _treasury, address _rate, address _risk)",
Â  "function setSevereParams(uint16 _sevThreshBps, uint16 _sevBonusBps, bool _public)",
Â  "function setWhitelist(address user, bool allowed)",
Â  "function severeLiquidate(address user, uint256 minSeizeMTYLD_18)",
Â  "function transferOwnership(address n)",
Â  "function unpause()",
Â  "function withdrawCollateral(uint256 amountMTYLD_18)",

Â  // --- Custom Errors ---
Â  "error BadAddress()",
Â  "error BadAmount()",
Â  "error Healthy()",
Â  "error NotActive()",
Â  "error NotOwnerGuardian()",
Â  "error NotSevere()",
Â  "error NotWhitelisted()",
Â  "error OverLTV()",
Â  "error Slippage()",
Â  "error TooEarly()",
Â Â 
Â  // --- Events (For listening to blockchain logs) ---
Â  "event Accrued(address indexed user, uint256 interestAccrued_6, bool lateFeeApplied)",
Â  "event Borrowed(address indexed user, uint256 usdcAmount_6, uint64 start, uint64 maturity)",
Â  "event CollateralDeposited(address indexed user, uint256 mtyldAmount_18)",
Â  "event CollateralWithdrawn(address indexed user, uint256 mtyldAmount_18)",
Â  "event LateFeeUpdated(uint16 lateFeeBpsFlat)",
Â  "event Liquidated(address indexed liquidator, address indexed user, uint256 repayUSDC_6, uint256 seizeMTYLD_18, uint256 price18, uint16 bonusBps, bool severe)",
Â  "event LiquidationPaused(bool on)",
Â  "event OwnershipTransferred(address indexed prev, address indexed next)",
Â  "event ParamsUpdated(uint16 aprBps, uint16 maxLtvBps, uint16 liqThresholdBps, uint16 liqBonusBps)",
Â  "event Paused(address indexed by)",
Â  "event Repaid(address indexed user, uint256 repaidUSDC_6, uint256 principalLeft_6)",
Â  "event RolesUpdated(address treasury, address rateGuardian, address riskGuardian)",
Â  "event SevereParamsUpdated(uint16 severeLiqThresholdBps, uint16 severeLiqBonusBps, bool severePublic)",
Â  "event SevereResidualSent(address indexed user, uint256 residualMTYLD_18)",
Â  "event Unpaused(address indexed by)",
Â  "event WhitelistSet(address indexed user, bool allowed)"
];

const ERC20_ABI = [
Â  "function balanceOf(address) view returns (uint256)",
Â  "function allowance(address,address) view returns (uint256)",
Â  "function approve(address,uint256) returns (bool)"
];

(async () => {
Â  const $ = id => document.getElementById(id);

Â  // fill contract address in the UI from the constant
Â  $("lendingAddr").textContent = LENDING_ADDR;

Â  // DOM refs
Â  const addrEl=$("addr"), tokenTriplet=$("tokenTriplet"), treasuryAddrEl=$("treasuryAddr");
Â  const mtyldPriceEl=$("mtyldPrice"), balMtyldEl=$("balMtyld"), balUsdcEl=$("balUsdc"), ltvLine=$("ltvLine");
Â  const userColMtyld=$("userColMtyld"), userColUsd=$("userColUsd"), userDebtUsdc=$("userDebtUsdc"), userDebtUsd=$("userDebtUsd"), userInterestLate=$("userInterestLate"), userScore=$("userScore"), userMaturity=$("userMaturity");
Â  const treasuryBalEl=$("treasuryBal"), availBorrowEl=$("availBorrow"), warnBar=$("warnBar");
Â  const borrowLimitEl=$("borrowLimit"), liqThresholdEl=$("liqThreshold"), debtAtLiqEl=$("debtAtLiq"), daysToMatEl=$("daysToMat"), aprLine=$("aprLine");

Â  const adminPanel=$("adminPanel"), ownerOf=$("ownerOf"), ownerAddr=$("ownerAddr"), roleTreasury=$("roleTreasury"), rateGuardian=$("rateGuardian"), riskGuardian=$("riskGuardian");
Â  const inTreasury=$("inTreasury"), inRateG=$("inRateG"), inRiskG=$("inRiskG"), rolesMsg=$("rolesMsg");
Â  const inApr=$("inApr"), inMaxLtv=$("inMaxLtv"), inLiqThresh=$("inLiqThresh"), inLiqBonus=$("inLiqBonus"), paramsMsg=$("paramsMsg");
Â  const inSevThresh=$("inSevThresh"), inSevBonus=$("inSevBonus"), inSevPublic=$("inSevPublic"), severeMsg=$("severeMsg");
Â  const opsMsg=$("opsMsg"), inWL=$("inWL"), inScore=$("inScore"), wlMsg=$("wlMsg");

Â  const depAmt=$("depAmt"), depMax=$("depMax"), depMsg=$("depMsg");
Â  const wdAmt=$("wdAmt"), wdMax=$("wdMax"), wdMsg=$("wdMsg");
Â  const brAmt=$("brAmt"), brDays=$("brDays"), brMsg=$("brMsg");
Â  const rpAmt=$("rpAmt"), rpMax=$("rpMax"), rpMsg=$("rpMsg");

Â  let provider, signer, acct, lending, USDC, MTYLD, VAULT_ADDR, TREASURY;

Â  const fmt6=x=>Number(x)/1e6, fmt18=x=>Number(x)/1e18, to6=v=>BigInt(Math.round(Number(v||"0")*1e6)), to18=v=>BigInt(Math.round(Number(v||"0")*1e18));
Â  const trunc=a=>a?a.slice(0,6)+"â€¦"+a.slice(-4):"â€”", usd=(n,d=2)=>"$"+Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
Â  const shortErr=e=>(e && (e.info?.error?.message || e.shortMessage || e.message))?.replace(/execution reverted: /i,'').slice(0,200) || "Error";

Â  async function ensure(){
Â  Â  if(!window.ethereum){ alert("Please install/enable MetaMask."); throw new Error("no wallet"); }
Â  Â  provider = new ethers.BrowserProvider(window.ethereum);
Â  Â  const net = await provider.getNetwork();
Â  Â  if(Number(net.chainId)!==CHAIN_ID_ARBITRUM){
Â  Â  Â  await window.ethereum.request({ method:"wallet_switchEthereumChain", params:[{chainId:"0xa4b1"}]});
Â  Â  }
Â  Â  signer = await provider.getSigner();
Â  Â  acct = await signer.getAddress();
Â  Â  addrEl.textContent = trunc(acct);

Â  Â  // FIX 1: Using LENDING_VAULT_GATED_V3_ABI
Â  Â  lending = new ethers.Contract(LENDING_ADDR, LENDING_VAULT_GATED_V3_ABI, signer); 
Â  Â  const [usdcAddr, mtyldAddr, vaultAddr, treasuryAddr, own, rateG, riskG] = await Promise.all([
Â  Â  Â  lending.USDC(), lending.MTYLD(), lending.MTYLD_VAULT(), lending.treasury(),
Â  Â  Â  lending.owner(), lending.rateGuardian(), lending.riskGuardian()
Â  Â  ]);
Â  Â  VAULT_ADDR=vaultAddr; TREASURY=treasuryAddr;
Â  Â  tokenTriplet.textContent = `${usdcAddr} / ${mtyldAddr} / ${vaultAddr}`;
Â  Â  treasuryAddrEl.textContent = treasuryAddr;
Â  Â  ownerOf.textContent = trunc(LENDING_ADDR);
Â  Â  ownerAddr.textContent = trunc(own);
Â  Â  roleTreasury.textContent = trunc(treasuryAddr);
Â  Â  rateGuardian.textContent = trunc(rateG);
Â  Â  riskGuardian.textContent = trunc(riskG);
Â  Â  adminPanel.classList.toggle("hidden", own.toLowerCase() !== acct.toLowerCase());

Â  Â  USDCÂ  = new ethers.Contract(usdcAddr, ERC20_ABI, signer);
Â  Â  MTYLD = new ethers.Contract(mtyldAddr, ERC20_ABI, signer);
Â  }

Â  async function refresh(){
Â  Â  try{
Â  Â  Â  const readProv = provider || new ethers.JsonRpcProvider("https://arb1.arbitrum.io/rpc");
Â  Â  Â  // FIX 2: Using LENDING_VAULT_GATED_V3_ABI
Â  Â  Â  const read = new ethers.Contract(LENDING_ADDR, LENDING_VAULT_GATED_V3_ABI, readProv); 
Â  Â  Â  const [usdcAddr, mtyldAddr, vaultAddr, treasuryAddr] = await Promise.all([read.USDC(), read.MTYLD(), read.MTYLD_VAULT(), read.treasury()]);
Â  Â  Â  VAULT_ADDR=vaultAddr; TREASURY=treasuryAddr;
Â  Â  Â  tokenTriplet.textContent = `${usdcAddr} / ${mtyldAddr} / ${vaultAddr}`;
Â  Â  Â  treasuryAddrEl.textContent = treasuryAddr;

Â  Â  Â  const readVault = new ethers.Contract(vaultAddr, ["function pricePerToken() view returns (uint256)"], readProv);
Â  Â  Â  const price18 = await readVault.pricePerToken();
Â  Â  Â  mtyldPriceEl.textContent = "$" + (Number(price18)/1e18).toFixed(6);

Â  Â  Â  const USDC_r = new ethers.Contract(usdcAddr, ERC20_ABI, readProv);
Â  Â  Â  const [treasuryBal, treasuryAllow] = await Promise.all([
Â  Â  Â  Â  USDC_r.balanceOf(treasuryAddr),
Â  Â  Â  Â  USDC_r.allowance(treasuryAddr, LENDING_ADDR)
Â  Â  Â  ]);
Â  Â  Â  treasuryBalEl.textContent = fmt6(treasuryBal).toLocaleString(undefined,{maximumFractionDigits:2}) + " USDC";

Â  Â  Â  if(signer){
Â  Â  Â  Â  const a = acct || await signer.getAddress();
Â  Â  Â  Â  const MTYLD_r = new ethers.Contract(mtyldAddr, ERC20_ABI, readProv);
Â  Â  Â  Â  const [bu,bm] = await Promise.all([USDC_r.balanceOf(a), MTYLD_r.balanceOf(a)]);
Â  Â  Â  Â  balUsdcEl.textContentÂ  = fmt6(bu).toFixed(2) + " USDC";
Â  Â  Â  Â  balMtyldEl.textContent = fmt18(bm).toFixed(4) + " MTYLD";

Â  Â  Â  Â  const [V, apr, maxLtv, liqThresh] = await Promise.all([read.userView(a), read.aprBps(), read.maxLtvBps(), read.liqThresholdBps()]);
Â  Â  Â  Â  const colM = Number(V.collateralMTYLD_18)/1e18;
Â  Â  Â  Â  const colU = Number(V.collateralUSD_18)/1e18;
Â  Â  Â  Â  const debtUSDC = (Number(V.principalUSDC_6)+Number(V.interestUSDC_6)+Number(V.lateFeesUSDC_6))/1e6;
Â  Â  Â  Â  const debtUSDÂ  = Number(V.debtUSD_18)/1e18;

Â  Â  Â  Â  userColMtyld.textContent = colM.toFixed(4)+" MTYLD";
Â  Â  Â  Â  userColUsd.textContentÂ  Â  = usd(colU);
Â  Â  Â  Â  userDebtUsdc.textContentÂ  = debtUSDC.toFixed(2)+" USDC";
Â  Â  Â  Â  userDebtUsd.textContentÂ  Â = usd(debtUSD);
Â  Â  Â  Â  userInterestLate.textContent = (Number(V.interestUSDC_6)/1e6 + Number(V.lateFeesUSDC_6)/1e6).toFixed(2) + " USDC";
Â  Â  Â  Â  userScore.textContentÂ  Â  Â = String(V.creditScore || 0);
Â  Â  Â  Â  userMaturity.textContentÂ  = V.maturity ? new Date(Number(V.maturity)*1000).toLocaleString() : "â€”";
Â  Â  Â  Â  ltvLine.textContentÂ  Â  Â  Â = (Number(V.ltvBps)/100).toFixed(2) + "%";

Â  Â  Â  Â  aprLine.textContent = (Number(apr)/100).toFixed(2) + "% APR";
Â  Â  Â  Â  liqThresholdEl.textContent = (Number(liqThresh)/100).toFixed(2) + "%";

Â  Â  Â  Â  const borrowLimit = colU * (Number(maxLtv)/10000);
Â  Â  Â  Â  borrowLimitEl.textContent = usd(borrowLimit);
Â  Â  Â  Â  const debtAtLiq = colU * (Number(liqThresh)/10000);
Â  Â  Â  Â  debtAtLiqEl.textContent = usd(debtAtLiq);

Â  Â  Â  Â  const now = Math.floor(Date.now()/1000);
Â  Â  Â  Â  daysToMatEl.textContent = V.maturity && V.maturity>0 ? Math.max(0, Math.ceil((Number(V.maturity)-now)/86400))+"d" : "â€”";

Â  Â  Â  Â  // headroom & availability
Â  Â  Â  Â  const headroom = Math.max(0, borrowLimit - debtUSD);
Â  Â  Â  Â  const treasuryUsd = fmt6(treasuryBal);
Â  Â  Â  Â  const allowUsdÂ  Â  = fmt6(treasuryAllow);
Â  Â  Â  Â  const available = Math.max(0, Math.min(headroom, treasuryUsd, allowUsd));
Â  Â  Â  Â  availBorrowEl.textContent = usd(available);

Â  Â  Â  Â  warnBar.textContent = "";
Â  Â  Â  Â  if (treasuryUsd <= 0) warnBar.textContent = "Treasury has no USDC. Admin must fund Treasury.";
Â  Â  Â  Â  else if (allowUsd <= 0) warnBar.textContent = "Treasury hasnâ€™t approved the lending contract to spend USDC.";
Â  Â  Â  }
Â  Â  }catch(e){ console.error(e); alert("Refresh failed: "+shortErr(e)); }
Â  }

Â  // ===== Collateral =====
Â  depMax.onclick = async () => { try { if(!MTYLD) return; const b=await MTYLD.balanceOf(acct); depAmt.value=(Number(b)/1e18).toFixed(4);}catch{} };
Â  wdMax.onclick = async () => { try { if(!lending) return; const V=await lending.userView(acct); wdAmt.value=(Number(V.collateralMTYLD_18)/1e18).toFixed(4);}catch{} };

Â  document.getElementById("btnDeposit").onclick = async () => {
Â  Â  try{
Â  Â  Â  const depMsg = document.getElementById("depMsg");
Â  Â  Â  depMsg.textContent="";
Â  Â  Â  if(!provider) await ensure();
Â  Â  Â  const a=to18(depAmt.value); if(a<=0n){depMsg.textContent="Enter amount";return;}
Â  Â  Â  const allowance=await MTYLD.allowance(acct,LENDING_ADDR);
Â  Â  Â  if(allowance<a){const txa=await MTYLD.approve(LENDING_ADDR,a);await txa.wait();}
Â  Â  Â  const tx=await lending.depositCollateral(a); await tx.wait();
Â  Â  Â  depMsg.textContent="Deposited âœ…"; await refresh();
Â  Â  }catch(e){ console.error(e); depMsg.textContent=shortErr(e); }
Â  };

Â  document.getElementById("btnWithdraw").onclick = async () => {
Â  Â  try{
Â  Â  Â  const wdMsg = document.getElementById("wdMsg");
Â  Â  Â  wdMsg.textContent="";
Â  Â  Â  if(!provider) await ensure();
Â  Â  Â  const a=to18(wdAmt.value); if(a<=0n){wdMsg.textContent="Enter amount";return;}
Â  Â  Â  const tx=await lending.withdrawCollateral(a); await tx.wait();
Â  Â  Â  wdMsg.textContent="Withdrawn âœ…"; await refresh();
Â  Â  }catch(e){ console.error(e); wdMsg.textContent=shortErr(e); }
Â  };

Â  // ===== Borrow / Repay =====
Â  document.getElementById("btnBorrow").onclick = async () => {
Â  Â  try{
Â  Â  Â  const brMsg = document.getElementById("brMsg");
Â  Â  Â  brMsg.textContent="";
Â  Â  Â  if(!provider) await ensure();
Â  Â  Â  const amt=to6(brAmt.value), days=Math.floor(Number(brDays.value||"0"));
Â  Â  Â  if(amt<=0n || !(days>0)){ brMsg.textContent="Enter amount & days"; return; }

Â  Â  Â  // preflight: treasury balance + allowance
Â  Â  Â  const [usdcAddr, treasuryAddr] = await Promise.all([lending.USDC(), lending.treasury()]);
Â  Â  Â  const USDC_r = new ethers.Contract(usdcAddr, ERC20_ABI, provider);
Â  Â  Â  const [bal, allow] = await Promise.all([USDC_r.balanceOf(treasuryAddr), USDC_r.allowance(treasuryAddr, LENDING_ADDR)]);
Â  Â  Â  if (bal < amt)Â  Â { brMsg.textContent="Treasury has insufficient USDC for this borrow."; return; }
Â  Â  Â  if (allow < amt) { brMsg.textContent="Treasury hasnâ€™t approved the lending contract (admin must call USDC.approve)."; return; }

Â  Â  Â  const maturity = BigInt(Math.floor(Date.now()/1000) + days*86400);
Â  Â  Â  const tx=await lending.borrow(amt, maturity); await tx.wait();
Â  Â  Â  brMsg.textContent="Borrowed âœ…"; await refresh();
Â  Â  }catch(e){ console.error(e); brMsg.textContent=shortErr(e); }
Â  };

Â  rpMax.onclick = async () => { try { if(!lending) return; const V=await lending.userView(acct); const d=(Number(V.principalUSDC_6)+Number(V.interestUSDC_6)+Number(V.lateFeesUSDC_6))/1e6; rpAmt.value=d.toFixed(2);}catch{} };

Â  document.getElementById("btnRepay").onclick = async () => {
Â  Â  try{
Â  Â  Â  const rpMsg = document.getElementById("rpMsg");
Â  Â  Â  rpMsg.textContent="";
Â  Â  Â  if(!provider) await ensure();
Â  Â  Â  const amt=to6(rpAmt.value); if(amt<=0n){rpMsg.textContent="Enter amount";return;}
Â  Â  Â  const allowance=await USDC.allowance(acct,LENDING_ADDR);
Â  Â  Â  if(allowance<amt){const txa=await USDC.approve(LENDING_ADDR,amt); await txa.wait();}
Â  Â  Â  const tx=await lending.repay(amt); await tx.wait();
Â  Â  Â  rpMsg.textContent="Repaid âœ…"; await refresh();
Â  Â  }catch(e){ console.error(e); rpMsg.textContent=shortErr(e); }
Â  };

Â  // ===== Admin handlers =====
Â  const isAddr = a => /^0x[a-fA-F0-9]{40}$/.test(String(a||"").trim());

Â  document.getElementById("btnSetRoles").onclick = async () => {
Â  Â  try{
Â  Â  Â  rolesMsg.textContent="";
Â  Â  Â  if(!provider) await ensure();
Â  Â  Â  const t=inTreasury.value.trim(), r=inRateG.value.trim(), k=inRiskG.value.trim();
Â  Â  Â  if(!isAddr(t)||!isAddr(r)||!isAddr(k)){ rolesMsg.textContent="Enter valid addresses"; return; }
Â  Â  Â  const tx=await lending.setRoles(t,r,k); await tx.wait();
Â  Â  Â  rolesMsg.textContent="Roles updated âœ…"; await refresh();
Â  Â  }catch(e){ console.error(e); rolesMsg.textContent=shortErr(e); }
Â  };

Â  document.getElementById("btnSetParams").onclick = async () => {
Â  Â  try{
Â  Â  Â  paramsMsg.textContent="";
Â  Â  Â  if(!provider) await ensure();
Â  Â  Â  const apr=Number(inApr.value||"0"), max=Number(inMaxLtv.value||"0"), th=Number(inLiqThresh.value||"0"), bo=Number(inLiqBonus.value||"0");
Â  Â  Â  const tx=await lending.setParams(apr,max,th,bo); await tx.wait();
Â  Â  Â  paramsMsg.textContent="Params updated âœ…"; await refresh();
Â  Â  }catch(e){ console.error(e); paramsMsg.textContent=shortErr(e); }
Â  };

Â  document.getElementById("btnSetSevere").onclick = async () => {
Â  Â  try{
Â  Â  Â  severeMsg.textContent="";
Â  Â  Â  if(!provider) await ensure();
Â  Â  Â  const st=Number(inSevThresh.value||"0"), sb=Number(inSevBonus.value||"0"), pub=!!inSevPublic.checked;
Â  Â  Â  const tx=await lending.setSevereParams(st,sb,pub); await tx.wait();
Â  Â  Â  severeMsg.textContent="Severe params updated âœ…";
Â  Â  }catch(e){ console.error(e); severeMsg.textContent=shortErr(e); }
Â  };

Â  document.getElementById("btnPause").onclick = async () => { try{ opsMsg.textContent=""; if(!provider) await ensure(); const tx=await lending.pause(); await tx.wait(); opsMsg.textContent="Paused âœ…"; }catch(e){ opsMsg.textContent=shortErr(e);} };
Â  document.getElementById("btnUnpause").onclick = async () => { try{ opsMsg.textContent=""; if(!provider) await ensure(); const tx=await lending.unpause(); await tx.wait(); opsMsg.textContent="Unpaused âœ…"; }catch(e){ opsMsg.textContent=shortErr(e);} };
Â  document.getElementById("btnPauseLiq").onclick = async () => { try{ opsMsg.textContent=""; if(!provider) await ensure(); const tx=await lending.setLiquidationPaused(true); await tx.wait(); opsMsg.textContent="Liquidations paused âœ…"; }catch(e){ opsMsg.textContent=shortErr(e);} };
Â  document.getElementById("btnUnpauseLiq").onclick = async () => { try{ opsMsg.textContent=""; if(!provider) await ensure(); const tx=await lending.setLiquidationPaused(false); await tx.wait(); opsMsg.textContent="Liquidations unpaused âœ…"; }catch(e){ opsMsg.textContent=shortErr(e);} };

Â  document.getElementById("btnWLOn").onclick = async () => { try{ wlMsg.textContent=""; if(!provider) await ensure(); const a=inWL.value.trim(); if(!isAddr(a)){ wlMsg.textContent="Enter valid address"; return; } const tx=await lending.setWhitelist(a,true); await tx.wait(); wlMsg.textContent="Whitelisted âœ…"; }catch(e){ wlMsg.textContent=shortErr(e);} };
Â  document.getElementById("btnWLOff").onclick = async () => { try{ wlMsg.textContent=""; if(!provider) await ensure(); const a=inWL.value.trim(); if(!isAddr(a)){ wlMsg.textContent="Enter valid address"; return; } const tx=await lending.setWhitelist(a,false); await tx.wait(); wlMsg.textContent="Removed âœ…"; }catch(e){ wlMsg.textContent=shortErr(e);} };
Â  document.getElementById("btnSetCredit").onclick = async () => { try{ wlMsg.textContent=""; if(!provider) await ensure(); const a=inWL.value.trim(); const s=Math.max(0,Number(inScore.value||"0"))|0; if(!isAddr(a)){ wlMsg.textContent="Enter valid address"; return; } const tx=await lending.adminSetCredit(a,s); await tx.wait(); wlMsg.textContent="Credit score set âœ…"; await refresh(); }catch(e){ wlMsg.textContent=shortErr(e);} };

Â  // Connect + refresh + about + footer
Â  document.getElementById("btnConnect").onclick = async () => { try{ await ensure(); await refresh(); }catch(e){ console.error(e);} };
Â  document.getElementById("btnRefresh").onclick = async () => { await refresh(); };
Â  document.getElementById("btnAbout").onclick = () => { document.getElementById("aboutCL").scrollIntoView({behavior:"smooth",block:"start"}); document.querySelectorAll("#aboutCL details").forEach(d=>d.open=true); };
Â  document.getElementById("yr").textContent = new Date().getFullYear();

Â  // First paint
Â  await refresh();
})();
</script>
</body>
</html>
