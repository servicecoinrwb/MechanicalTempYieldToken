<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mechanical Temp • LendingVaultGatedV3</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <header class="sticky top-0 z-30 bg-slate-900/80 backdrop-blur border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="https://vault.mechanicaltemp.com" class="flex items-center gap-3">
        <img src="https://i.imgur.com/YJvJw7V.png" class="h-9 w-auto" alt="Mechanical Temp">
        <div class="text-slate-300 font-semibold hidden sm:block">MTYLD • Credit Line</div>
      </div>
      <div class="flex items-center gap-2">
        <!-- Admin role badge -->
        <span id="roleBadge" class="hidden px-2 py-1 rounded-md bg-amber-500/20 text-amber-300 text-xs font-semibold">ADMIN</span>
        <button id="btnConnect" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Connect</button>
        <button id="btnRefresh" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">↻</button>
      </div>
    </div>
  <header

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-4">
    <div class="grid md:grid-cols-3 gap-4 items-start">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-xs text-slate-500">Connected</div>
        <div id="addr" class="font-mono text-slate-300 truncate">Not connected</div>
        <div class="mt-2 text-xs text-slate-500">Credit Contract</div>
        <div class="font-mono text-slate-300 truncate">0x8fC8b61882e4792c1fB4Ea128b55c90c3069f027</div>
        <div class="mt-2 text-xs text-slate-500">USDC / MTYLD / MTYLD Vault</div>
        <div id="tokenTriplet" class="font-mono text-slate-300 text-xs break-all">—</div>
      </div>

      <div class="md:col-span-2 bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">MTYLD Price (USD)</div>
            <div id="mtyldPrice" class="font-mono text-lg">$–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Your MTYLD</div>
            <div id="balMtyld" class="font-mono text-lg">–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Your USDC</div>
            <div id="balUsdc" class="font-mono text-lg">–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Health (LTV)</div>
            <div id="ltvLine" class="font-mono text-lg">–</div>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Collateral (MTYLD)</div>
          <div class="font-mono text-lg" id="userColMtyld">–</div>
          <div class="text-slate-400 text-xs" id="userColUsd">USD –</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Debt (USDC)</div>
          <div class="font-mono text-lg" id="userDebtUsdc">–</div>
          <div class="text-slate-400 text-xs" id="userDebtUsd">USD –</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Interest + Late</div>
          <div class="font-mono text-lg" id="userInterestLate">–</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Credit Score</div>
          <div class="font-mono text-lg" id="userScore">–</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Maturity</div>
          <div class="font-mono text-lg" id="userMaturity">–</div>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 font-semibold">Collateral: MTYLD</div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <div class="text-slate-400 text-xs mb-1">Deposit MTYLD</div>
            <div class="flex gap-2">
              <input id="depAmt" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="depMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnDeposit" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Approve & Deposit</button>
            <div id="depMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>

          <div>
            <div class="text-slate-400 text-xs mb-1">Withdraw MTYLD</div>
            <div class="flex gap-2">
              <input id="wdAmt" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="wdMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnWithdraw" class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Withdraw</button>
            <div id="wdMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>
        </div>
      </div>

      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 font-semibold">Borrow / Repay (USDC)</div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <div class="text-slate-400 text-xs mb-1">Borrow USDC</div>
            <input id="brAmt" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
            <div class="flex gap-2 mt-2">
              <input id="brDays" inputmode="numeric" placeholder="Maturity (days)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="btnBorrow" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Borrow</button>
            </div>
            <div id="brMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>

          <div>
            <div class="text-slate-400 text-xs mb-1">Repay USDC</div>
            <div class="flex gap-2">
              <input id="rpAmt" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="rpMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnRepay" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Approve & Repay</button>
            <div id="rpMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN PANEL (auto-gated) -->
    <div id="adminCard" class="hidden bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <div class="text-slate-300 font-semibold">Admin Panel</div>
        <div id="adminRoleLine" class="text-xs text-slate-400">Role: —</div>
      </div>

      <!-- System -->
      <div class="mt-4 grid md:grid-cols-3 gap-4">
        <div class="p-3 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs mb-2">System Status</div>
          <div class="text-sm" id="pausedLine">Paused: —</div>
          <div class="text-sm" id="liqPausedLine">Liquidations Paused: —</div>
          <div class="mt-3 flex gap-2">
            <button id="btnPause"   class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Pause</button>
            <button id="btnUnpause" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700">Unpause</button>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <input id="chkLiqPaused" type="checkbox" class="h-4 w-4">
            <label for="chkLiqPaused" class="text-sm text-slate-300">Set Liquidations Paused</label>
            <button id="btnSetLiqPaused" class="ml-auto px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Apply</button>
          </div>
          <div id="sysMsg" class="text-xs text-slate-400 mt-2">—</div>
        </div>

        <div class="p-3 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs mb-2">Parameters (bps)</div>
          <div class="grid grid-cols-2 gap-2">
            <input id="inApr"          inputmode="numeric" placeholder="APR bps"         class="px-2 py-2 rounded bg-slate-900 border border-slate-700">
            <input id="inMaxLtv"       inputmode="numeric" placeholder="Max LTV bps"     class="px-2 py-2 rounded bg-slate-900 border border-slate-700">
            <input id="inLiqThresh"    inputmode="numeric" placeholder="Liq Thresh bps"  class="px-2 py-2 rounded bg-slate-900 border border-slate-700">
            <input id="inLiqBonus"     inputmode="numeric" placeholder="Liq Bonus bps"   class="px-2 py-2 rounded bg-slate-900 border border-slate-700">
          </div>
          <button id="btnSetParams" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Update Params</button>

          <div class="mt-4 text-slate-400 text-xs">Late Fee (bps, flat)</div>
          <div class="flex gap-2 mt-1">
            <input id="inLateBps" inputmode="numeric" placeholder="Late Fee bps" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700">
            <button id="btnSetLate" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Set</button>
          </div>

          <div id="paramMsg" class="text-xs text-slate-400 mt-2">—</div>
        </div>

        <div class="p-3 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs mb-2">Severe Liquidation</div>
          <div class="grid grid-cols-2 gap-2">
            <input id="inSevThresh" inputmode="numeric" placeholder="Severe Thresh bps" class="px-2 py-2 rounded bg-slate-900 border border-slate-700">
            <input id="inSevBonus"  inputmode="numeric" placeholder="Severe Bonus bps"  class="px-2 py-2 rounded bg-slate-900 border border-slate-700">
          </div>
          <div class="mt-2 flex items-center gap-2">
            <input id="chkSevPublic" type="checkbox" class="h-4 w-4">
            <label for="chkSevPublic" class="text-sm text-slate-300">Severe Public</label>
          </div>
          <button id="btnSetSevere" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Update Severe</button>
          <div id="sevMsg" class="text-xs text-slate-400 mt-2">—</div>
        </div>
      </div>

      <!-- Roles / Whitelist / Credit -->
      <div class="mt-4 grid md:grid-cols-3 gap-4">
        <div class="p-3 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs mb-2">Roles</div>
          <input id="inTreasury" placeholder="Treasury address" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700 mb-2">
          <input id="inRate"     placeholder="Rate Guardian address" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700 mb-2">
          <input id="inRisk"     placeholder="Risk Guardian address" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700 mb-2">
          <button id="btnSetRoles" class="w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Set Roles</button>
          <div id="rolesMsg" class="text-xs text-slate-400 mt-2">—</div>
        </div>

        <div class="p-3 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs mb-2">Whitelist</div>
          <input id="inWLUser" placeholder="User address" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700 mb-2">
          <div class="flex items-center gap-2 mb-2">
            <input id="chkWL" type="checkbox" class="h-4 w-4">
            <label for="chkWL" class="text-sm text-slate-300">Allowed</label>
          </div>
          <button id="btnSetWL" class="w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Set Whitelist</button>
          <div id="wlMsg" class="text-xs text-slate-400 mt-2">—</div>
        </div>

        <div class="p-3 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs mb-2">Credit Score</div>
          <input id="inUserCredit" placeholder="User address" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700 mb-2">
          <input id="inCredit" inputmode="numeric" placeholder="Score (uint32)" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700 mb-2">
          <button id="btnSetCredit" class="w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Set Credit</button>
          <div id="creditMsg" class="text-xs text-slate-400 mt-2">—</div>
        </div>
      </div>

      <!-- Readouts -->
      <div class="mt-4 p-3 rounded-lg bg-slate-800/40 border border-slate-700/50 text-sm grid sm:grid-cols-2 gap-2">
        <div id="readParams">Params: —</div>
        <div id="readSevere">Severe: —</div>
        <div id="readLate">Late Fee: —</div>
        <div id="readRoles">Roles: —</div>
      </div>
    </div>

    <p class="text-xs text-slate-500">Arbitrum One • MTYLD Credit Line UI</p>
  </main>

<script>
const CHAIN_ID_ARBITRUM = 42161;
const LENDING_ADDR = "0x8fC8b61882e4792c1fB4Ea128b55c90c3069f027";

// ===== ABI (exactly what you supplied) =====
const LENDING_ABI = [{"inputs":[{"internalType":"address","name":"usdc","type":"address"},{"internalType":"address","name":"mtyld","type":"address"},{"internalType":"address","name":"mtyldVault","type":"address"},{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"BadAddress","type":"error"},{"inputs":[],"name":"BadAmount","type":"error"},{"inputs":[],"name":"Healthy","type":"error"},{"inputs":[],"name":"NotActive","type":"error"},{"inputs":[],"name":"NotOwnerGuardian","type":"error"},{"inputs":[],"name":"NotSevere","type":"error"},{"inputs":[],"name":"NotWhitelisted","type":"error"},{"inputs":[],"name":"OverLTV","type":"error"},{"inputs":[],"name":"Slippage","type":"error"},{"inputs":[],"name":"TooEarly","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"interestAccrued_6","type":"uint256"},{"indexed":false,"internalType":"bool","name":"lateFeeApplied","type":"bool"}],"name":"Accrued","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"usdcAmount_6","type":"uint256"},{"indexed":false,"internalType":"uint64","name":"start","type":"uint64"},{"indexed":false,"internalType":"uint64","name":"maturity","type":"uint64"}],"name":"Borrowed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount_18","type":"uint256"}],"name":"CollateralDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount_18","type":"uint256"}],"name":"CollateralWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"lateFeeBpsFlat","type":"uint16"}],"name":"LateFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"liquidator","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"repayUSDC_6","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seizeMTYLD_18","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"price18","type":"uint256"},{"indexed":false,"internalType":"uint16","name":"bonusBps","type":"uint16"},{"indexed":false,"internalType":"bool","name":"severe","type":"bool"}],"name":"Liquidated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"on","type":"bool"}],"name":"LiquidationPaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"prev","type":"address"},{"indexed":true,"internalType":"address","name":"next","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"aprBps","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"maxLtvBps","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"liqThresholdBps","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"liqBonusBps","type":"uint16"}],"name":"ParamsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"by","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"repaidUSDC_6","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"principalLeft_6","type":"uint256"}],"name":"Repaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"treasury","type":"address"},{"indexed":false,"internalType":"address","name":"rateGuardian","type":"address"},{"indexed":false,"internalType":"address","name":"riskGuardian","type":"address"}],"name":"RolesUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"severeLiqThresholdBps","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"severeLiqBonusBps","type":"uint16"},{"indexed":false,"internalType":"bool","name":"severePublic","type":"bool"}],"name":"SevereParamsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"residualMTYLD_18","type":"uint256"}],"name":"SevereResidualSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"by","type":"address"}],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"allowed","type":"bool"}],"name":"WhitelistSet","type":"event"},{"inputs":[],"name":"APR_MAX_BPS","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"BPS_DENOMINATOR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BPS_U16","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MTYLD","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MTYLD_VAULT","outputs":[{"internalType":"contract IMTYLDVault","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SECONDS_PER_YEAR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"USDC","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"USDC_6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"USD_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint32","name":"score","type":"uint32"}],"name":"adminSetCredit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"aprBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount_6","type":"uint256"},{"internalType":"uint64","name":"maturity","type":"uint64"}],"name":"borrow","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"canBeLiquidated","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"canBeSeverelyLiquidated","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"collateralMTYLD_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"collateralUsd_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"creditScore","outputs":[{"internalType":"uint32","name":"score","type":"uint32"},{"internalType":"uint32","name":"lastUpdated","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"debtUsd_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amountMTYLD_18","type":"uint256"}],"name":"depositCollateral","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isWhitelisted","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lateFeeBpsFlat","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"liqBonusBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"liqThresholdBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"repayUSDC_6","type":"uint256"},{"internalType":"uint256","name":"minSeizeMTYLD_18","type":"uint256"}],"name":"liquidate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"liquidationAmountUSDC_6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"liquidationPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"loans","outputs":[{"internalType":"uint256","name":"principalUSDC_6","type":"uint256"},{"internalType":"uint256","name":"interestUSDC_6","type":"uint256"},{"internalType":"uint256","name":"lateFeesUSDC_6","type":"uint256"},{"internalType":"uint64","name":"start","type":"uint64"},{"internalType":"uint64","name":"maturity","type":"uint64"},{"internalType":"bool","name":"lateFeeApplied","type":"bool"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"ltvBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxLtvBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"mtyldUsdPrice_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rateGuardian","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount_6","type":"uint256"}],"name":"repay","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"riskGuardian","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint16","name":"_lateFeeBpsFlat","type":"uint16"}],"name":"setLateFeeBps","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"on","type":"bool"}],"name":"setLiquidationPaused","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_aprBps","type":"uint16"},{"internalType":"uint16","name":"_maxLtvBps","type":"uint16"},{"internalType":"uint16","name":"_liqThresholdBps","type":"uint16"},{"internalType":"uint16","name":"_liqBonusBps","type":"uint16"}],"name":"setParams","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_treasury","type":"address"},{"internalType":"address","name":"_rate","type":"address"},{"internalType":"address","name":"_risk","type":"address"}],"name":"setRoles","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_sevThreshBps","type":"uint16"},{"internalType":"uint16","name":"_sevBonusBps","type":"uint16"},{"internalType":"bool","name":"_public","type":"bool"}],"name":"setSevereParams","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"bool","name":"allowed","type":"bool"}],"name":"setWhitelist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"severeLiqBonusBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"severeLiqThresholdBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"minSeizeMTYLD_18","type":"uint256"}],"name":"severeLiquidate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"severePublic","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"n","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"userView","outputs":[{"components":[{"internalType":"uint256","name":"collateralMTYLD_18","type":"uint256"},{"internalType":"uint256","name":"collateralUSD_18","type":"uint256"},{"internalType":"uint256","name":"principalUSDC_6","type":"uint256"},{"internalType":"uint256","name":"interestUSDC_6","type":"uint256"},{"internalType":"uint256","name":"lateFeesUSDC_6","type":"uint256"},{"internalType":"uint256","name":"debtUSD_18","type":"uint256"},{"internalType":"uint16","name":"ltvBps","type":"uint16"},{"internalType":"uint32","name":"creditScore","type":"uint32"},{"internalType":"uint64","name":"maturity","type":"uint64"},{"internalType":"bool","name":"active","type":"bool"}],"internalType":"struct LendingVaultGatedV3.UserView","name":"V","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amountMTYLD_18","type":"uint256"}],"name":"withdrawCollateral","outputs":[],"stateMutability":"nonpayable","type":"function"}];

// ===== Simple ERC20 ABI =====
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address,address) view returns (uint256)",
  "function approve(address,uint256) returns (bool)",
  "function decimals() view returns (uint8)"
];

(async () => {
  // DOM helpers
  const $ = (id) => document.getElementById(id);
  const addrEl = $("addr"), tripletEl = $("tokenTriplet");
  const mtyldPriceEl = $("mtyldPrice"), balMtyldEl = $("balMtyld"), balUsdcEl = $("balUsdc"), ltvLine = $("ltvLine");
  const userColMtyld = $("userColMtyld"), userColUsd = $("userColUsd"), userDebtUsdc = $("userDebtUsdc"), userDebtUsd = $("userDebtUsd");
  const userInterestLate = $("userInterestLate"), userScore = $("userScore"), userMaturity = $("userMaturity");
  const depAmt = $("depAmt"), depMax = $("depMax"), depMsg = $("depMsg"), btnDeposit = $("btnDeposit");
  const wdAmt = $("wdAmt"), wdMax = $("wdMax"), wdMsg = $("wdMsg"), btnWithdraw = $("btnWithdraw");
  const brAmt = $("brAmt"), brDays = $("brDays"), brMsg = $("brMsg"), btnBorrow = $("btnBorrow");
  const rpAmt = $("rpAmt"), rpMax = $("rpMax"), rpMsg = $("rpMsg"), btnRepay = $("btnRepay");

  let provider, signer, acct, lending, USDC, MTYLD;

  const fmt6  = (x) => Number(x)/1e6;
  const fmt18 = (x) => Number(x)/1e18;
  const to6   = (v) => BigInt(Math.round(Number(v||"0")*1e6));
  const to18  = (v) => BigInt(Math.round(Number(v||"0")*1e18));
  const trunc = (a) => a ? a.slice(0,6)+"…"+a.slice(-4) : "—";
  const usd   = (n,d=2)=>"$"+Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
  const shortErr = (e)=> (e && (e.info?.error?.message || e.shortMessage || e.message))?.replace(/execution reverted: /i,'').slice(0,200) || "Error";

  async function ensure(){
    if (!window.ethereum) { alert("Please install/enable MetaMask."); throw new Error("no wallet"); }
    provider = new ethers.BrowserProvider(window.ethereum);
    const net = await provider.getNetwork();
    if (Number(net.chainId) !== CHAIN_ID_ARBITRUM) {
      await window.ethereum.request({ method: "wallet_switchEthereumChain", params:[{ chainId:"0xa4b1" }]});
    }
    signer = await provider.getSigner();
    acct = await signer.getAddress();
    addrEl.textContent = trunc(acct);

    lending = new ethers.Contract(LENDING_ADDR, LENDING_ABI, signer);
    const [usdcAddr, mtyldAddr, vaultAddr] = await Promise.all([lending.USDC(), lending.MTYLD(), lending.MTYLD_VAULT()]);
    tripletEl.textContent = `${usdcAddr} / ${mtyldAddr} / ${vaultAddr}`;
    USDC  = new ethers.Contract(usdcAddr, ERC20_ABI, signer);
    MTYLD = new ethers.Contract(mtyldAddr, ERC20_ABI, signer);
  }

  async function refresh(){
    try{
      const readProv = provider || new ethers.JsonRpcProvider("https://arb1.arbitrum.io/rpc");
      const read = new ethers.Contract(LENDING_ADDR, LENDING_ABI, readProv);
      const [usdcAddr, mtyldAddr, vaultAddr] = await Promise.all([ read.USDC(), read.MTYLD(), read.MTYLD_VAULT() ]);
      tripletEl.textContent = `${usdcAddr} / ${mtyldAddr} / ${vaultAddr}`;

      // NAV / price
      const readVault = new ethers.Contract(vaultAddr, ["function pricePerToken() view returns (uint256)"], readProv);
      const price18 = await readVault.pricePerToken();
      mtyldPriceEl.textContent = "$" + (Number(price18)/1e18).toFixed(6);

      if (signer) {
        const a = acct || await signer.getAddress();
        // token balances
        const USDC_r = new ethers.Contract(usdcAddr, ERC20_ABI, readProv);
        const MTYLD_r= new ethers.Contract(mtyldAddr, ERC20_ABI, readProv);
        const [bu,bm] = await Promise.all([USDC_r.balanceOf(a), MTYLD_r.balanceOf(a)]);
        balUsdcEl.textContent  = fmt6(bu).toFixed(2) + " USDC";
        balMtyldEl.textContent = fmt18(bm).toFixed(4) + " MTYLD";

        // user view
        const V = await read.userView(a);
        userColMtyld.textContent = (Number(V.collateralMTYLD_18)/1e18).toFixed(4) + " MTYLD";
        userColUsd.textContent    = usd(Number(V.collateralUSD_18)/1e18);
        const debtUSDC = (Number(V.principalUSDC_6)+Number(V.interestUSDC_6)+Number(V.lateFeesUSDC_6))/1e6;
        userDebtUsdc.textContent  = debtUSDC.toFixed(2) + " USDC";
        userDebtUsd.textContent   = usd(Number(V.debtUSD_18)/1e18);
        userInterestLate.textContent = (Number(V.interestUSDC_6)/1e6 + Number(V.lateFeesUSDC_6)/1e6).toFixed(2) + " USDC";
        userScore.textContent     = String(V.creditScore || 0);
        userMaturity.textContent  = V.maturity ? new Date(Number(V.maturity)*1000).toLocaleString() : "—";
        ltvLine.textContent       = (Number(V.ltvBps)/100).toFixed(2) + "%";
      }
    }catch(e){ console.error(e); alert("Refresh failed: "+shortErr(e)); }
  }

  // ===== Max helpers =====
  depMax.onclick = async () => {
    try{
      if (!signer || !MTYLD) return;
      const bal = await MTYLD.balanceOf(acct);
      depAmt.value = (Number(bal)/1e18).toFixed(4);
    }catch{}
  };
  wdMax.onclick = async () => {
    try{
      if (!provider) await ensure();
      const V = await lending.userView(acct);
      wdAmt.value = (Number(V.collateralMTYLD_18)/1e18).toFixed(4);
    }catch{}
  };
  rpMax.onclick = async () => {
    try{
      if (!provider) await ensure();
      const V = await lending.userView(acct);
      const debt = (Number(V.principalUSDC_6)+Number(V.interestUSDC_6)+Number(V.lateFeesUSDC_6))/1e6;
      rpAmt.value = debt.toFixed(2);
    }catch{}
  };

  // ===== Actions =====
  btnDeposit.onclick = async () => {
    try{
      depMsg.textContent = "";
      if (!provider) await ensure();
      const a = to18(depAmt.value);
      if (a <= 0n) { depMsg.textContent = "Enter amount"; return; }
      const allowance = await MTYLD.allowance(acct, LENDING_ADDR);
      if (allowance < a) { const txa = await MTYLD.approve(LENDING_ADDR, a); await txa.wait(); }
      const tx = await lending.depositCollateral(a); await tx.wait();
      depMsg.textContent = "Deposited ✅"; await refresh();
    }catch(e){ console.error(e); depMsg.textContent = shortErr(e); }
  };

  btnWithdraw.onclick = async () => {
    try{
      wdMsg.textContent = "";
      if (!provider) await ensure();
      const a = to18(wdAmt.value);
      if (a <= 0n) { wdMsg.textContent = "Enter amount"; return; }
      const tx = await lending.withdrawCollateral(a); await tx.wait();
      wdMsg.textContent = "Withdrawn ✅"; await refresh();
    }catch(e){ console.error(e); wdMsg.textContent = shortErr(e); }
  };

  btnBorrow.onclick = async () => {
    try{
      brMsg.textContent = "";
      if (!provider) await ensure();
      const amt = to6(brAmt.value);
      const days = Math.floor(Number(brDays.value || "0"));
      if (amt <= 0n || !(days>0)) { brMsg.textContent = "Enter amount & days"; return; }
      const maturity = BigInt(Math.floor(Date.now()/1000) + days*24*3600);
      const tx = await lending.borrow(amt, maturity); await tx.wait();
      brMsg.textContent = "Borrowed ✅"; await refresh();
    }catch(e){ console.error(e); brMsg.textContent = shortErr(e); }
  };

  btnRepay.onclick = async () => {
    try{
      rpMsg.textContent = "";
      if (!provider) await ensure();
      const amt = to6(rpAmt.value);
      if (amt <= 0n) { rpMsg.textContent = "Enter amount"; return; }
      const allowance = await USDC.allowance(acct, LENDING_ADDR);
      if (allowance < amt) { const txa = await USDC.approve(LENDING_ADDR, amt); await txa.wait(); }
      const tx = await lending.repay(amt); await tx.wait();
      rpMsg.textContent = "Repaid ✅"; await refresh();
    }catch(e){ console.error(e); rpMsg.textContent = shortErr(e); }
  };

  // Connect + refresh
  document.getElementById("btnConnect").onclick = async () => { try { await ensure(); await refresh(); } catch(e){ console.error(e);} };
  document.getElementById("btnRefresh").onclick = async () => { await refresh(); };

  // === ADMIN ELEMENTS ===
  const adminCard = document.getElementById("adminCard");
  const roleBadge = document.getElementById("roleBadge");
  const adminRoleLine = document.getElementById("adminRoleLine");
  const pausedLine = document.getElementById("pausedLine");
  const liqPausedLine = document.getElementById("liqPausedLine");
  const btnPause = document.getElementById("btnPause");
  const btnUnpause = document.getElementById("btnUnpause");
  const chkLiqPaused = document.getElementById("chkLiqPaused");
  const btnSetLiqPaused = document.getElementById("btnSetLiqPaused");
  const sysMsg = document.getElementById("sysMsg");

  const inApr = document.getElementById("inApr");
  const inMaxLtv = document.getElementById("inMaxLtv");
  const inLiqThresh = document.getElementById("inLiqThresh");
  const inLiqBonus = document.getElementById("inLiqBonus");
  const btnSetParams = document.getElementById("btnSetParams");
  const inLateBps = document.getElementById("inLateBps");
  const btnSetLate = document.getElementById("btnSetLate");
  const paramMsg = document.getElementById("paramMsg");

  const inSevThresh = document.getElementById("inSevThresh");
  const inSevBonus  = document.getElementById("inSevBonus");
  const chkSevPublic= document.getElementById("chkSevPublic");
  const btnSetSevere= document.getElementById("btnSetSevere");
  const sevMsg      = document.getElementById("sevMsg");

  const inTreasury = document.getElementById("inTreasury");
  const inRate     = document.getElementById("inRate");
  const inRisk     = document.getElementById("inRisk");
  const btnSetRoles= document.getElementById("btnSetRoles");
  const rolesMsg   = document.getElementById("rolesMsg");

  const inWLUser = document.getElementById("inWLUser");
  const chkWL    = document.getElementById("chkWL");
  const btnSetWL = document.getElementById("btnSetWL");
  const wlMsg    = document.getElementById("wlMsg");

  const inUserCredit = document.getElementById("inUserCredit");
  const inCredit     = document.getElementById("inCredit");
  const btnSetCredit = document.getElementById("btnSetCredit");
  const creditMsg    = document.getElementById("creditMsg");

  const readParams = document.getElementById("readParams");
  const readSevere = document.getElementById("readSevere");
  const readLate   = document.getElementById("readLate");
  const readRoles  = document.getElementById("readRoles");

  const toU16 = (x) => {
    const n = Math.floor(Number(x||"0"));
    if (n < 0 || n > 65535) throw new Error("bps out of range");
    return n;
  };

  let _owner, _rateG, _riskG, _treasury;

  async function loadParams() {
    if (!lending) return;
    const [apr, maxLTV, liqTh, liqBo, sevTh, sevBo, sevPub, late, paused, liqPaused, owner, rateG, riskG, treas] =
      await Promise.all([
        lending.aprBps(),
        lending.maxLtvBps(),
        lending.liqThresholdBps(),
        lending.liqBonusBps(),
        lending.severeLiqThresholdBps(),
        lending.severeLiqBonusBps(),
        lending.severePublic(),
        lending.lateFeeBpsFlat(),
        lending.paused(),
        lending.liquidationPaused(),
        lending.owner(),
        lending.rateGuardian(),
        lending.riskGuardian(),
        lending.treasury(),
      ]);

    // Readouts
    readParams.textContent = `Params: APR ${apr} • MaxLTV ${maxLTV} • LiqThresh ${liqTh} • LiqBonus ${liqBo}`;
    readSevere.textContent = `Severe: Thresh ${sevTh} • Bonus ${sevBo} • Public ${sevPub ? "Yes" : "No"}`;
    readLate.textContent   = `Late Fee: ${late} bps`;
    readRoles.textContent  = `Roles → owner: ${owner} • treasury: ${treas} • rate: ${rateG} • risk: ${riskG}`;

    // Prefill inputs
    inApr.value = Number(apr); inMaxLtv.value = Number(maxLTV);
    inLiqThresh.value = Number(liqTh); inLiqBonus.value = Number(liqBo);
    inSevThresh.value = Number(sevTh); inSevBonus.value = Number(sevBo);
    chkSevPublic.checked = Boolean(sevPub);
    inLateBps.value = Number(late);

    pausedLine.textContent = `Paused: ${paused ? "Yes" : "No"}`;
    liqPausedLine.textContent = `Liquidations Paused: ${liqPaused ? "Yes" : "No"}`;
    chkLiqPaused.checked = Boolean(liqPaused);

    _owner = owner; _rateG = rateG; _riskG = riskG; _treasury = treas;
  }

  function isAdminAddress(a) {
    if (!a) return false;
    const x = a.toLowerCase();
    return x === _owner?.toLowerCase() || x === _rateG?.toLowerCase() || x === _riskG?.toLowerCase();
  }

  async function checkRolesAndGate() {
    try {
      await loadParams();
      const role =
        acct?.toLowerCase() === _owner?.toLowerCase() ? "Owner" :
        acct?.toLowerCase() === _rateG?.toLowerCase() ? "Rate Guardian" :
        acct?.toLowerCase() === _riskG?.toLowerCase() ? "Risk Guardian" : null;

      if (role) {
        adminCard.classList.remove("hidden");
        roleBadge?.classList.remove("hidden");
        adminRoleLine.textContent = `Role: ${role}`;
      } else {
        adminCard.classList.add("hidden");
        roleBadge?.classList.add("hidden");
        adminRoleLine.textContent = "Role: —";
      }
    } catch (e) {
      console.error(e);
    }
  }

  // Wrap ensure() and refresh() to include admin checks
  const _ensureOriginal = ensure;
  ensure = async function() {
    await _ensureOriginal();
    await checkRolesAndGate();
  };

  const _refreshOriginal = refresh;
  refresh = async function() {
    await _refreshOriginal();
    if (lending) await loadParams();
  };

  // === Admin actions ===
  btnPause?.addEventListener("click", async () => {
    try { sysMsg.textContent = ""; const tx = await lending.pause(); await tx.wait(); sysMsg.textContent = "Paused ✅"; await refresh(); }
    catch(e){ sysMsg.textContent = shortErr(e); }
  });

  btnUnpause?.addEventListener("click", async () => {
    try { sysMsg.textContent = ""; const tx = await lending.unpause(); await tx.wait(); sysMsg.textContent = "Unpaused ✅"; await refresh(); }
    catch(e){ sysMsg.textContent = shortErr(e); }
  });

  btnSetLiqPaused?.addEventListener("click", async () => {
    try { sysMsg.textContent = ""; const tx = await lending.setLiquidationPaused(Boolean(chkLiqPaused.checked)); await tx.wait(); sysMsg.textContent = "Updated ✅"; await refresh(); }
    catch(e){ sysMsg.textContent = shortErr(e); }
  });

  btnSetParams?.addEventListener("click", async () => {
    try {
      paramMsg.textContent = "";
      const tx = await lending.setParams(
        toU16(inApr.value),
        toU16(inMaxLtv.value),
        toU16(inLiqThresh.value),
        toU16(inLiqBonus.value)
      );
      await tx.wait(); paramMsg.textContent = "Params updated ✅"; await refresh();
    } catch(e){ paramMsg.textContent = shortErr(e); }
  });

  btnSetLate?.addEventListener("click", async () => {
    try {
      paramMsg.textContent = "";
      const tx = await lending.setLateFeeBps(toU16(inLateBps.value));
      await tx.wait(); paramMsg.textContent = "Late fee updated ✅"; await refresh();
    } catch(e){ paramMsg.textContent = shortErr(e); }
  });

  btnSetSevere?.addEventListener("click", async () => {
    try {
      sevMsg.textContent = "";
      const tx = await lending.setSevereParams(
        toU16(inSevThresh.value),
        toU16(inSevBonus.value),
        Boolean(chkSevPublic.checked)
      );
      await tx.wait(); sevMsg.textContent = "Severe params updated ✅"; await refresh();
    } catch(e){ sevMsg.textContent = shortErr(e); }
  });

  btnSetRoles?.addEventListener("click", async () => {
    try {
      rolesMsg.textContent = "";
      const tx = await lending.setRoles(inTreasury.value, inRate.value, inRisk.value);
      await tx.wait(); rolesMsg.textContent = "Roles updated ✅"; await refresh();
    } catch(e){ rolesMsg.textContent = shortErr(e); }
  });

  btnSetWL?.addEventListener("click", async () => {
    try {
      wlMsg.textContent = "";
      const tx = await lending.setWhitelist(inWLUser.value, Boolean(chkWL.checked));
      await tx.wait(); wlMsg.textContent = "Whitelist set ✅"; await refresh();
    } catch(e){ wlMsg.textContent = shortErr(e); }
  });

  btnSetCredit?.addEventListener("click", async () => {
    try {
      creditMsg.textContent = "";
      const n = Math.floor(Number(inCredit.value||"0"));
      if (n < 0 || n > 0xFFFFFFFF) throw new Error("score out of range");
      const tx = await lending.adminSetCredit(inUserCredit.value, n);
      await tx.wait(); creditMsg.textContent = "Credit set ✅"; await refresh();
    } catch(e){ creditMsg.textContent = shortErr(e); }
  });

  // First paint (read-only)
  await refresh();
})();
</script>
</body>
</html>
