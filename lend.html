<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTYLD Credit Line • Mechanical Temp</title>

  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <style>
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">

  <!-- Header (match Vault aesthetics) -->
  <header class="sticky top-0 z-30 bg-slate-900/80 backdrop-blur border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="https://www.mechanicaltemp.com" class="flex items-center gap-3">
        <img src="https://i.imgur.com/YJvJw7V.png" class="h-10 w-auto" alt="Mechanical Temp">
        <span class="font-bold tracking-wide text-slate-200 hidden sm:inline">MTYLD • Credit Line</span>
      </a>
      <nav class="flex items-center gap-2">
        <a href="https://vault.mechanicaltemp.com" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">Vault Home</a>
        <a href="lend.html" class="px-3 py-2 rounded-lg bg-sky-600/20 text-sky-200 border border-sky-700/30">Credit Line</a>
        <button id="btnRefresh" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">↻</button>
        <button id="btnConnect" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Connect</button>
      </nav>
    </div>
  </header>

  <!-- Banner -->
  <section class="bg-gradient-to-b from-slate-900 to-sky-900 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-10 text-center">
      <h1 class="text-4xl sm:text-5xl font-black tracking-tight text-white">MTYLD Credit Line</h1>
      <p class="mt-3 text-sky-200">Borrow USDC against MTYLD collateral on Arbitrum One</p>
    </div>
  </section>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-4">

    <!-- WL banner -->
    <div id="wlBanner" class="hidden p-3 rounded-xl bg-amber-500/10 border border-amber-500/30 text-amber-200">
      This wallet isn’t whitelisted yet. Ask the owner <span class="font-mono text-amber-300">0xcfe0…557a</span> (or guardians) to allow it.
    </div>

    <!-- Connected + Contracts -->
    <div class="grid md:grid-cols-3 gap-4 items-start">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 h-full">
        <div class="text-xs text-slate-500">Connected</div>
        <div id="addr" class="font-mono text-slate-300 truncate">Not connected</div>

        <div class="mt-2 text-xs text-slate-500">Credit Contract</div>
        <div class="font-mono text-slate-300 truncate">0x8fC8b61882e4792c1fB4Ea128b55c90c3069f027</div>

        <div class="mt-2 text-xs text-slate-500">USDC / MTYLD / MTYLD Vault</div>
        <div id="tokenTriplet" class="font-mono text-slate-300 text-xs break-all">—</div>

        <div class="mt-3 text-xs text-slate-500">Your role</div>
        <div id="roleLine" class="font-mono text-slate-300 text-xs">—</div>
      </div>

      <!-- Tiles -->
      <div class="md:col-span-2 bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">MTYLD Price (USD)</div>
            <div id="mtyldPrice" class="font-mono text-lg">$–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Your MTYLD</div>
            <div id="balMtyld" class="font-mono text-lg">–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Your USDC</div>
            <div id="balUsdc" class="font-mono text-lg">–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Health (LTV)</div>
            <div id="ltvLine" class="font-mono text-lg">–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Pool/Treasury USDC</div>
            <div id="poolUsdc" class="font-mono text-lg">$–</div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Stats -->
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Collateral (MTYLD)</div>
          <div class="font-mono text-lg" id="userColMtyld">–</div>
          <div class="text-slate-400 text-xs" id="userColUsd">USD –</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Debt (USDC)</div>
          <div class="font-mono text-lg" id="userDebtUsdc">–</div>
          <div class="text-slate-400 text-xs" id="userDebtUsd">USD –</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Interest + Late</div>
          <div class="font-mono text-lg" id="userInterestLate">–</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Credit Score</div>
          <div class="font-mono text-lg" id="userScore">–</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Maturity</div>
          <div class="font-mono text-lg" id="userMaturity">–</div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="grid md:grid-cols-2 gap-4">
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 font-semibold">Collateral: MTYLD</div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <div class="text-slate-400 text-xs mb-1">Deposit MTYLD</div>
            <div class="flex gap-2">
              <input id="depAmt" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="depMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnDeposit" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Approve & Deposit</button>
            <div id="depMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>

          <div>
            <div class="text-slate-400 text-xs mb-1">Withdraw MTYLD</div>
            <div class="flex gap-2">
              <input id="wdAmt" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="wdMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnWithdraw" class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Withdraw</button>
            <div id="wdMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>
        </div>
      </div>

      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 font-semibold">Borrow / Repay (USDC)</div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <div class="text-slate-400 text-xs mb-1">Borrow USDC</div>
            <input id="brAmt" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
            <div class="flex gap-2 mt-2">
              <input id="brDays" inputmode="numeric" placeholder="Maturity (days)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="btnBorrow" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Borrow</button>
            </div>
            <div id="brMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>

          <div>
            <div class="text-slate-400 text-xs mb-1">Repay USDC</div>
            <div class="flex gap-2">
              <input id="rpAmt" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="rpMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnRepay" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Approve & Repay</button>
            <div id="rpMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin panel (owner / guardians) -->
    <div id="adminPanel" class="hidden bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="font-semibold">Admin Panel</div>
        <div id="adminRolePill" class="text-xs px-2 py-1 rounded-full bg-slate-800 text-slate-300">—</div>
      </div>
      <div class="h-px bg-slate-800 my-3"></div>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <div class="text-slate-300">Whitelist Address</div>
          <input id="wlAddr" placeholder="0x…" class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
          <div class="mt-2 flex items-center gap-2">
            <button id="btnWhitelistOn"  class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Allow</button>
            <button id="btnWhitelistOff" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Remove</button>
          </div>
          <div id="wlMsg" class="text-slate-400 font-mono mt-2">—</div>
        </div>

        <div>
          <div class="text-slate-300">Liquidation Toggle</div>
          <div class="mt-2 flex items-center gap-2">
            <button id="btnPauseLiq"  class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Pause</button>
            <button id="btnUnpauseLiq" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Unpause</button>
          </div>
          <div id="liqState" class="text-slate-400 font-mono mt-2">—</div>
        </div>
      </div>

      <p class="mt-3 text-sm text-slate-400">
        Admin = owner or designated guardians. If users see “Not whitelisted”, add them here.
      </p>
    </div>

    <p class="text-xs text-slate-500">Arbitrum One • MTYLD Credit Line UI</p>
  </main>

  <!-- Footer -->
  <footer class="mt-10 border-t border-slate-800 bg-slate-900">
    <div class="max-w-7xl mx-auto px-4 py-8 text-center">
      <p class="text-slate-300">
        Powered by <a href="https://www.mechanicaltemp.com" class="text-sky-400 hover:text-sky-300 font-semibold">Mechanical Temp</a>
        <span class="text-slate-500">•</span> Southfield, MI
      </p>
      <p class="mt-2 text-xs text-slate-500">© <span id="yr"></span> Mechanical Temp • All Rights Reserved</p>
    </div>
  </footer>

<script>
const CHAIN_ID_ARBITRUM = 42161;
const LENDING_ADDR       = "0x8fC8b61882e4792c1fB4Ea128b55c90c3069f027";

// ===== ABI (from your contract) =====
const LENDING_ABI = [{"inputs":[{"internalType":"address","name":"usdc","type":"address"},{"internalType":"address","name":"mtyld","type":"address"},{"internalType":"address","name":"mtyldVault","type":"address"},{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"BadAddress","type":"error"},{"inputs":[],"name":"BadAmount","type":"error"},{"inputs":[],"name":"Healthy","type":"error"},{"inputs":[],"name":"NotActive","type":"error"},{"inputs":[],"name":"NotOwnerGuardian","type":"error"},{"inputs":[],"name":"NotSevere","type":"error"},{"inputs":[],"name":"NotWhitelisted","type":"error"},{"inputs":[],"name":"OverLTV","type":"error"},{"inputs":[],"name":"Slippage","type":"error"},{"inputs":[],"name":"TooEarly","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"interestAccrued_6","type":"uint256"},{"indexed":false,"internalType":"bool","name":"lateFeeApplied","type":"bool"}],"name":"Accrued","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"usdcAmount_6","type":"uint256"},{"indexed":false,"internalType":"uint64","name":"start","type":"uint64"},{"indexed":false,"internalType":"uint64","name":"maturity","type":"uint64"}],"name":"Borrowed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount_18","type":"uint256"}],"name":"CollateralDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount_18","type":"uint256"}],"name":"CollateralWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"lateFeeBpsFlat","type":"uint16"}],"name":"LateFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"liquidator","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"repayUSDC_6","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seizeMTYLD_18","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"price18","type":"uint256"},{"indexed":false,"internalType":"uint16","name":"bonusBps","type":"uint16"},{"indexed":false,"internalType":"bool","name":"severe","type":"bool"}],"name":"Liquidated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"on","type":"bool"}],"name":"LiquidationPaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"prev","type":"address"},{"indexed":true,"internalType":"address","name":"next","type
