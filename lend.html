<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MTYLD Credit Line • Mechanical Temp</title>

  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

  <style>
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-slate-900/80 backdrop-blur border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="https://www.mechanicaltemp.com" class="flex items-center gap-3">
        <img src="https://i.imgur.com/YJvJw7V.png" alt="Mechanical Temp" class="h-10 w-auto">
        <span class="font-bold tracking-wide text-slate-200 hidden sm:inline"></span>
      </a>
      <nav class="flex items-center gap-2">
        <a href="lend.html" class="px-3 py-2 rounded-lg text-white bg-slate-800">Credit Line</a>
        <a href="https://vault.mechanicaltemp.com" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">Vault Home</a>
        <button id="btnAbout" class="px-3 py-2 rounded-lg text-slate-300 hover:text-white hover:bg-slate-800">About</button>
      </nav>
    </div>
  </header>

  <!-- Banner -->
  <section class="bg-gradient-to-b from-slate-900 to-sky-900 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-12 sm:py-16 text-center">
      <h1 class="mt-1 text-4xl sm:text-5xl md:text-6xl font-black tracking-tight text-white">
        MTYLD Credit Line
      </h1>
      <p class="mt-3 md:mt-4 text-base md:text-lg text-sky-200">
        Borrow USDC against <span class="font-semibold text-sky-100">MTYLD</span> collateral
      </p>
    </div>
  </section>

  <!-- App -->
  <main class="max-w-7xl mx-auto px-4 py-8 space-y-4">
    <!-- Wallet + Quick Stats -->
    <div class="grid md:grid-cols-3 gap-4 items-start">
      <!-- Wallet -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 h-full">
        <div class="flex items-center gap-2 mb-3">
          <button id="btnConnect" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Connect</button>
          <button id="btnRefresh" class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">↻</button>
        </div>
        <div class="text-slate-400 font-mono text-sm truncate" id="addr">Not connected</div>
        <div class="mt-2 text-xs text-slate-500">Credit Contract</div>
        <div class="font-mono text-slate-300 truncate text-sm">0x8fC8b61882e4792c1fB4Ea128b55c90c3069f027</div>
        <div class="mt-2 text-xs text-slate-500">USDC / MTYLD / MTYLD Vault</div>
        <div id="tokenTriplet" class="font-mono text-slate-300 text-xs break-all">—</div>
      </div>

      <!-- Protocol Stats -->
      <div class="md:col-span-2 bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">MTYLD Price (USD)</div>
            <div id="mtyldPrice" class="font-mono text-lg">$–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Your MTYLD</div>
            <div id="balMtyld" class="font-mono text-lg">–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Your USDC</div>
            <div id="balUsdc" class="font-mono text-lg">–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Health (LTV)</div>
            <div id="ltvLine" class="font-mono text-lg">–</div>
          </div>
          <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
            <div class="text-slate-400 text-xs">Treasury Balance (USDC)</div>
            <div id="treasuryBal" class="font-mono text-lg">—</div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Position -->
    <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
      <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Collateral (MTYLD)</div>
          <div class="font-mono text-lg" id="userColMtyld">–</div>
          <div class="text-slate-400 text-xs" id="userColUsd">USD –</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Debt (USDC)</div>
          <div class="font-mono text-lg" id="userDebtUsdc">–</div>
          <div class="text-slate-400 text-xs" id="userDebtUsd">USD –</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Interest + Late</div>
          <div class="font-mono text-lg" id="userInterestLate">–</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Credit Score</div>
          <div class="font-mono text-lg" id="userScore">–</div>
        </div>
        <div class="p-2 rounded-lg bg-slate-800/40 border border-slate-700/50">
          <div class="text-slate-400 text-xs">Maturity</div>
          <div class="font-mono text-lg" id="userMaturity">–</div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="grid md:grid-cols-2 gap-4">
      <!-- Collateral -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 font-semibold">Collateral: MTYLD</div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <div class="text-slate-400 text-xs mb-1">Deposit MTYLD</div>
            <div class="flex gap-2">
              <input id="depAmt" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="depMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnDeposit" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Approve & Deposit</button>
            <div id="depMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>

          <div>
            <div class="text-slate-400 text-xs mb-1">Withdraw MTYLD</div>
            <div class="flex gap-2">
              <input id="wdAmt" inputmode="decimal" placeholder="Amount (MTYLD)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="wdMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnWithdraw" class="mt-2 w-full px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-100">Withdraw</button>
            <div id="wdMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>
        </div>
      </div>

      <!-- Borrow / Repay -->
      <div class="bg-slate-900 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 font-semibold">Borrow / Repay (USDC)</div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div>
            <div class="text-slate-400 text-xs mb-1">Borrow USDC</div>
            <input id="brAmt" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
            <div class="flex gap-2 mt-2">
              <input id="brDays" inputmode="numeric" placeholder="Maturity (days)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="btnBorrow" class="px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Borrow</button>
            </div>
            <div id="brMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>

          <div>
            <div class="text-slate-400 text-xs mb-1">Repay USDC</div>
            <div class="flex gap-2">
              <input id="rpAmt" inputmode="decimal" placeholder="Amount (USDC)" class="w-full px-3 py-2 rounded-lg bg-slate-800 border border-slate-700 text-slate-100 placeholder-slate-400">
              <button id="rpMax" class="px-3 rounded-lg bg-slate-800 border border-slate-700">Max</button>
            </div>
            <button id="btnRepay" class="mt-2 w-full px-3 py-2 rounded-lg bg-sky-500 hover:bg-sky-600 text-white font-semibold">Approve & Repay</button>
            <div id="rpMsg" class="text-sm text-slate-400 mt-1">—</div>
          </div>
        </div>
      </div>
    </div>

    <p class="text-xs text-slate-500">Arbitrum One • MTYLD Credit Line UI</p>
  </main>

  <!-- About: Credit Line (Collapsible) -->
  <section id="aboutCredit" class="bg-slate-950 border-t border-slate-800 py-12 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-8">
        <h2 class="text-3xl sm:text-4xl font-black text-white">About the MTYLD Credit Line</h2>
        <p class="mt-2 text-sky-300 text-lg">Borrow USDC using MTYLD as collateral</p>
      </div>

      <div class="space-y-3">
        <!-- What it is -->
        <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
            <span class="text-sky-300 font-semibold">🏦 What is the Credit Line?</span>
            <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
            </svg>
          </summary>
          <div class="px-5 pb-5 text-slate-300 leading-relaxed">
            <p>The MTYLD Credit Line lets you deposit <strong>MTYLD</strong> as collateral and borrow <strong>USDC</strong>.
              Your loan health is tracked by Loan-to-Value (LTV). Stay under the liquidation thresholds to remain safe.</p>
          </div>
        </details>

        <!-- Collateral & LTV -->
        <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
            <span class="text-sky-300 font-semibold">🛡️ Collateral & LTV</span>
            <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
            </svg>
          </summary>
          <div class="px-5 pb-5 text-slate-300">
            <ul class="list-disc pl-5 space-y-2">
              <li>Deposit MTYLD as collateral; its <em>USD value</em> is derived from MTYLD Vault price (NAV).</li>
              <li>LTV (health) = Debt ÷ Collateral Value. Keep it below the max LTV to avoid liquidation.</li>
              <li>Withdrawals reduce collateral and can raise LTV; borrowings increase debt and LTV.</li>
            </ul>
          </div>
        </details>

        <!-- Borrow & Repay -->
        <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
            <span class="text-sky-300 font-semibold">💸 Borrowing & Repayment</span>
            <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
            </svg>
          </summary>
          <div class="px-5 pb-5 text-slate-300">
            <ol class="list-decimal pl-5 space-y-2">
              <li><strong>Borrow:</strong> Choose USDC amount and maturity (days). APR applies over time.</li>
              <li><strong>Repay:</strong> Approve USDC then repay any amount up to total due (principal + interest + late fees).</li>
              <li><strong>Max buttons</strong> help set your available deposit/repay/withdraw quickly.</li>
            </ol>
          </div>
        </details>

        <!-- Interest, Late & Score -->
        <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
            <span class="text-sky-300 font-semibold">⏱️ Interest, Late Fees & Credit Score</span>
            <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
            </svg>
          </summary>
          <div class="px-5 pb-5 text-slate-300">
            <ul class="list-disc pl-5 space-y-2">
              <li><strong>APR</strong> accrues on outstanding principal.</li>
              <li><strong>Late fee</strong> may apply after maturity; both are shown in the panel.</li>
              <li><strong>Credit score</strong> (if enabled) can be used by admins for risk settings.</li>
            </ul>
          </div>
        </details>

        <!-- Liquidations -->
        <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
            <span class="text-sky-300 font-semibold">⚠️ Liquidations</span>
            <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
            </svg>
          </summary>
          <div class="px-5 pb-5 text-slate-300">
            <p>If LTV exceeds thresholds, liquidators can repay your debt and seize a portion of MTYLD collateral at a bonus.
              “Severe” parameters (if enabled) may apply in extreme conditions.</p>
          </div>
        </details>

        <!-- Where USDC comes from -->
        <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
            <span class="text-sky-300 font-semibold">🏦 Where does the borrowed USDC come from?</span>
            <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
            </svg>
          </summary>
          <div class="px-5 pb-5 text-slate-300">
            <p>USDC liquidity is supplied by the protocol treasury (funded by Mechanical Temp revenue and/or DAO allocations).
              The <strong>Treasury Balance</strong> tile shows current available USDC tracked by the lending contract.</p>
          </div>
        </details>

        <!-- Transparency -->
        <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
            <span class="text-sky-300 font-semibold">📊 Transparency & Addresses</span>
            <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
            </svg>
          </summary>
          <div class="px-5 pb-5 font-mono text-sm text-slate-300 space-y-2">
            <div>Lending Contract:
              <a class="text-sky-400 hover:text-sky-300" href="https://arbiscan.io/address/0x8fC8b61882e4792c1fB4Ea128b55c90c3069f027">0x8fC8…f027</a>
            </div>
            <div>MTYLD Vault:
              <a class="text-sky-400 hover:text-sky-300" href="https://arbiscan.io/address/0xed33364f71275E8EA06a85a363Ec5C5a6c9AB880">0xed33…B880</a>
            </div>
            <div>USDC (Arbitrum):
              <a class="text-sky-400 hover:text-sky-300" href="https://arbiscan.io/token/0xaf88d065e77c8cC2239327C5EDb3A432268e5831">0xaf88…5831</a>
            </div>
            <div>Owner (DAO Treasury): <span class="text-sky-300">0xcfe077e6f7554B1724546E02624a0832D1f4557a</span></div>
          </div>
        </details>

        <!-- Risks -->
        <details class="group bg-slate-900/80 border border-slate-800 rounded-2xl">
          <summary class="flex items-center justify-between gap-3 px-5 py-4 cursor-pointer select-none">
            <span class="text-sky-300 font-semibold">⚠️ Risks & Disclosures</span>
            <svg class="w-5 h-5 text-slate-400 transition-transform group-open:rotate-180" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06L10.53 12.6a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd"/>
            </svg>
          </summary>
          <div class="px-5 pb-5 text-slate-300">
            <ul class="list-disc pl-5 space-y-2">
              <li>Borrow responsibly; liquidation risk exists if LTV rises.</li>
              <li>Smart contract and operator risks exist.</li>
              <li>Always verify official contract addresses.</li>
            </ul>
          </div>
        </details>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="mt-10 border-t border-slate-800 bg-slate-900">
    <div class="max-w-7xl mx-auto px-4 py-8 text-center">
      <p class="text-slate-300">
        Powered by <a href="https://www.mechanicaltemp.com" class="text-sky-400 hover:text-sky-300 font-semibold">Mechanical Temp</a>
        <span class="text-slate-500">•</span> Southfield, MI
      </p>
      <p class="mt-2 text-xs text-slate-500">© <span id="yr"></span> Mechanical Temp • All Rights Reserved</p>
    </div>
  </footer>

  <!-- App Script (your existing logic, lightly organized) -->
  <script>
  // Footer year
  document.getElementById('yr').textContent = new Date().getFullYear();

  // Smooth scroll + auto-expand About
  const aboutBtn = document.getElementById("btnAbout");
  const aboutSection = document.querySelector("#aboutCredit");
  if (aboutBtn && aboutSection) {
    aboutBtn.addEventListener("click", () => {
      aboutSection.scrollIntoView({ behavior: "smooth", block: "start" });
      aboutSection.querySelectorAll("details").forEach(d => d.open = true);
    });
  }

  const CHAIN_ID_ARBITRUM = 42161;
  const LENDING_ADDR = "0x8fC8b61882e4792c1fB4Ea128b55c90c3069f027";

  // ===== ABI (exactly what you supplied) =====
  const LENDING_ABI = [{"inputs":[{"internalType":"address","name":"usdc","type":"address"},{"internalType":"address","name":"mtyld","type":"address"},{"internalType":"address","name":"mtyldVault","type":"address"},{"internalType":"address","name":"_treasury","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"BadAddress","type":"error"},{"inputs":[],"name":"BadAmount","type":"error"},{"inputs":[],"name":"Healthy","type":"error"},{"inputs":[],"name":"NotActive","type":"error"},{"inputs":[],"name":"NotOwnerGuardian","type":"error"},{"inputs":[],"name":"NotSevere","type":"error"},{"inputs":[],"name":"NotWhitelisted","type":"error"},{"inputs":[],"name":"OverLTV","type":"error"},{"inputs":[],"name":"Slippage","type":"error"},{"inputs":[],"name":"TooEarly","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"interestAccrued_6","type":"uint256"},{"indexed":false,"internalType":"bool","name":"lateFeeApplied","type":"bool"}],"name":"Accrued","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"usdcAmount_6","type":"uint256"},{"indexed":false,"internalType":"uint64","name":"start","type":"uint64"},{"indexed":false,"internalType":"uint64","name":"maturity","type":"uint64"}],"name":"Borrowed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount_18","type":"uint256"}],"name":"CollateralDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount_18","type":"uint256"}],"name":"CollateralWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"lateFeeBpsFlat","type":"uint16"}],"name":"LateFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"liquidator","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"repayUSDC_6","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"seizeMTYLD_18","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"price18","type":"uint256"},{"indexed":false,"internalType":"uint16","name":"bonusBps","type":"uint16"},{"indexed":false,"internalType":"bool","name":"severe","type":"bool"}],"name":"Liquidated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bool","name":"on","type":"bool"}],"name":"LiquidationPaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"prev","type":"address"},{"indexed":true,"internalType":"address","name":"next","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"aprBps","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"maxLtvBps","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"liqThresholdBps","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"liqBonusBps","type":"uint16"}],"name":"ParamsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"by","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"repaidUSDC_6","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"principalLeft_6","type":"uint256"}],"name":"Repaid","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"treasury","type":"address"},{"indexed":false,"internalType":"address","name":"rateGuardian","type":"address"},{"indexed":false,"internalType":"address","name":"riskGuardian","type":"address"}],"name":"RolesUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint16","name":"severeLiqThresholdBps","type":"uint16"},{"indexed":false,"internalType":"uint16","name":"severeLiqBonusBps","type":"uint16"},{"indexed":false,"internalType":"bool","name":"severePublic","type":"bool"}],"name":"SevereParamsUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"residualMTYLD_18","type":"uint256"}],"name":"SevereResidualSent","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"by","type":"address"}],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"allowed","type":"bool"}],"name":"WhitelistSet","type":"event"},{"inputs":[],"name":"APR_MAX_BPS","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"BPS_DENOMINATOR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BPS_U16","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MTYLD","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MTYLD_VAULT","outputs":[{"internalType":"contract IMTYLDVault","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"SECONDS_PER_YEAR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"USDC","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"USDC_6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"USD_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint32","name":"score","type":"uint32"}],"name":"adminSetCredit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"aprBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount_6","type":"uint256"},{"internalType":"uint64","name":"maturity","type":"uint64"}],"name":"borrow","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"canBeLiquidated","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"canBeSeverelyLiquidated","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"collateralMTYLD_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"collateralUsd_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"creditScore","outputs":[{"internalType":"uint32","name":"score","type":"uint32"},{"internalType":"uint32","name":"lastUpdated","type":"uint32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"debtUsd_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amountMTYLD_18","type":"uint256"}],"name":"depositCollateral","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isWhitelisted","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lateFeeBpsFlat","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"liqBonusBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"liqThresholdBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"repayUSDC_6","type":"uint256"},{"internalType":"uint256","name":"minSeizeMTYLD_18","type":"uint256"}],"name":"liquidate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"liquidationAmountUSDC_6","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"liquidationPaused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"loans","outputs":[{"internalType":"uint256","name":"principalUSDC_6","type":"uint256"},{"internalType":"uint256","name":"interestUSDC_6","type":"uint256"},{"internalType":"uint256","name":"lateFeesUSDC_6","type":"uint256"},{"internalType":"uint64","name":"start","type":"uint64"},{"internalType":"uint64","name":"maturity","type":"uint64"},{"internalType":"bool","name":"lateFeeApplied","type":"bool"},{"internalType":"bool","name":"active","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"ltvBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxLtvBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"mtyldUsdPrice_18","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"rateGuardian","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount_6","type":"uint256"}],"name":"repay","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"riskGuardian","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint16","name":"_lateFeeBpsFlat","type":"uint16"}],"name":"setLateFeeBps","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"on","type":"bool"}],"name":"setLiquidationPaused","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_aprBps","type":"uint16"},{"internalType":"uint16","name":"_maxLtvBps","type":"uint16"},{"internalType":"uint16","name":"_liqThresholdBps","type":"uint16"},{"internalType":"uint16","name":"_liqBonusBps","type":"uint16"}],"name":"setParams","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_treasury","type":"address"},{"internalType":"address","name":"_rate","type":"address"},{"internalType":"address","name":"_risk","type":"address"}],"name":"setRoles","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_sevThreshBps","type":"uint16"},{"internalType":"uint16","name":"_sevBonusBps","type":"uint16"},{"internalType":"bool","name":"_public","type":"bool"}],"name":"setSevereParams","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"bool","name":"allowed","type":"bool"}],"name":"setWhitelist","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"severeLiqBonusBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"severeLiqThresholdBps","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"minSeizeMTYLD_18","type":"uint256"}],"name":"severeLiquidate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"severePublic","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"n","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"treasury","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"userView","outputs":[{"components":[{"internalType":"uint256","name":"collateralMTYLD_18","type":"uint256"},{"internalType":"uint256","name":"collateralUSD_18","type":"uint256"},{"internalType":"uint256","name":"principalUSDC_6","type":"uint256"},{"internalType":"uint256","name":"interestUSDC_6","type":"uint256"},{"internalType":"uint256","name":"lateFeesUSDC_6","type":"uint256"},{"internalType":"uint256","name":"debtUSD_18","type":"uint256"},{"internalType":"uint16","name":"ltvBps","type":"uint16"},{"internalType":"uint32","name":"creditScore","type":"uint32"},{"internalType":"uint64","name":"maturity","type":"uint64"},{"internalType":"bool","name":"active","type":"bool"}],"internalType":"struct LendingVaultGatedV3.UserView","name":"V","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amountMTYLD_18","type":"uint256"}],"name":"withdrawCollateral","outputs":[],"stateMutability":"nonpayable","type":"function"}];

  // ===== Simple ERC20 ABI =====
  const ERC20_ABI = [
    "function balanceOf(address) view returns (uint256)",
    "function allowance(address,address) view returns (uint256)",
    "function approve(address,uint256) returns (bool)",
    "function decimals() view returns (uint8)"
  ];

  (async () => {
    // DOM helpers
    const $ = (id) => document.getElementById(id);
    const addrEl = $("addr"), tripletEl = $("tokenTriplet");
    const mtyldPriceEl = $("mtyldPrice"), balMtyldEl = $("balMtyld"), balUsdcEl = $("balUsdc"), ltvLine = $("ltvLine");
    const userColMtyld = $("userColMtyld"), userColUsd = $("userColUsd"), userDebtUsdc = $("userDebtUsdc"), userDebtUsd = $("userDebtUsd");
    const userInterestLate = $("userInterestLate"), userScore = $("userScore"), userMaturity = $("userMaturity");
    const depAmt = $("depAmt"), depMax = $("depMax"), depMsg = $("depMsg"), btnDeposit = $("btnDeposit");
    const wdAmt = $("wdAmt"), wdMax = $("wdMax"), wdMsg = $("wdMsg"), btnWithdraw = $("btnWithdraw");
    const brAmt = $("brAmt"), brDays = $("brDays"), brMsg = $("brMsg"), btnBorrow = $("btnBorrow");
    const rpAmt = $("rpAmt"), rpMax = $("rpMax"), rpMsg = $("rpMsg"), btnRepay = $("btnRepay");
    const treasuryBalEl = $("treasuryBal");

    let provider, signer, acct, lending, USDC, MTYLD;

    const fmt6  = (x) => Number(x)/1e6;
    const fmt18 = (x) => Number(x)/1e18;
    const to6   = (v) => BigInt(Math.round(Number(v||"0")*1e6));
    const to18  = (v) => BigInt(Math.round(Number(v||"0")*1e18));
    const trunc = (a) => a ? a.slice(0,6)+"…"+a.slice(-4) : "—";
    const usd   = (n,d=2)=>"$"+Number(n).toLocaleString(undefined,{maximumFractionDigits:d});
    const shortErr = (e)=> (e && (e.info?.error?.message || e.shortMessage || e.message))?.replace(/execution reverted: /i,'').slice(0,200) || "Error";

    async function ensure(){
      if (!window.ethereum) { alert("Please install/enable MetaMask."); throw new Error("no wallet"); }
      provider = new ethers.BrowserProvider(window.ethereum);
      const net = await provider.getNetwork();
      if (Number(net.chainId) !== CHAIN_ID_ARBITRUM) {
        await window.ethereum.request({ method: "wallet_switchEthereumChain", params:[{ chainId:"0xa4b1" }]});
      }
      signer = await provider.getSigner();
      acct = await signer.getAddress();
      addrEl.textContent = trunc(acct);

      lending = new ethers.Contract(LENDING_ADDR, LENDING_ABI, signer);
      const [usdcAddr, mtyldAddr, vaultAddr] = await Promise.all([lending.USDC(), lending.MTYLD(), lending.MTYLD_VAULT()]);
      tripletEl.textContent = `${usdcAddr} / ${mtyldAddr} / ${vaultAddr}`;
      USDC  = new ethers.Contract(usdcAddr, ERC20_ABI, signer);
      MTYLD = new ethers.Contract(mtyldAddr, ERC20_ABI, signer);
    }

    async function refresh(){
      try{
        const readProv = provider || new ethers.JsonRpcProvider("https://arb1.arbitrum.io/rpc");
        const read = new ethers.Contract(LENDING_ADDR, LENDING_ABI, readProv);
        const [usdcAddr, mtyldAddr, vaultAddr] = await Promise.all([ read.USDC(), read.MTYLD(), read.MTYLD_VAULT() ]);
        tripletEl.textContent = `${usdcAddr} / ${mtyldAddr} / ${vaultAddr}`;

        // MTYLD price from vault
        const readVault = new ethers.Contract(vaultAddr, ["function pricePerToken() view returns (uint256)"], readProv);
        const price18 = await readVault.pricePerToken();
        mtyldPriceEl.textContent = "$" + (Number(price18)/1e18).toFixed(6);

        // Optional: show protocol treasury USDC tracked by contract (best-effort)
        // If your contract exposes a getter (e.g., USDC balance of treasury or contract), you can adjust this.
        try {
          const usdcRead = new ethers.Contract(usdcAddr, ERC20_ABI, readProv);
          const lenderUSDC = await usdcRead.balanceOf(LENDING_ADDR); // contract USDC on hand
          treasuryBalEl.textContent = usd(fmt6(lenderUSDC));
        } catch { treasuryBalEl.textContent = "—"; }

        if (signer) {
          const a = acct || await signer.getAddress();
          // token balances
          const USDC_r = new ethers.Contract(usdcAddr, ERC20_ABI, readProv);
          const MTYLD_r= new ethers.Contract(mtyldAddr, ERC20_ABI, readProv);
          const [bu,bm] = await Promise.all([USDC_r.balanceOf(a), MTYLD_r.balanceOf(a)]);
          balUsdcEl.textContent  = fmt6(bu).toFixed(2) + " USDC";
          balMtyldEl.textContent = fmt18(bm).toFixed(4) + " MTYLD";

          // user view
          const V = await read.userView(a);
          userColMtyld.textContent = (Number(V.collateralMTYLD_18)/1e18).toFixed(4) + " MTYLD";
          userColUsd.textContent    = usd(Number(V.collateralUSD_18)/1e18);
          const debtUSDC = (Number(V.principalUSDC_6)+Number(V.interestUSDC_6)+Number(V.lateFeesUSDC_6))/1e6;
          userDebtUsdc.textContent  = debtUSDC.toFixed(2) + " USDC";
          userDebtUsd.textContent   = usd(Number(V.debtUSD_18)/1e18);
          userInterestLate.textContent = (Number(V.interestUSDC_6)/1e6 + Number(V.lateFeesUSDC_6)/1e6).toFixed(2) + " USDC";
          userScore.textContent     = String(V.creditScore || 0);
          userMaturity.textContent  = V.maturity ? new Date(Number(V.maturity)*1000).toLocaleString() : "—";
          ltvLine.textContent       = (Number(V.ltvBps)/100).toFixed(2) + "%";
        }
      }catch(e){ console.error(e); alert("Refresh failed: "+shortErr(e)); }
    }

    // ===== Max helpers =====
    depMax.onclick = async () => {
      try{
        if (!signer || !MTYLD) return;
        const bal = await MTYLD.balanceOf(acct);
        depAmt.value = (Number(bal)/1e18).toFixed(4);
      }catch{}
    };
    wdMax.onclick = async () => {
      try{
        if (!provider) await ensure();
        const V = await lending.userView(acct);
        wdAmt.value = (Number(V.collateralMTYLD_18)/1e18).toFixed(4);
      }catch{}
    };
    rpMax.onclick = async () => {
      try{
        if (!provider) await ensure();
        const V = await lending.userView(acct);
        const debt = (Number(V.principalUSDC_6)+Number(V.interestUSDC_6)+Number(V.lateFeesUSDC_6))/1e6;
        rpAmt.value = debt.toFixed(2);
      }catch{}
    };

    // ===== Actions =====
    btnDeposit.onclick = async () => {
      try{
        depMsg.textContent = "";
        if (!provider) await ensure();
        const a = to18(depAmt.value);
        if (a <= 0n) { depMsg.textContent = "Enter amount"; return; }
        const allowance = await MTYLD.allowance(acct, LENDING_ADDR);
        if (allowance < a) { const txa = await MTYLD.approve(LENDING_ADDR, a); await txa.wait(); }
        const tx = await lending.depositCollateral(a); await tx.wait();
        depMsg.textContent = "Deposited ✅"; await refresh();
      }catch(e){ console.error(e); depMsg.textContent = shortErr(e); }
    };

    btnWithdraw.onclick = async () => {
      try{
        wdMsg.textContent = "";
        if (!provider) await ensure();
        const a = to18(wdAmt.value);
        if (a <= 0n) { wdMsg.textContent = "Enter amount"; return; }
        const tx = await lending.withdrawCollateral(a); await tx.wait();
        wdMsg.textContent = "Withdrawn ✅"; await refresh();
      }catch(e){ console.error(e); wdMsg.textContent = shortErr(e); }
    };

    btnBorrow.onclick = async () => {
      try{
        brMsg.textContent = "";
        if (!provider) await ensure();
        const amt = to6(brAmt.value);
        const days = Math.floor(Number(brDays.value || "0"));
        if (amt <= 0n || !(days>0)) { brMsg.textContent = "Enter amount & days"; return; }
        const maturity = BigInt(Math.floor(Date.now()/1000) + days*24*3600);
        const tx = await lending.borrow(amt, maturity); await tx.wait();
        brMsg.textContent = "Borrowed ✅"; await refresh();
      }catch(e){ console.error(e); brMsg.textContent = shortErr(e); }
    };

    btnRepay.onclick = async () => {
      try{
        rpMsg.textContent = "";
        if (!provider) await ensure();
        const amt = to6(rpAmt.value);
        if (amt <= 0n) { rpMsg.textContent = "Enter amount"; return; }
        const allowance = await USDC.allowance(acct, LENDING_ADDR);
        if (allowance < amt) { const txa = await USDC.approve(LENDING_ADDR, amt); await txa.wait(); }
        const tx = await lending.repay(amt); await tx.wait();
        rpMsg.textContent = "Repaid ✅"; await refresh();
      }catch(e){ console.error(e); rpMsg.textContent = shortErr(e); }
    };

    // Connect + refresh
    document.getElementById("btnConnect").onclick = async () => { try { await ensure(); await refresh(); } catch(e){ console.error(e);} };
    document.getElementById("btnRefresh").onclick = async () => { await refresh(); };

    // First paint (read-only)
    await refresh();
  })();
  </script>
</body>
</html>
