<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YieldWorks Dashboard (V2 Payout)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js" type="application/javascript"></script>
    <!-- Favicon link removed -->
    <!-- <link rel="icon" href="favicon.ico" type="image/x-icon"> -->

    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent: #00b894; /* Teal accent */
            --border-color: #3a3a3a;
            --red: #ef4444;
            --yellow: #facc15; /* yellow-500 */
            --green: #4ade80; /* green-500 */
        }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .btn { display: inline-block; font-weight: 600; text-align: center; border-radius: 0.5rem; transition: all 0.2s ease; border: 2px solid transparent; padding: 0.6rem 1.2rem; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
        .btn-primary:hover:not(:disabled) { background-color: transparent; color: var(--accent); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-secondary); border-color: var(--text-secondary); }
        .btn-danger { background-color: var(--red); color: white; border-color: var(--red); }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; border-color: #dc2626; }
        input[type="text"], input[type="number"], input[type="password"], textarea, select { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.3); }
        label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.875rem; }
        th { background-color: var(--bg-tertiary); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: var(--bg-tertiary); }
        .alert { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem; }
        .alert-info { background-color: #0c4a6e; color: #bae6fd; }
        .alert-success { background-color: #166534; color: #bbf7d0; }
        .alert-warning { background-color: #854d0e; color: #fef08a; }
        .alert-error { background-color: #991b1b; color: #fecaca; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; margin-right: 0.5rem; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-select { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; height: 42px; }
        .filter-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.3); }
        /* Removed Paused styles */
        .proposal-card { background-color: var(--bg-tertiary); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); margin-top: 1rem; font-size: 0.875rem; }
        .text-green { color: var(--green); }
        .text-yellow { color: var(--yellow); }
        .text-red { color: var(--red); }
        .error-text { color: var(--red); font-weight: bold; } /* Style for error messages in spans */


    </style>
</head>
<body class="min-h-screen pb-16">

    <!-- Navbar - Simplified -->
    <nav class="bg-secondary sticky top-0 z-50 shadow-lg mb-8">
        <div class="container mx-auto max-w-7xl p-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold">
                 YieldWorks
                 <span class="text-sm font-normal text-secondary hidden sm:inline-block ml-2">Dashboard</span>
            </a>
            <!-- Pause indicator removed -->
            <button id="connect-button" class="btn btn-primary">Connect Wallet</button>
        </div>
    </nav>

    <main class="container mx-auto max-w-7xl px-4">

        <!-- Status Messages -->
        <div id="status-message" class="hidden"></div>

        <!-- Wallet Info -->
        <div id="wallet-info" class="card hidden">
            <h2 class="text-xl font-bold mb-3">Wallet Connected</h2>
            <p class="text-sm"><strong>Network:</strong> <span id="network-name"></span></p>
            <p class="text-sm truncate"><strong>Address:</strong> <span id="user-address"></span></p>
            <p class="text-sm"><strong>USDC Balance:</strong> <span id="usdc-balance">Loading...</span></p>
            <p class="text-sm"><strong>MTYLD Balance:</strong> <span id="mtyld-balance">Loading...</span></p>
        </div>

        <!-- Protocol Info -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">Protocol Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div><strong>Token:</strong> <span id="token-name">Loading...</span> (<span id="token-symbol">---</span>)</div>
                <div><strong>Total Supply:</strong> <span id="total-supply">Loading...</span> MTYLD</div>
                <div class="md:col-span-2 lg:col-span-1"><strong>Contract Address:</strong> <a id="contract-address-link" href="#" target="_blank" rel="noopener noreferrer" class="text-accent hover:underline break-all">Loading...</a></div>
                <div><strong>Contract USDC:</strong> <span id="contract-usdc">Loading...</span> USDC</div>
                <div><strong>Current Price:</strong> <span id="mtyld-price">Loading...</span> USDC/MTYLD</div>
                <div><strong>Available for Sale:</strong> <span id="available-mtyld">Loading...</span> MTYLD</div>
                {/* Removed Proposal Delay */}
            </div>
        </div>

        {/* Removed Pending Mint Proposals Section */}

        <!-- Buy / Redeem Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Buy Card -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Buy MTYLD</h2>
                <form id="buy-form">
                    <div class="mb-4"><label for="buy-usdc-amount">USDC Amount to Spend</label><input type="number" id="buy-usdc-amount" step="0.01" min="0" placeholder="e.g., 100.00" required><p class="text-xs text-secondary mt-1">Your USDC Balance: <span id="buy-usdc-balance">--</span></p></div>
                     <div class="mb-4"><label for="buy-slippage">Slippage Tolerance (%)</label><select id="buy-slippage" class="bg-tertiary"><option value="0.5">0.5%</option><option value="1">1%</option><option value="2">2%</option></select></div>
                    <div class="mb-4 text-sm bg-tertiary p-3 rounded">Estimated MTYLD to Receive: <span id="estimated-mtyld" class="font-bold">0.00</span><input type="hidden" id="min-tokens-out"></div>
                    <div class="flex flex-col sm:flex-row gap-3"><button type="button" id="approve-usdc-button" class="btn btn-secondary flex-1">Approve USDC</button><button type="submit" id="buy-button" class="btn btn-primary flex-1" disabled>Buy MTYLD</button></div>
                </form>
            </div>
            <!-- Redeem Card -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Redeem MTYLD</h2>
                <form id="redeem-form">
                    <div class="mb-4"><label for="redeem-mtyld-amount">MTYLD Amount to Redeem</label><input type="number" id="redeem-mtyld-amount" step="0.01" min="0" placeholder="e.g., 500.00" required><p class="text-xs text-secondary mt-1">Your MTYLD Balance: <span id="redeem-mtyld-balance">--</span></p></div>
                    <div class="mb-4"><label for="redeem-slippage">Slippage Tolerance (%)</label><select id="redeem-slippage" class="bg-tertiary"><option value="0.5">0.5%</option><option value="1">1%</option><option value="2">2%</option></select></div>
                    <div class="mb-4 text-sm bg-tertiary p-3 rounded">Estimated USDC to Receive (after fee): <span id="estimated-usdc" class="font-bold">0.00</span><input type="hidden" id="min-usdc-out"><p class="text-xs text-secondary mt-1">Redemption Fee: <span id="redeem-fee-percent">--</span>%</p></div>
                    <button type="submit" id="redeem-button" class="btn btn-primary w-full">Redeem MTYLD</button>
                </form>
            </div>
        </div>

        <!-- Work Orders Table Section -->
         <div class="card mt-6">
             <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                 <h2 class="text-xl font-bold mb-3 sm:mb-0">Work Orders</h2>
                 <div class="flex items-center space-x-3">
                     <label for="filter-month" class="text-sm text-secondary whitespace-nowrap">Filter by:</label>
                     <select id="filter-month" class="filter-select w-32"><option value="all">All Months</option><option value="0">Jan</option><option value="1">Feb</option><option value="2">Mar</option><option value="3">Apr</option><option value="4">May</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Aug</option><option value="8">Sep</option><option value="9">Oct</option><option value="10">Nov</option><option value="11">Dec</option></select>
                     <select id="filter-year" class="filter-select w-28"> <option value="all">All Years</option> </select>
                 </div>
             </div>
             <div class="overflow-x-auto">
                 <table id="work-orders-table">
                     <thead><tr><th>ID</th><th>Description</th><th>Gross Yield (USDC)</th><th>Reserve (USDC)</th><th>Issued (MTYLD)</th><th>Status</th><th>Created</th></tr></thead>
                     <tbody id="work-orders-body"><tr><td colspan="7" class="text-center py-4 text-secondary">Loading work orders...</td></tr></tbody>
                 </table>
             </div>
         </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="card mt-8 hidden">
             <h2 class="text-2xl font-bold mb-6 text-center text-accent">Admin Panel</h2>
             {/* Pause Control Removed */}
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                 <form id="mint-order-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Mint New Work Order</h3>
                     <div class="mb-3"><label for="mint-yield">Gross Yield (USDC)</label><input type="number" id="mint-yield" step="0.01" min="0.01" placeholder="e.g., 1000.00" required></div>
                     <div class="mb-3"><label for="mint-desc">Description</label><input type="text" id="mint-desc" placeholder="e.g., Install #12345" required></div>
                     <button type="submit" class="btn btn-primary w-full">Mint Order</button>
                 </form>
                 <form id="payout-order-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Payout Work Order</h3>
                      <div class="mb-3"><label for="payout-id">Work Order ID</label><input type="number" id="payout-id" min="1" placeholder="e.g., 1" required></div>
                     <div class="mb-3"><label for="payout-amount">Payout Amount (USDC)</label><input type="number" id="payout-amount" step="0.01" min="0.01" placeholder="Should match Gross Yield" required><p class="text-xs text-secondary mt-1">Order Gross Yield: <span id="payout-gross-yield">--</span></p></div>
                      <p class="text-xs text-secondary mb-3">Requires prior USDC approval.</p>
                       <div class="flex gap-3"><button type="button" id="admin-approve-usdc-button" class="btn btn-secondary flex-1">Approve USDC</button><button type="submit" class="btn btn-primary flex-1">Submit Payout</button></div>
                  </form>
              </div>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <form id="cancel-order-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Cancel Work Order</h3><p class="text-xs text-secondary mb-3">Deactivate order.</p>
                     <div class="mb-3"><label for="cancel-id">Work Order ID</label><input type="number" id="cancel-id" min="1" placeholder="e.g., 1" required></div>
                     <button type="submit" class="btn btn-danger w-full">Cancel Order</button>
                 </form>
                 <form id="set-fee-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Set Redemption Fee</h3>
                     <div class="mb-3"><label for="new-fee">New Fee % (0-20)</label><input type="number" id="new-fee" min="0" max="20" step="0.1" placeholder="e.g., 10" required></div>
                      <p class="text-xs text-secondary mb-3">Current Fee: <span id="current-redeem-fee">--</span>%</p>
                     <button type="submit" class="btn btn-secondary w-full">Update Fee</button>
                 </form>
                 <div class="bg-tertiary p-4 rounded-lg border border-border-color">
                      <h3 class="text-lg font-semibold mb-3">Withdraw Fees</h3><p class="text-sm mb-3">Collected Fees: <span id="collected-fees" class="font-bold">Loading...</span> USDC</p>
                     <button id="withdraw-fees-button" class="btn btn-secondary w-full" disabled>Withdraw All Fees</button>
                  </div>
             </div>
              <form id="emergency-withdraw-form" class="bg-tertiary p-4 rounded-lg border border-border-color mt-6">
                  <h3 class="text-lg font-semibold mb-3">Emergency Withdraw (Owner Only)</h3>
                  <p class="text-xs text-red mb-3 font-semibold">⚠️ WARNING: Allows withdrawing ANY ERC20, including core USDC.</p>
                  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                      <div><label for="emergency-token">Token Address</label><input type="text" id="emergency-token" placeholder="0x..." required></div>
                      <div><label for="emergency-to">Recipient Address</label><input type="text" id="emergency-to" placeholder="0x..." required></div>
                       <div><label for="emergency-amount">Amount (Raw Units)</label><input type="number" id="emergency-amount" min="1" placeholder="e.g., 1000..." required></div>
                  </div>
                  <button type="submit" class="btn btn-danger w-full mt-3">Withdraw Token</button>
              </form>
         </div>

    </main>

    <script type="text/javascript">
        // --- CONFIGURATION ---
        const contractAddress = "0xB911E622Aaf41F068c561cca67ae3f5d8Bf92826";
        const contractABI = [{"inputs":[{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"target","type":"address"}],"name":"AddressCallToNonContract","type":"error"},{"inputs":[],"name":"AddressEmptyRevertData","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"AddressInsufficientBalance","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"RedemptionFeeSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReserveFunded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"holder","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdcAmount","type":"uint256"}],"name":"TokensRedeemed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"}],"name":"WorkOrderCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"yieldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"}],"name":"WorkOrderMinted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WorkOrderPaid","type":"event"},{"inputs":[],"name":"RESERVE_PERCENTAGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"availableTokens","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount","type":"uint256"},{"internalType":"uint256","name":"minTokensOut","type":"uint256"}],"name":"buyTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"workOrderId","type":"uint256"}],"name":"cancelWorkOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"collectedFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"contractPaymentTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"tokenAddress","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"mtyldAmount","type":"uint256"}],"name":"getRedemptionValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount","type":"uint256"}],"name":"getTokensForUSDC","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"string","name":"description","type":"string"}],"name":"mintFromWorkOrder","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextWorkOrderId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paymentToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"workOrderId","type":"uint256"},{"internalType":"uint256","name":"payoutAmount","type":"uint256"}],"name":"payoutWorkOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"mtyldAmount","type":"uint256"},{"internalType":"uint256","name":"minUsdcOut","type":"uint256"}],"name":"redeemTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"redemptionFeePercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"setRedemptionFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalReserveFund","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"workOrders","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"uint256","name":"reserveAmount","type":"uint256"},{"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isPaid","type":"bool"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"createdAt","type":"uint256"}],"stateMutability":"view","type":"function"}]; // <-- Old ABI
        const usdcAddress = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831"; // Arbitrum Native USDC
        const arbitrumChainId = '0xa4b1'; // 42161 in hex

        // --- DOM Elements ---
        const connectButton = document.getElementById('connect-button');
        const statusMessageDiv = document.getElementById('status-message');
        const walletInfoDiv = document.getElementById('wallet-info');
        const networkNameSpan = document.getElementById('network-name');
        const userAddressSpan = document.getElementById('user-address');
        const usdcBalanceSpan = document.getElementById('usdc-balance');
        const mtyldBalanceSpan = document.getElementById('mtyld-balance');
        const buyUsdcBalanceSpan = document.getElementById('buy-usdc-balance');
        const redeemMtyldBalanceSpan = document.getElementById('redeem-mtyld-balance');
        const tokenNameSpan = document.getElementById('token-name');
        const tokenSymbolSpan = document.getElementById('token-symbol');
        const totalSupplySpan = document.getElementById('total-supply');
        const contractAddressLink = document.getElementById('contract-address-link');
        const contractUsdcSpan = document.getElementById('contract-usdc');
        const mtyldPriceSpan = document.getElementById('mtyld-price');
        const availableMtyldSpan = document.getElementById('available-mtyld');
        // Removed proposalDelaySpan
        const buyForm = document.getElementById('buy-form');
        const buyUsdcAmountInput = document.getElementById('buy-usdc-amount');
        const buySlippageSelect = document.getElementById('buy-slippage');
        const estimatedMtyldSpan = document.getElementById('estimated-mtyld');
        const minTokensOutInput = document.getElementById('min-tokens-out');
        const approveUsdcButton = document.getElementById('approve-usdc-button');
        const buyButton = document.getElementById('buy-button');
        const redeemForm = document.getElementById('redeem-form');
        const redeemMtyldAmountInput = document.getElementById('redeem-mtyld-amount');
        const redeemSlippageSelect = document.getElementById('redeem-slippage');
        const estimatedUsdcSpan = document.getElementById('estimated-usdc');
        const minUsdcOutInput = document.getElementById('min-usdc-out');
        const redeemButton = document.getElementById('redeem-button');
        const redeemFeePercentSpan = document.getElementById('redeem-fee-percent');
        // Removed pendingMintsTableBody
        const workOrdersTableBody = document.getElementById('work-orders-body');
        const filterMonthSelect = document.getElementById('filter-month');
        const filterYearSelect = document.getElementById('filter-year');
        const adminPanelDiv = document.getElementById('admin-panel');
        const mintOrderForm = document.getElementById('mint-order-form');
        const payoutOrderForm = document.getElementById('payout-order-form');
        const payoutGrossYieldSpan = document.getElementById('payout-gross-yield');
        const payoutIdInput = document.getElementById('payout-id');
        const cancelOrderForm = document.getElementById('cancel-order-form');
        const setFeeForm = document.getElementById('set-fee-form');
        const currentRedeemFeeSpan = document.getElementById('current-redeem-fee');
        const collectedFeesSpan = document.getElementById('collected-fees');
        const withdrawFeesButton = document.getElementById('withdraw-fees-button');
        const adminApproveUsdcButton = document.getElementById('admin-approve-usdc-button');
        const emergencyWithdrawForm = document.getElementById('emergency-withdraw-form');
        // Removed pause elements


        // --- State Variables ---
        let provider = null;
        let signer = null;
        let userAddress = null;
        let mtyldContract = null;
        let usdcContract = null;
        let contractOwner = null;
        let usdcDecimals = 6; // Hardcoded
        let mtyldDecimals = 18;
        let allWorkOrders = [];
        let availableYears = new Set();
        let blockTimestamp = null; // Can still be useful for date formatting context


        // --- Helper Functions ---
        const USDC_ABI = [
          "function balanceOf(address) view returns (uint256)",
          "function allowance(address,address) view returns (uint256)",
          "function approve(address,uint256) returns (bool)",
          "function decimals() view returns (uint8)"
        ];
        function showStatus(message, type = "info") { /* ... (same as before) ... */ }
        function formatUnits(v, d) { /* ... (same as before) ... */ }
        function parseUnits(v, d) { /* ... (same as before) ... */ }
        function shortenAddress(a){ /* ... (same as before) ... */ }
        function formatDate(timestamp) { /* ... (same as before) ... */ }
        function setLoading(btn, isLoading, originalText) { /* ... (same as before) ... */ }
        function resetState() { /* ... (updated below) ... */ }
        function resetLoadingStates() { /* ... (updated below) ... */ }
        // Removed formatSeconds, calculateTimeRemaining, updatePauseUI, updatePauseButtons


        // --- Wallet connect (ethers v6) ---
        async function connectWallet() {
          console.log("Connect attempt started...");
          const connectBtn = connectButton; const originalText = 'Connect Wallet';
          setLoading(connectBtn, true, originalText);
          try {
            if (typeof window.ethereum === 'undefined') throw new Error("MetaMask not found.");
            if (typeof ethers === 'undefined') throw new Error("Ethers.js not loaded.");

            console.log("Requesting provider...");
            provider = new ethers.BrowserProvider(window.ethereum, "any");

            if (!window.walletListenersAttached) { setupWalletListeners(); window.walletListenersAttached = true; }

            console.log("Checking network...");
            const net = await provider.getNetwork();
            if (net.chainId !== BigInt(arbitrumChainId)) {
              console.log("Incorrect network, requesting switch..."); showStatus("Switch to Arbitrum One requested...", "info");
              await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: arbitrumChainId }] });
              provider = new ethers.BrowserProvider(window.ethereum); console.log("Provider re-initialized after switch.");
            }

            console.log("Requesting accounts...");
            await provider.send("eth_requestAccounts", []);
            signer = await provider.getSigner(); userAddress = await signer.getAddress(); console.log("Signer obtained:", userAddress);

            const finalNet = await provider.getNetwork();
            if (finalNet.chainId !== BigInt(arbitrumChainId)) throw new Error("Wallet connected but not on Arbitrum One.");
            networkNameSpan.textContent = "Arbitrum One"; userAddressSpan.textContent = userAddress;

            // Instantiate contracts with the OLD ABI
            mtyldContract = new ethers.Contract(contractAddress, contractABI, signer);
            usdcContract = new ethers.Contract(usdcAddress, USDC_ABI, signer); console.log("Contracts instantiated");

            // Attempt to fetch decimals, default to 6
            try {
                const decimalsResult = await usdcContract.decimals();
                usdcDecimals = Number(decimalsResult); // Convert BigInt to number
                console.log("Fetched USDC decimals:", usdcDecimals);
            } catch (decError) {
                console.error("Could not fetch USDC decimals, defaulting to 6:", decError);
                usdcDecimals = 6; // Default to 6 if call fails
            }

            walletInfoDiv.classList.remove("hidden"); console.log("Wallet UI visible");
            await loadInitialData();
            showStatus("Wallet connected.", "success");

          } catch (err) {
            console.error("Connect Wallet Error:", err);
            let errMsg = err.message || "Unknown connection error.";
            if (err.code === 4001 || err.message?.includes('rejected')) errMsg = "Connection rejected by user.";
            if (err.message?.includes('Already processing')) errMsg = "Connection request already pending.";
            showStatus(errMsg, "error"); resetState();
          } finally {
               if (userAddress) { setLoading(connectBtn, false, shortenAddress(userAddress)); connectBtn.disabled = true; }
               else { setLoading(connectBtn, false, originalText); connectBtn.disabled = false; }
               console.log("Connect attempt finished.");
          }
        }

        function setupWalletListeners() {
          if (!window.ethereum || !window.ethereum.on) return console.warn("Cannot setup listeners.");
          window.ethereum.removeAllListeners?.("accountsChanged"); window.ethereum.removeAllListeners?.("chainChanged"); console.log("Removed previous listeners.");
          window.ethereum.on("accountsChanged", async (accounts) => {
             console.log("accountsChanged:", accounts);
            if (!accounts || accounts.length === 0) { resetState(); showStatus("Wallet disconnected.", "warning"); return; }
            if (!userAddress || ethers.getAddress(accounts[0]) !== ethers.getAddress(userAddress)) { showStatus("Account changed, reconnecting...", "info"); resetState(); await connectWallet(); }
          });
          window.ethereum.on("chainChanged", async (hexId) => {
             console.log("chainChanged:", hexId);
            if (hexId !== arbitrumChainId) { showStatus("Switched network. Switch back to Arbitrum.", "error"); resetState(); connectButton.textContent = 'Wrong Network'; connectButton.disabled = true; }
            else { showStatus("Network changed to Arbitrum. Refreshing...", "info"); resetState(); await connectWallet(); }
          });
           console.log("Wallet listeners attached.");
        }


        // Combined function to load data
        async function loadInitialData() {
             console.log("loadInitialData started");
             resetLoadingStates();
             try {
                 console.log("Updating protocol info..."); await updateProtocolInfo(); console.log("Protocol info finished.");
                 console.log("Updating wallet info..."); await updateWalletInfo(); console.log("Wallet info finished.");
                 console.log("Fetching work orders..."); await fetchAndStoreAllWorkOrders(); console.log("Work orders finished.");
                 // Pending proposals fetch removed
                 console.log("Checking admin status..."); await checkAdminStatus(); console.log("Admin check finished.");
             } catch (error) { console.error("Error in loadInitialData:", error); showStatus("Failed to load app data.", "error"); clearLoadingStatesWithError(); }
             console.log("loadInitialData finished");
         }


        // --- UI Update Helper Functions ---
        function resetState() {
          walletInfoDiv.classList.add("hidden"); userAddress = null; signer = null; mtyldContract = null; usdcContract = null;
          workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">Connect wallet to view orders.</td></tr>';
          connectButton.textContent = 'Connect Wallet'; connectButton.disabled = false;
          resetLoadingStates();
          adminPanelDiv.classList.add('hidden'); // Hide admin panel on reset
          console.log("State reset");
        }
        function resetLoadingStates() {
            tokenNameSpan.textContent = 'Loading...'; tokenSymbolSpan.textContent = '---'; totalSupplySpan.textContent = 'Loading...';
            contractAddressLink.textContent = 'Loading...'; contractUsdcSpan.textContent = 'Loading...'; mtyldPriceSpan.textContent = 'Loading...';
            availableMtyldSpan.textContent = 'Loading...';
            usdcBalanceSpan.textContent = 'Loading...'; mtyldBalanceSpan.textContent = 'Loading...';
            buyUsdcBalanceSpan.textContent = '--'; redeemMtyldBalanceSpan.textContent = '--';
            estimatedMtyldSpan.textContent = '0.00'; estimatedUsdcSpan.textContent = '0.00';
            minTokensOutInput.value = '0'; minUsdcOutInput.value = '0';
        }
        function clearLoadingStatesWithError() {
             tokenNameSpan.textContent = 'Error'; tokenSymbolSpan.textContent = 'Err'; totalSupplySpan.textContent = 'Error';
             contractAddressLink.textContent = 'Error'; contractUsdcSpan.textContent = 'Error'; mtyldPriceSpan.textContent = 'Error';
             availableMtyldSpan.textContent = 'Error';
             usdcBalanceSpan.textContent = 'Error'; mtyldBalanceSpan.textContent = 'Error';
             buyUsdcBalanceSpan.textContent = 'Error'; redeemMtyldBalanceSpan.textContent = 'Error';
             workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red">Error loading orders.</td></tr>';
             estimatedMtyldSpan.textContent = 'Error'; estimatedUsdcSpan.textContent = 'Error';
        }


        async function checkAdminStatus() {
             if (!mtyldContract) return;
             try {
                 contractOwner = await mtyldContract.owner();
                 if (userAddress && contractOwner && userAddress.toLowerCase() === contractOwner.toLowerCase()) {
                     adminPanelDiv.classList.remove('hidden'); console.log("Admin connected");
                     await updateAdminInfo();
                 } else { adminPanelDiv.classList.add('hidden'); console.log("User is not admin"); }
             } catch (error) { console.error("Admin check error:", error); showStatus('Admin check failed.', 'error'); }
        }
        async function updateAdminInfo() { // Remove pause checks
             if (!mtyldContract) return;
             try {
                  const [fees, feePercent] = await Promise.all([
                       mtyldContract.collectedFees(), mtyldContract.redemptionFeePercentage()
                  ]);
                  collectedFeesSpan.textContent = parseFloat(formatUnits(fees, usdcDecimals)).toFixed(2);
                  withdrawFeesButton.disabled = fees === 0n;
                  currentRedeemFeeSpan.textContent = feePercent.toString();
             } catch (error) { console.error("Admin info error:", error); collectedFeesSpan.textContent = 'Error'; withdrawFeesButton.disabled = true; }
        }
         // Removed proposal check functions


        async function updateWalletInfo() { /* ... (No changes needed) ... */ }

        async function updateProtocolInfo() { // Removed pause/delay fetching
             console.log("updateProtocolInfo started");
             if (!mtyldContract || !usdcContract || !provider) { console.log("updateProtocolInfo skipped"); clearLoadingStatesWithError(); return; } // Clear loading on skip
             resetLoadingStates();
             try {
                 const block = await provider.getBlock("latest"); blockTimestamp = block ? BigInt(block.timestamp) : null;
                 console.log("Block timestamp:", blockTimestamp?.toString());

                 const [name, symbol, supply, contractUSDCBalance, available, feePercent] = await Promise.all([
                     mtyldContract.name(), mtyldContract.symbol(), mtyldContract.totalSupply(), mtyldContract.contractPaymentTokenBalance(),
                     mtyldContract.availableTokens(), mtyldContract.redemptionFeePercentage()
                 ]);
                 console.log("Protocol data fetched:", { name, symbol, /*...*/ });

                 tokenNameSpan.textContent = name; tokenSymbolSpan.textContent = symbol;
                 totalSupplySpan.textContent = parseFloat(formatUnits(supply, mtyldDecimals)).toFixed(4);
                 contractAddressLink.textContent = shortenAddress(contractAddress); contractAddressLink.href = `https://arbiscan.io/address/${contractAddress}`;
                 contractUsdcSpan.textContent = parseFloat(formatUnits(contractUSDCBalance, usdcDecimals)).toFixed(2);
                 availableMtyldSpan.textContent = parseFloat(formatUnits(available, mtyldDecimals)).toFixed(4);
                 redeemFeePercentSpan.textContent = feePercent.toString();

                 let price = 0;
                 if (supply > 0n && contractUSDCBalance >= 0n) {
                      // Original Price Calc: (Contract USDC * 10^(18-6)) / Total MTYLD Supply
                      const scaleFactor = 10n ** BigInt(18 - usdcDecimals);
                      const priceBigInt = supply > 0n ? (contractUSDCBalance * scaleFactor) / supply : 0n;
                      price = parseFloat(formatUnits(priceBigInt, usdcDecimals)); // Price represented in USDC units
                 }
                 mtyldPriceSpan.textContent = price > 0 ? price.toFixed(6) : '0.000000';
                 console.log("Calculated price:", mtyldPriceSpan.textContent);

                 updateBuyEstimate(); updateRedeemEstimate(); console.log("Estimates updated");

             } catch (error) {
                 console.error("Error updating protocol info:", error);
                 showStatus('Failed to fetch protocol data.', 'error');
                 clearLoadingStatesWithError();
             }
             console.log("updateProtocolInfo finished");
         }


        // --- Buy/Redeem Logic ---
        async function updateBuyEstimate() { /* ... (Logic remains same) ... */ }
        async function updateRedeemEstimate() { /* ... (Logic remains same) ... */ }
        async function handleApproveUSDC(isAdmin = false) { /* ... (Logic remains same) ... */ }
        async function handleBuyTokens(event) { /* ... (Removed pause check) ... */ }
        async function handleRedeemTokens(event) { /* ... (Removed pause check) ... */ }


        // --- Work Order Display & Filtering Logic ---
        async function fetchAndStoreAllWorkOrders() { /* ... (Logic remains same, fetches one-by-one) ... */ }
        function populateYearFilter() { /* ... (No changes needed) ... */ }
        function filterAndRenderOrders() { /* ... (No changes needed) ... */ }
        function renderWorkOrdersTable(ordersToRender) { /* ... (Logic remains same) ... */ }
         // Removed fetchPendingProposals function


        // --- Admin Actions (Reverted to direct calls) ---
        async function handleMintOrder(event) { /* ... (Direct mint, removed pause check) ... */ }
        // Removed handleProposeMint, handleExecuteMint

        // Update Payout form helper text - fetch Gross Yield
         payoutIdInput.addEventListener('input', async () => {
             const orderIdStr = payoutIdInput.value;
              payoutGrossYieldSpan.textContent = '--'; // Use correct span ID
              if (!orderIdStr || parseInt(orderIdStr) < 1 || !mtyldContract) return;
             const orderId = BigInt(orderIdStr);
             try { const order = await mtyldContract.workOrders(orderId); if (order.id !== 0n) { payoutGrossYieldSpan.textContent = `${parseFloat(formatUnits(order.grossYield, usdcDecimals)).toFixed(2)} USDC`; } else { payoutGrossYieldSpan.textContent = 'Not Found'; } }
             catch { payoutGrossYieldSpan.textContent = 'Error'; }
         });

        async function handlePayoutOrder(event) { /* ... (Payout logic, removed pause check, ensure payoutGrossYieldSpan updated) ... */ }

        async function handleCancelOrder(event) { /* ... (Removed pause check) ... */ }

        async function handleSetFee(event) { /* ... (Direct set fee, removed pause check) ... */ }
         // Removed handleProposeFeeChange, handleExecuteFeeChange

        async function handleWithdrawFees() { /* ... (Removed pause check) ... */ }
        async function handleEmergencyWithdraw(event) { /* ... (Removed pause check, added warning about USDC) ... */ }
         // --- Pause/Unpause Logic Removed ---


        // --- Event Listeners Setup ---
         function setupEventListeners() { /* ... (Reverted listeners) ... */
            if (window.eventListenersAttached) return;
             buyUsdcAmountInput.addEventListener('input', updateBuyEstimate); buySlippageSelect.addEventListener('change', updateBuyEstimate);
             redeemMtyldAmountInput.addEventListener('input', updateRedeemEstimate); redeemSlippageSelect.addEventListener('change', updateRedeemEstimate);
             approveUsdcButton.addEventListener('click', () => handleApproveUSDC(false));
             buyForm.addEventListener('submit', handleBuyTokens); redeemForm.addEventListener('submit', handleRedeemTokens);
            filterMonthSelect.addEventListener('change', filterAndRenderOrders); filterYearSelect.addEventListener('change', filterAndRenderOrders);
             if (adminApproveUsdcButton) adminApproveUsdcButton.addEventListener('click', () => handleApproveUSDC(true));
             if (mintOrderForm) mintOrderForm.addEventListener('submit', handleMintOrder);
             if (payoutOrderForm) payoutOrderForm.addEventListener('submit', handlePayoutOrder);
             if (cancelOrderForm) cancelOrderForm.addEventListener('submit', handleCancelOrder);
             if (setFeeForm) setFeeForm.addEventListener('submit', handleSetFee);
             if (withdrawFeesButton) withdrawFeesButton.addEventListener('click', handleWithdrawFees);
             if (emergencyWithdrawForm) emergencyWithdrawForm.addEventListener('submit', handleEmergencyWithdraw);
             window.eventListenersAttached = true;
         }
         function setupWalletListeners() { /* ... (No changes needed) ... */ }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
             connectButton.addEventListener('click', connectWallet);
             setupEventListeners();
             workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">Connect wallet to view orders.</td></tr>';
             // Removed pending mints init
             populateYearFilter();
        });

    </script>
</body>
</html>

