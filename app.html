<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTYLD One‑File dApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b0e14; --card:#111827; --muted:#9aa4b2; --text:#e6edf3; --accent:#f97316; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:400 15px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
    .card{background:var(--card);border:1px solid var(--border); border-radius:18px; box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .btn{background:var(--accent);color:#111827;border-radius:12px;padding:.7rem 1rem;font-weight:700}
    .btn:disabled{opacity:.6}
    .input{background:#0e1420;border:1px solid var(--border);border-radius:12px;padding:.65rem .8rem;width:100%}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}
    .pill{border:1px solid var(--border);border-radius:999px;padding:.25rem .6rem;color:var(--muted);font-size:.8rem}
    .tab{cursor:pointer;padding:.6rem 1rem;border-bottom:2px solid transparent}
    .tab.active{border-color:var(--accent);color:#fff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <header class="sticky top-0 z-10 backdrop-blur bg-black/40 border-b border-[var(--border)]">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-2xl font-extrabold">MTYLD Dashboard</div>
        <span id="network" class="pill">Network: —</span>
        <span id="addrShort" class="pill">Not connected</span>
      </div>
      <div class="flex items-center gap-3">
        <button id="connectBtn" class="btn">Connect Wallet</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="card p-5 mb-6">
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <div class="text-sm text-[var(--muted)]">Token</div>
          <div id="tokenName" class="text-xl font-bold">—</div>
          <div id="tokenSymbol" class="text-sm text-[var(--muted)]">—</div>
        </div>
        <div>
          <div class="text-sm text-[var(--muted)]">Total Supply</div>
          <div id="totalSupply" class="text-xl font-bold">—</div>
        </div>
        <div>
          <div class="text-sm text-[var(--muted)]">Your Balance</div>
          <div id="myBalance" class="text-xl font-bold">—</div>
        </div>
        <div>
          <div class="text-sm text-[var(--muted)]">Reserve Fund</div>
          <div id="reserve" class="text-xl font-bold">—</div>
        </div>
      </div>
      <div class="mt-4 grid-3">
        <div class="card p-4">
          <div class="text-sm text-[var(--muted)]">Available Tokens</div>
          <div id="availableTokens" class="text-lg font-semibold">—</div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-[var(--muted)]">Payment Token</div>
          <div><span id="paySym" class="font-semibold">—</span> <span id="payAddr" class="mono text-[var(--muted)]"></span></div>
        </div>
        <div class="card p-4">
          <div class="text-sm text-[var(--muted)]">Redemption Fee %</div>
          <div id="redeemFee" class="text-lg font-semibold">—</div>
        </div>
      </div>
    </section>

    <section class="card p-5 mb-6">
      <div class="flex gap-4 border-b border-[var(--border)] mb-4">
        <div class="tab active" data-tab="buyTab">Buy</div>
        <div class="tab" data-tab="redeemTab">Redeem</div>
        <div class="tab" data-tab="workOrdersTab">Work Orders</div>
        <div class="tab" data-tab="adminTab">Admin</div>
      </div>

      <!-- BUY TAB -->
      <div id="buyTab" class="tabPanel">
        <div class="grid-2">
          <div>
            <label class="text-sm text-[var(--muted)]">USDC Amount</label>
            <input id="buyUsdc" class="input" placeholder="e.g. 100" />
          </div>
          <div>
            <label class="text-sm text-[var(--muted)]">Slippage %</label>
            <input id="buySlip" class="input" value="1" />
          </div>
        </div>
        <div class="mt-3 text-sm">Estimated MTYLD: <span id="estTokens" class="font-semibold">0</span></div>
        <div class="mt-4 flex gap-3">
          <button id="approveBtn" class="btn">Approve USDC</button>
          <button id="buyBtn" class="btn">Buy Tokens</button>
        </div>
        <div id="buyMsg" class="mt-3 text-sm text-[var(--muted)]"></div>
      </div>

      <!-- REDEEM TAB -->
      <div id="redeemTab" class="tabPanel hidden">
        <div class="grid-2">
          <div>
            <label class="text-sm text-[var(--muted)]">MTYLD Amount</label>
            <input id="redeemAmt" class="input" placeholder="e.g. 50" />
          </div>
          <div>
            <label class="text-sm text-[var(--muted)]">Slippage %</label>
            <input id="redeemSlip" class="input" value="1" />
          </div>
        </div>
        <div class="mt-3 text-sm">Estimated USDC Out: <span id="estUsdc" class="font-semibold">0</span></div>
        <div class="mt-4 flex gap-3">
          <button id="redeemBtn" class="btn">Redeem</button>
        </div>
        <div id="redeemMsg" class="mt-3 text-sm text-[var(--muted)]"></div>
      </div>

      <!-- WORK ORDERS TAB -->
      <div id="workOrdersTab" class="tabPanel hidden">
        <div class="flex items-center gap-3 mb-3">
          <button id="refreshWO" class="btn">Refresh</button>
          <span class="text-sm text-[var(--muted)]">Showing latest 10</span>
        </div>
        <div id="woList" class="space-y-3"></div>
      </div>

      <!-- ADMIN TAB -->
      <div id="adminTab" class="tabPanel hidden">
        <div id="adminGate" class="text-sm text-red-300 mb-3 hidden">You are not the owner. Admin actions disabled.</div>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="font-bold mb-2">Propose Mint</div>
            <label class="text-xs text-[var(--muted)]">Gross Yield (USDC)</label>
            <input id="pmGross" class="input mb-2" placeholder="e.g. 10000" />
            <label class="text-xs text-[var(--muted)]">Description</label>
            <input id="pmDesc" class="input mb-2" placeholder="Work order details" />
            <button id="proposeMintBtn" class="btn">Propose Mint</button>
            <div id="pmMsg" class="text-sm text-[var(--muted)] mt-2"></div>
          </div>
          <div class="card p-4">
            <div class="font-bold mb-2">Execute Mint</div>
            <label class="text-xs text-[var(--muted)]">Proposal ID</label>
            <input id="emId" class="input mb-2" placeholder="e.g. 1" />
            <button id="executeMintBtn" class="btn">Execute Mint</button>
            <div id="emMsg" class="text-sm text-[var(--muted)] mt-2"></div>
          </div>
          <div class="card p-4">
            <div class="font-bold mb-2">Payout Work Order</div>
            <label class="text-xs text-[var(--muted)]">Work Order ID</label>
            <input id="pwId" class="input mb-2" placeholder="e.g. 1" />
            <label class="text-xs text-[var(--muted)]">Payout Amount (USDC)</label>
            <input id="pwAmt" class="input mb-2" placeholder="e.g. 5000" />
            <button id="payoutBtn" class="btn">Payout</button>
            <div id="pwMsg" class="text-sm text-[var(--muted)] mt-2"></div>
          </div>
          <div class="card p-4">
            <div class="font-bold mb-2">Fee Change</div>
            <label class="text-xs text-[var(--muted)]">New Fee %</label>
            <input id="feePct" class="input mb-2" placeholder="e.g. 1.5" />
            <div class="flex gap-2">
              <button id="proposeFeeBtn" class="btn">Propose</button>
              <button id="executeFeeBtn" class="btn">Execute</button>
            </div>
            <div id="feeMsg" class="text-sm text-[var(--muted)] mt-2"></div>
          </div>
          <div class="card p-4">
            <div class="font-bold mb-2">Cancel Work Order</div>
            <label class="text-xs text-[var(--muted)]">Work Order ID</label>
            <input id="cwId" class="input mb-2" placeholder="e.g. 1" />
            <button id="cancelBtn" class="btn">Cancel</button>
            <div id="cwMsg" class="text-sm text-[var(--muted)] mt-2"></div>
          </div>
          <div class="card p-4">
            <div class="font-bold mb-2">Pause / Unpause</div>
            <div class="flex gap-2">
              <button id="pauseBtn" class="btn">Pause</button>
              <button id="unpauseBtn" class="btn">Unpause</button>
            </div>
            <div id="pauseMsg" class="text-sm text-[var(--muted)] mt-2"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="text-xs text-[var(--muted)]">
      <div>Contract: <span class="mono">0xae2C05f01DBCC6C8AF40EbFA3339Af10dbECdFD0</span></div>
    </section>
  </main>

  <script>
  (function(){
    const { BrowserProvider, Contract, formatUnits, parseUnits } = ethers;

    const CONTRACT_ADDR = "0xae2C05f01DBCC6C8AF40EbFA3339Af10dbECdFD0";

    const ABI = [
      {"inputs":[{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
      {"inputs":[{"internalType":"address","name":"target","type":"address"}],"name":"AddressCallToNonContract","type":"error"},
      {"inputs":[],"name":"AddressEmptyRevertData","type":"error"},
      {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"AddressInsufficientBalance","type":"error"},
      {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},
      {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},
      {"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"burner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Burn","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdrawn","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"FeeChangeExecuted","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"proposedAt","type":"uint256"}],"name":"FeeChangeProposed","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesWithdrawn","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalId","type":"uint256"}],"name":"MintExecuted","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"grossYield","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"},{"indexed":false,"internalType":"uint256","name":"proposedAt","type":"uint256"}],"name":"MintProposed","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"RedemptionFeeSet","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"reserveAmount","type":"uint256"}],"name":"ReserveFunded","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"holder","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdcAmount","type":"uint256"}],"name":"TokensRedeemed","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"}],"name":"WorkOrderCancelled","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"grossYield","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"}],"name":"WorkOrderMinted","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"payoutAmount","type":"uint256"}],"name":"WorkOrderPaid","type":"event"},
      {"inputs":[],"name":"PROPOSAL_DELAY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"RESERVE_PERCENTAGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"TOKENIZATION_PERCENTAGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"availableTokens","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"usdcAmount","type":"uint256"},{"internalType":"uint256","name":"minTokensOut","type":"uint256"}],"name":"buyTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"workOrderId","type":"uint256"}],"name":"cancelWorkOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"collectedFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"contractPaymentTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"tokenAddress","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"executeFeeChange","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"proposalId","type":"uint256"}],"name":"executeMint","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"mtyldAmount","type":"uint256"}],"name":"getRedemptionValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"usdcAmount","type":"uint256"}],"name":"getTokensForUSDC","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"endId","type":"uint256"}],"name":"getWorkOrderRange","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"internalType":"uint256","name":"reserveAmount","type":"uint256"},{"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isPaid","type":"bool"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"createdAt","type":"uint256"}],"internalType":"struct MechanicalTempYieldToken.WorkOrder[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"nextProposalId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"nextWorkOrderId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"paymentToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"workOrderId","type":"uint256"},{"internalType":"uint256","name":"payoutAmount","type":"uint256"}],"name":"payoutWorkOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"pendingFeeChange","outputs":[{"internalType":"uint256","name":"newFeePercentage","type":"uint256"},{"internalType":"uint256","name":"proposedAt","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"pendingMints","outputs":[{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"proposedAt","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"proposeFeeChange","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"string","name":"description","type":"string"}],"name":"proposeMint","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"mtyldAmount","type":"uint256"},{"internalType":"uint256","name":"minUsdcOut","type":"uint256"}],"name":"redeemTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"redemptionFeePercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"totalReserveFund","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"withdrawFees","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"workOrders","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"internalType":"uint256","name":"reserveAmount","type":"uint256"},{"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isPaid","type":"bool"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"createdAt","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    const ERC20_ABI = [
      {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    let provider, signer, contract, account, tokenDecimals=18, payTokenAddr, payToken, payDecimals=6, ownerAddr;

    // UI helpers
    const $ = (id)=>document.getElementById(id);
    const setText = (id, txt)=>{ const el=$(id); if(el) el.textContent=txt; };
    const fmt = (v, d=2)=> new Intl.NumberFormat(undefined,{maximumFractionDigits:d}).format(v);
    const short = (a)=> a? (a.slice(0,6)+"…"+a.slice(-4)) : "";

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.tabPanel').forEach(x=>x.classList.add('hidden'));
        t.classList.add('active');
        $(t.dataset.tab).classList.remove('hidden');
      });
    });

    async function connect(){
      if(!window.ethereum){ alert('Please install MetaMask'); return; }
      provider = new BrowserProvider(window.ethereum);
      await provider.send('eth_requestAccounts',[]);
      signer = await provider.getSigner();
      account = await signer.getAddress();
      contract = new Contract(CONTRACT_ADDR, ABI, signer);

      const net = await provider.getNetwork();
      setText('network', `Network: ${net.name||'Unknown'} (${Number(net.chainId)})`);
      setText('addrShort', short(account));

      await loadStatic();
      await refreshOverview();
      await refreshWorkOrders();
      await gateAdmin();

      // listeners
      if(window.ethereum){
        window.ethereum.on('accountsChanged',()=>location.reload());
        window.ethereum.on('chainChanged',()=>location.reload());
      }
    }

    async function loadStatic(){
      const [name, sym, dec, owner, payAddr, feePct] = await Promise.all([
        contract.name(), contract.symbol(), contract.decimals(), contract.owner(), contract.paymentToken(), contract.redemptionFeePercentage()
      ]);
      tokenDecimals = Number(dec);
      ownerAddr = owner;
      setText('tokenName', name);
      setText('tokenSymbol', sym);
      setText('redeemFee', feePct.toString());
      setText('payAddr', short(payAddr));
      payTokenAddr = payAddr;
      payToken = new Contract(payTokenAddr, ERC20_ABI, signer);
      const [ps, pdec] = await Promise.all([payToken.symbol(), payToken.decimals()]);
      setText('paySym', ps);
      payDecimals = Number(pdec);
    }

    async function refreshOverview(){
      const [ts, bal, avail, resv] = await Promise.all([
        contract.totalSupply(), contract.balanceOf(account), contract.availableTokens(), contract.totalReserveFund()
      ]);
      setText('totalSupply', fmt(Number(formatUnits(ts, tokenDecimals))));
      setText('myBalance', fmt(Number(formatUnits(bal, tokenDecimals))));
      setText('availableTokens', fmt(Number(formatUnits(avail, tokenDecimals))));
      setText('reserve', fmt(Number(formatUnits(resv, payDecimals))));
    }

    // Buy flow
    $('buyUsdc').addEventListener('input', estimateBuy);
    $('buySlip').addEventListener('input', estimateBuy);

    async function estimateBuy(){
      try{
        if(!contract) return; 
        const amt = Number($('buyUsdc').value||0);
        if(amt<=0){ setText('estTokens','0'); return; }
        const usdcWei = parseUnits(String(amt), payDecimals);
        const out = await contract.getTokensForUSDC(usdcWei);
        setText('estTokens', fmt(Number(formatUnits(out, tokenDecimals))));
      }catch(e){ /* ignore preview errors */ }
    }

    $('approveBtn').addEventListener('click', async()=>{
      try{
        $('approveBtn').disabled = true;
        const amt = Number($('buyUsdc').value||0);
        if(amt<=0) throw new Error('Enter USDC amount');
        const usdcWei = parseUnits(String(amt), payDecimals);
        const tx = await payToken.approve(CONTRACT_ADDR, usdcWei);
        $('buyMsg').textContent = 'Approving…';
        await tx.wait();
        $('buyMsg').textContent = 'USDC approved.';
      }catch(err){ $('buyMsg').textContent = err.shortMessage || err.message; }
      finally{ $('approveBtn').disabled = false; }
    });

    $('buyBtn').addEventListener('click', async()=>{
      try{
        $('buyBtn').disabled = true;
        const amt = Number($('buyUsdc').value||0);
        const slip = Number($('buySlip').value||0);
        if(amt<=0) throw new Error('Enter USDC amount');
        const usdcWei = parseUnits(String(amt), payDecimals);
        const exp = await contract.getTokensForUSDC(usdcWei);
        const minOut = exp - (exp * BigInt(Math.floor(slip*100)) / BigInt(10000)); // slip% 
        const tx = await contract.buyTokens(usdcWei, minOut);
        $('buyMsg').textContent = 'Buying…';
        await tx.wait();
        $('buyMsg').textContent = 'Success!';
        await refreshOverview();
      }catch(err){ $('buyMsg').textContent = err.shortMessage || err.message; }
      finally{ $('buyBtn').disabled = false; }
    });

    // Redeem flow
    $('redeemAmt').addEventListener('input', estimateRedeem);
    $('redeemSlip').addEventListener('input', estimateRedeem);

    async function estimateRedeem(){
      try{
        if(!contract) return; 
        const amt = Number($('redeemAmt').value||0);
        if(amt<=0){ setText('estUsdc','0'); return; }
        const wei = parseUnits(String(amt), tokenDecimals);
        const out = await contract.getRedemptionValue(wei);
        setText('estUsdc', fmt(Number(formatUnits(out, payDecimals))));
      }catch(e){ }
    }

    $('redeemBtn').addEventListener('click', async()=>{
      try{
        $('redeemBtn').disabled = true;
        const amt = Number($('redeemAmt').value||0);
        const slip = Number($('redeemSlip').value||0);
        if(amt<=0) throw new Error('Enter MTYLD amount');
        const wei = parseUnits(String(amt), tokenDecimals);
        const exp = await contract.getRedemptionValue(wei);
        const minOut = exp - (exp * BigInt(Math.floor(slip*100)) / BigInt(10000));
        const tx = await contract.redeemTokens(wei, minOut);
        $('redeemMsg').textContent = 'Redeeming…';
        await tx.wait();
        $('redeemMsg').textContent = 'Redeemed!';
        await refreshOverview();
      }catch(err){ $('redeemMsg').textContent = err.shortMessage || err.message; }
      finally{ $('redeemBtn').disabled = false; }
    });

    // Work Orders
    $('refreshWO').addEventListener('click', refreshWorkOrders);
    async function refreshWorkOrders(){
      try{
        if(!contract) return;
        const nextId = await contract.nextWorkOrderId();
        const last = Number(nextId) - 1;
        if(last <= 0){ $('woList').innerHTML = '<div class="text-sm text-[var(--muted)]">No work orders yet.</div>'; return; }
        const start = Math.max(1, last - 9);
        const arr = await contract.getWorkOrderRange(start, last);
        const html = arr.toReversed().map(w=> renderWO(w)).join('');
        $('woList').innerHTML = html;
      }catch(err){ $('woList').innerHTML = `<div class='text-sm text-red-300'>${err.shortMessage || err.message}</div>`; }
    }

    function renderWO(w){
      const created = new Date(Number(w.createdAt)*1000);
      const badge = w.isPaid? '✅ Paid' : (w.isActive? '🟢 Active' : '⚪ Inactive');
      return `<div class="card p-4">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <div class="font-bold">WO #${w.id} — ${escapeHtml(w.description||'')}</div>
          <div class="pill">${badge}</div>
        </div>
        <div class="grid-3 mt-3">
          <div>
            <div class="text-xs text-[var(--muted)]">Gross Yield</div>
            <div class="font-semibold">${fmt(Number(ethers.formatUnits(w.grossYield, payDecimals)))}</div>
          </div>
          <div>
            <div class="text-xs text-[var(--muted)]">Tokenized Value</div>
            <div class="font-semibold">${fmt(Number(ethers.formatUnits(w.tokenizedValue, payDecimals)))}</div>
          </div>
          <div>
            <div class="text-xs text-[var(--muted)]">Reserve</div>
            <div class="font-semibold">${fmt(Number(ethers.formatUnits(w.reserveAmount, payDecimals)))}</div>
          </div>
        </div>
        <div class="grid-3 mt-3">
          <div>
            <div class="text-xs text-[var(--muted)]">Tokens Issued</div>
            <div class="font-semibold">${fmt(Number(ethers.formatUnits(w.tokensIssued, tokenDecimals)))}</div>
          </div>
          <div>
            <div class="text-xs text-[var(--muted)]">Created</div>
            <div class="font-semibold">${created.toLocaleString()}</div>
          </div>
          <div>
            <div class="text-xs text-[var(--muted)]">Flags</div>
            <div class="font-semibold">${w.isActive?'Active':''} ${w.isPaid?'• Paid':''}</div>
          </div>
        </div>
      </div>`;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"]+/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[s]));
    }

    // Admin gates
    async function gateAdmin(){
      const me = account?.toLowerCase();
      const isOwner = me && ownerAddr?.toLowerCase() === me;
      $('adminGate').classList.toggle('hidden', !!isOwner);
      // disable all inputs/buttons under admin when not owner
      document.querySelectorAll('#adminTab input, #adminTab button').forEach(el=>{
        if(el.id.endsWith('Btn')) el.disabled = !isOwner; else el.disabled = !isOwner;
      });
    }

    // Admin actions
    $('proposeMintBtn').addEventListener('click', async()=>{
      try{
        const gross = Number($('pmGross').value||0);
        const desc = $('pmDesc').value||'';
        if(gross<=0) throw new Error('Enter gross yield');
        const wei = parseUnits(String(gross), payDecimals);
        const tx = await contract.proposeMint(wei, desc);
        $('pmMsg').textContent = 'Submitting…';
        const rc = await tx.wait();
        $('pmMsg').textContent = 'Proposed. Tx confirmed.';
      }catch(err){ $('pmMsg').textContent = err.shortMessage || err.message; }
    });

    $('executeMintBtn').addEventListener('click', async()=>{
      try{
        const id = BigInt($('emId').value||'0');
        if(id<=0n) throw new Error('Enter proposal id');
        const tx = await contract.executeMint(id);
        $('emMsg').textContent = 'Executing…';
        await tx.wait();
        $('emMsg').textContent = 'Mint executed.';
        await refreshOverview();
        await refreshWorkOrders();
      }catch(err){ $('emMsg').textContent = err.shortMessage || err.message; }
    });

    $('payoutBtn').addEventListener('click', async()=>{
      try{
        const id = BigInt($('pwId').value||'0');
        const amt = Number($('pwAmt').value||0);
        if(id<=0n || amt<=0) throw new Error('Enter id and amount');
        const wei = parseUnits(String(amt), payDecimals);
        const tx = await contract.payoutWorkOrder(id, wei);
        $('pwMsg').textContent = 'Paying out…';
        await tx.wait();
        $('pwMsg').textContent = 'Paid.';
        await refreshOverview();
        await refreshWorkOrders();
      }catch(err){ $('pwMsg').textContent = err.shortMessage || err.message; }
    });

    $('proposeFeeBtn').addEventListener('click', async()=>{
      try{
        const pct = Number($('feePct').value||0);
        // Contract expects a raw integer percentage (e.g., 1 or 2). If it expects bps, adjust here.
        const tx = await contract.proposeFeeChange(parseUnits(String(pct), 0));
        $('feeMsg').textContent = 'Proposing…';
        await tx.wait();
        $('feeMsg').textContent = 'Proposed.';
      }catch(err){ $('feeMsg').textContent = err.shortMessage || err.message; }
    });

    $('executeFeeBtn').addEventListener('click', async()=>{
      try{
        const tx = await contract.executeFeeChange();
        $('feeMsg').textContent = 'Executing…';
        await tx.wait();
        $('feeMsg').textContent = 'Executed.';
        await loadStatic();
      }catch(err){ $('feeMsg').textContent = err.shortMessage || err.message; }
    });

    $('cancelBtn').addEventListener('click', async()=>{
      try{
        const id = BigInt($('cwId').value||'0');
        if(id<=0n) throw new Error('Enter id');
        const tx = await contract.cancelWorkOrder(id);
        $('cwMsg').textContent = 'Cancelling…';
        await tx.wait();
        $('cwMsg').textContent = 'Cancelled.';
        await refreshWorkOrders();
      }catch(err){ $('cwMsg').textContent = err.shortMessage || err.message; }
    });

    $('pauseBtn').addEventListener('click', async()=>{
      try{ const tx = await contract.pause(); $('pauseMsg').textContent='Pausing…'; await tx.wait(); $('pauseMsg').textContent='Paused.'; }
      catch(err){ $('pauseMsg').textContent = err.shortMessage || err.message; }
    });
    $('unpauseBtn').addEventListener('click', async()=>{
      try{ const tx = await contract.unpause(); $('pauseMsg').textContent='Unpausing…'; await tx.wait(); $('pauseMsg').textContent='Unpaused.'; }
      catch(err){ $('pauseMsg').textContent = err.shortMessage || err.message; }
    });

    // Wire connect
    $('connectBtn').addEventListener('click', connect);

  })();
  </script>
</body>
</html>
