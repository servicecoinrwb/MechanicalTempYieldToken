<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YieldWorks Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js" type="application/javascript"></script>

    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent: #00b894; /* Teal accent */
            --border-color: #3a3a3a;
            --red: #ef4444;
            --yellow: #facc15; /* yellow-500 */
            --green: #4ade80; /* green-500 */
        }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', sans-serif; }
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .btn { display: inline-block; font-weight: 600; text-align: center; border-radius: 0.5rem; transition: all 0.2s ease; border: 2px solid transparent; padding: 0.6rem 1.2rem; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
        .btn-primary:hover:not(:disabled) { background-color: transparent; color: var(--accent); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-color); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--bg-secondary); border-color: var(--text-secondary); }
        .btn-danger { background-color: var(--red); color: white; border-color: var(--red); }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; border-color: #dc2626; }
        input[type="text"], input[type="number"], input[type="password"], textarea, select { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.3); }
        label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-secondary); font-weight: 500; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 0.875rem; }
        th { background-color: var(--bg-tertiary); font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: var(--bg-tertiary); }
        .alert { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem; }
        .alert-info { background-color: #0c4a6e; color: #bae6fd; } /* sky-900 / sky-200 */
        .alert-success { background-color: #166534; color: #bbf7d0; } /* green-800 / green-200 */
        .alert-warning { background-color: #854d0e; color: #fef08a; } /* amber-800 / amber-200 */
        .alert-error { background-color: #991b1b; color: #fecaca; } /* red-800 / red-200 */
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; margin-right: 0.5rem; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-select { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 0.375rem; padding: 0.5rem 0.75rem; height: 42px; }
        .filter-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.3); }
        .paused-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 100; display: flex; align-items: center; justify-content: center; text-align: center; }
        .proposal-card { background-color: var(--bg-tertiary); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); margin-top: 1rem; font-size: 0.875rem; }
        .text-green { color: var(--green); }
        .text-yellow { color: var(--yellow); }
        .text-red { color: var(--red); }
        .bg-green { background-color: var(--green); }
        .bg-yellow { background-color: var(--yellow); }
        .text-green-foreground { color: #052e16; } /* Example dark green */
        .text-yellow-foreground { color: #713f12; } /* Example dark yellow */

    </style>
</head>
<body class="min-h-screen pb-16">

    <!-- Paused Overlay -->
    <div id="paused-overlay" class="paused-overlay hidden">
        <div class="bg-secondary p-8 rounded-lg shadow-xl max-w-md">
            <h2 class="text-2xl font-bold text-yellow mb-4">Contract Paused</h2>
            <p class="text-secondary mb-6">Contract operations are temporarily paused by the owner. Please check back later.</p>
            <p class="text-xs text-secondary">(Only view functions and unpausing by the owner are available.)</p>
        </div>
    </div>


    <nav class="bg-secondary sticky top-0 z-50 shadow-lg mb-8">
        <div class="container mx-auto max-w-7xl p-4 flex justify-between items-center">
            <!-- Logo Added -->
            <a href="index.html" class="flex items-center space-x-2">
                 <img src="https://imageview.replit.app/objects/uploads/254102d8-5988-4774-bb48-a191db030456" alt="YieldWorks Logo" class="h-10 w-auto">
                 <span class="text-2xl font-bold hidden sm:inline-block">YieldWorks</span>
                 <!-- <span class="text-sm font-normal text-secondary hidden sm:inline-block ml-2">by Mechanical Temp</span> -->
            </a>
            <div class="flex items-center space-x-4">
                 <span id="pause-status-indicator" class="hidden text-xs font-bold px-3 py-1 rounded-full"></span>
                 <button id="connect-button" class="btn btn-primary">Connect Wallet</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto max-w-7xl px-4">

        <!-- Status Messages -->
        <div id="status-message" class="hidden"></div>

        <!-- Wallet Info -->
        <div id="wallet-info" class="card hidden">
            <h2 class="text-xl font-bold mb-3">Wallet Connected</h2>
            <p class="text-sm"><strong>Network:</strong> <span id="network-name"></span></p>
            <p class="text-sm truncate"><strong>Address:</strong> <span id="user-address"></span></p>
            <p class="text-sm"><strong>USDC Balance:</strong> <span id="usdc-balance">Loading...</span></p>
            <p class="text-sm"><strong>MTYLD Balance:</strong> <span id="mtyld-balance">Loading...</span></p>
        </div>

        <!-- Protocol Info -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">Protocol Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div><strong>Token:</strong> <span id="token-name">Loading...</span> (<span id="token-symbol">---</span>)</div>
                <div><strong>Total Supply:</strong> <span id="total-supply">Loading...</span> MTYLD</div>
                <div class="md:col-span-2 lg:col-span-1"><strong>Contract Address:</strong> <a id="contract-address-link" href="#" target="_blank" rel="noopener noreferrer" class="text-accent hover:underline break-all">Loading...</a></div>
                <div><strong>Contract USDC:</strong> <span id="contract-usdc">Loading...</span> USDC</div>
                <div><strong>Current Price:</strong> <span id="mtyld-price">Loading...</span> USDC/MTYLD</div>
                <div><strong>Available for Sale:</strong> <span id="available-mtyld">Loading...</span> MTYLD</div>
                <div><strong>Proposal Delay:</strong> <span id="proposal-delay">Loading...</span> seconds</div>
            </div>
        </div>

        <!-- Pending Mint Proposals Section -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">Pending Mint Proposals</h2>
            <div class="overflow-x-auto">
                <table id="pending-mints-table">
                    <thead>
                        <tr>
                            <th>Proposal ID</th>
                            <th>Description</th>
                            <th>Gross Yield (USDC)</th>
                            <th>Proposed At</th>
                            <th>Executable After</th>
                        </tr>
                    </thead>
                    <tbody id="pending-mints-body">
                        <tr><td colspan="5" class="text-center py-4 text-secondary">Loading pending proposals...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>


        <!-- Buy / Redeem Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Buy Card -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Buy MTYLD</h2>
                <form id="buy-form">
                    <div class="mb-4">
                        <label for="buy-usdc-amount">USDC Amount to Spend</label>
                        <input type="number" id="buy-usdc-amount" step="0.01" min="0" placeholder="e.g., 100.00" required>
                        <p class="text-xs text-secondary mt-1">Your USDC Balance: <span id="buy-usdc-balance">--</span></p>
                    </div>
                     <div class="mb-4">
                        <label for="buy-slippage">Slippage Tolerance (%)</label>
                        <select id="buy-slippage" class="bg-tertiary">
                            <option value="0.5">0.5%</option>
                            <option value="1">1%</option>
                            <option value="2">2%</option>
                        </select>
                    </div>
                    <div class="mb-4 text-sm bg-tertiary p-3 rounded">
                        Estimated MTYLD to Receive: <span id="estimated-mtyld" class="font-bold">0.00</span>
                        <input type="hidden" id="min-tokens-out">
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="button" id="approve-usdc-button" class="btn btn-secondary flex-1">Approve USDC</button>
                        <button type="submit" id="buy-button" class="btn btn-primary flex-1" disabled>Buy MTYLD</button>
                    </div>
                </form>
            </div>

            <!-- Redeem Card -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Redeem MTYLD</h2>
                <form id="redeem-form">
                    <div class="mb-4">
                        <label for="redeem-mtyld-amount">MTYLD Amount to Redeem</label>
                        <input type="number" id="redeem-mtyld-amount" step="0.01" min="0" placeholder="e.g., 500.00" required>
                        <p class="text-xs text-secondary mt-1">Your MTYLD Balance: <span id="redeem-mtyld-balance">--</span></p>
                    </div>
                    <div class="mb-4">
                        <label for="redeem-slippage">Slippage Tolerance (%)</label>
                        <select id="redeem-slippage" class="bg-tertiary">
                            <option value="0.5">0.5%</option>
                            <option value="1">1%</option>
                            <option value="2">2%</option>
                        </select>
                    </div>
                    <div class="mb-4 text-sm bg-tertiary p-3 rounded">
                        Estimated USDC to Receive (after fee): <span id="estimated-usdc" class="font-bold">0.00</span>
                        <input type="hidden" id="min-usdc-out">
                         <p class="text-xs text-secondary mt-1">Redemption Fee: <span id="redeem-fee-percent">--</span>%</p>
                    </div>
                    <button type="submit" id="redeem-button" class="btn btn-primary w-full">Redeem MTYLD</button>
                </form>
            </div>
        </div>

        <!-- Work Orders Table Section -->
         <div class="card mt-6">
             <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                 <h2 class="text-xl font-bold mb-3 sm:mb-0">Completed/Active Work Orders</h2>
                 <div class="flex items-center space-x-3">
                     <label for="filter-month" class="text-sm text-secondary whitespace-nowrap">Filter by:</label>
                     <select id="filter-month" class="filter-select w-32">
                         <option value="all">All Months</option>
                         <option value="0">January</option> <option value="1">February</option> <option value="2">March</option>
                         <option value="3">April</option> <option value="4">May</option> <option value="5">June</option>
                         <option value="6">July</option> <option value="7">August</option> <option value="8">September</option>
                         <option value="9">October</option> <option value="10">November</option> <option value="11">December</option>
                     </select>
                     <select id="filter-year" class="filter-select w-28"> <option value="all">All Years</option> </select>
                 </div>
             </div>
             <div class="overflow-x-auto">
                 <table id="work-orders-table">
                     <thead>
                         <tr>
                             <th>ID</th><th>Description</th><th>Gross (USDC)</th><th>Tokenized (USDC)</th>
                             <th>Issued (MTYLD)</th><th>Status</th><th>Created</th>
                         </tr>
                     </thead>
                     <tbody id="work-orders-body"><tr><td colspan="7" class="text-center py-4 text-secondary">Loading work orders...</td></tr></tbody>
                 </table>
             </div>
         </div>


        <!-- Admin Panel (Initially hidden) -->
        <div id="admin-panel" class="card mt-8 hidden">
            <h2 class="text-2xl font-bold mb-6 text-center text-accent">Admin Panel</h2>
            <div class="bg-tertiary p-4 rounded-lg border border-border-color mb-6 text-center">
                 <h3 class="text-lg font-semibold mb-3">Pause Control</h3>
                 <p class="text-xs text-secondary mb-3">Pause contract interactions in case of emergency.</p>
                 <div class="flex justify-center gap-4">
                      <button id="pause-button" class="btn btn-danger w-40">Pause Contract</button>
                      <button id="unpause-button" class="btn btn-primary w-40">Unpause Contract</button>
                 </div>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <form id="propose-mint-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                    <h3 class="text-lg font-semibold mb-3">1. Propose New Work Order</h3>
                    <div class="mb-3"><label for="propose-yield">Gross Yield (USDC)</label><input type="number" id="propose-yield" step="0.01" min="0.01" placeholder="e.g., 1000.00" required></div>
                    <div class="mb-3"><label for="propose-desc">Description</label><input type="text" id="propose-desc" placeholder="e.g., Install #12345" required></div>
                    <button type="submit" class="btn btn-secondary w-full">Propose Mint</button>
                </form>
                 <div class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">2. Execute Pending Mint</h3>
                     <div class="mb-3"><label for="execute-mint-id">Proposal ID to Execute</label><input type="number" id="execute-mint-id" min="1" placeholder="Enter ID from proposal" required></div>
                     <div id="pending-mint-details" class="proposal-card hidden"></div>
                     <button id="execute-mint-button" class="btn btn-primary w-full mt-3" disabled>Execute Mint (after delay)</button>
                 </div>
            </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                 <form id="payout-order-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Payout Work Order</h3>
                     <p class="text-xs text-secondary mb-3">Pay back Tokenized Value to mark complete.</p>
                      <div class="mb-3"><label for="payout-id">Work Order ID</label><input type="number" id="payout-id" min="1" placeholder="e.g., 1" required></div>
                    <div class="mb-3"><label for="payout-amount">Payout Amount (USDC)</label><input type="number" id="payout-amount" step="0.01" min="0.01" placeholder="Must equal Tokenized Value" required><p class="text-xs text-secondary mt-1">Order Tokenized Value: <span id="payout-tokenized-value">--</span></p></div>
                     <p class="text-xs text-secondary mb-3">Requires prior USDC approval.</p>
                      <div class="flex gap-3"><button type="button" id="admin-approve-usdc-button" class="btn btn-secondary flex-1">Approve USDC</button><button type="submit" class="btn btn-primary flex-1">Submit Payout</button></div>
                 </form>
                 <form id="cancel-order-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Cancel Work Order</h3>
                      <p class="text-xs text-secondary mb-3">Deactivate order (no token burn).</p>
                     <div class="mb-3"><label for="cancel-id">Work Order ID</label><input type="number" id="cancel-id" min="1" placeholder="e.g., 1" required></div>
                     <button type="submit" class="btn btn-danger w-full">Cancel Order</button>
                 </form>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <form id="propose-fee-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">1. Propose Fee Change</h3>
                     <div class="mb-3"><label for="propose-new-fee">New Fee % (0-20)</label><input type="number" id="propose-new-fee" min="0" max="20" step="0.1" placeholder="e.g., 10" required></div>
                      <p class="text-xs text-secondary mb-3">Current Fee: <span id="current-redeem-fee">--</span>%</p>
                     <button type="submit" class="btn btn-secondary w-full">Propose Fee Change</button>
                 </form>
                 <div class="bg-tertiary p-4 rounded-lg border border-border-color">
                      <h3 class="text-lg font-semibold mb-3">2. Execute Fee Change</h3>
                      <div id="pending-fee-details" class="proposal-card hidden"></div>
                      <button id="execute-fee-button" class="btn btn-primary w-full mt-3" disabled>Execute Fee Change (after delay)</button>
                 </div>
                <div class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Withdraw Fees</h3>
                     <p class="text-sm mb-3">Collected Fees: <span id="collected-fees" class="font-bold">Loading...</span> USDC</p>
                    <button id="withdraw-fees-button" class="btn btn-secondary w-full" disabled>Withdraw All Fees</button>
                 </div>
            </div>
             <form id="emergency-withdraw-form" class="bg-tertiary p-4 rounded-lg border border-border-color mt-6">
                 <h3 class="text-lg font-semibold mb-3">Emergency Withdraw (Owner Only)</h3>
                 <p class="text-xs text-secondary mb-3">Withdraw non-USDC ERC20 tokens.</p>
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                     <div><label for="emergency-token">Token Address (Non-USDC)</label><input type="text" id="emergency-token" placeholder="0x..." required></div>
                     <div><label for="emergency-to">Recipient Address</label><input type="text" id="emergency-to" placeholder="0x..." required></div>
                      <div><label for="emergency-amount">Amount (Raw Units)</label><input type="number" id="emergency-amount" min="1" placeholder="e.g., 1000..." required></div>
                 </div>
                 <button type="submit" class="btn btn-danger w-full mt-3">Withdraw Other Token</button>
             </form>
        </div>

    </main>

    <script type="text/javascript">
        // --- CONFIGURATION ---
        const contractAddress = "0xae2C05f01DBCC6C8AF40EbFA3339Af10dbECdFD0";
        const contractABI = [{"inputs":[{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"target","type":"address"}],"name":"AddressCallToNonContract","type":"error"},{"inputs":[],"name":"AddressEmptyRevertData","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"AddressInsufficientBalance","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"burner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Burn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"FeeChangeExecuted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"proposedAt","type":"uint256"}],"name":"FeeChangeProposed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalId","type":"uint256"}],"name":"MintExecuted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"grossYield","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"},{"indexed":false,"internalType":"uint256","name":"proposedAt","type":"uint256"}],"name":"MintProposed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"RedemptionFeeSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"reserveAmount","type":"uint256"}],"name":"ReserveFunded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"holder","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdcAmount","type":"uint256"}],"name":"TokensRedeemed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"}],"name":"WorkOrderCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"grossYield","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"}],"name":"WorkOrderMinted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WorkOrderPaid","type":"event"},{"inputs":[],"name":"PROPOSAL_DELAY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"RESERVE_PERCENTAGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TOKENIZATION_PERCENTAGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"availableTokens","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount","type":"uint256"},{"internalType":"uint256","name":"minTokensOut","type":"uint256"}],"name":"buyTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"workOrderId","type":"uint256"}],"name":"cancelWorkOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"collectedFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"contractPaymentTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"tokenAddress","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeFeeChange","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"proposalId","type":"uint256"}],"name":"executeMint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"mtyldAmount","type":"uint256"}],"name":"getRedemptionValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount","type":"uint256"}],"name":"getTokensForUSDC","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"endId","type":"uint256"}],"name":"getWorkOrderRange","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"internalType":"uint256","name":"reserveAmount","type":"uint256"},{"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isPaid","type":"bool"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"createdAt","type":"uint256"}],"internalType":"struct MechanicalTempYieldToken.WorkOrder[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextProposalId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextWorkOrderId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paymentToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"workOrderId","type":"uint256"},{"internalType":"uint256","name":"payoutAmount","type":"uint256"}],"name":"payoutWorkOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pendingFeeChange","outputs":[{"internalType":"uint256","name":"newFeePercentage","type":"uint256"},{"internalType":"uint256","name":"proposedAt","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"pendingMints","outputs":[{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"proposedAt","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"proposeFeeChange","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"string","name":"description","type":"string"}],"name":"proposeMint","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"mtyldAmount","type":"uint256"},{"internalType":"uint256","name":"minUsdcOut","type":"uint256"}],"name":"redeemTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"redemptionFeePercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalReserveFund","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"workOrders","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"internalType":"uint256","name":"reserveAmount","type":"uint256"},{"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isPaid","type":"bool"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"createdAt","type":"uint256"}],"stateMutability":"view","type":"function"}]; // <-- NEW ABI
        const usdcAddress = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831"; // Arbitrum Native USDC
        const arbitrumChainId = '0xa4b1'; // 42161 in hex

        // --- DOM Elements ---
        const connectButton = document.getElementById('connect-button');
        const statusMessageDiv = document.getElementById('status-message');
        const walletInfoDiv = document.getElementById('wallet-info');
        const networkNameSpan = document.getElementById('network-name');
        const userAddressSpan = document.getElementById('user-address');
        const usdcBalanceSpan = document.getElementById('usdc-balance');
        const mtyldBalanceSpan = document.getElementById('mtyld-balance');
        const buyUsdcBalanceSpan = document.getElementById('buy-usdc-balance');
        const redeemMtyldBalanceSpan = document.getElementById('redeem-mtyld-balance');

        // Protocol Info Elements
        const tokenNameSpan = document.getElementById('token-name');
        const tokenSymbolSpan = document.getElementById('token-symbol');
        const totalSupplySpan = document.getElementById('total-supply');
        const contractAddressLink = document.getElementById('contract-address-link');
        const contractUsdcSpan = document.getElementById('contract-usdc');
        const mtyldPriceSpan = document.getElementById('mtyld-price');
        const availableMtyldSpan = document.getElementById('available-mtyld');
        const proposalDelaySpan = document.getElementById('proposal-delay');

        // Buy Form Elements
        const buyForm = document.getElementById('buy-form');
        const buyUsdcAmountInput = document.getElementById('buy-usdc-amount');
        const buySlippageSelect = document.getElementById('buy-slippage');
        const estimatedMtyldSpan = document.getElementById('estimated-mtyld');
        const minTokensOutInput = document.getElementById('min-tokens-out');
        const approveUsdcButton = document.getElementById('approve-usdc-button');
        const buyButton = document.getElementById('buy-button');

        // Redeem Form Elements
        const redeemForm = document.getElementById('redeem-form');
        const redeemMtyldAmountInput = document.getElementById('redeem-mtyld-amount');
        const redeemSlippageSelect = document.getElementById('redeem-slippage');
        const estimatedUsdcSpan = document.getElementById('estimated-usdc');
        const minUsdcOutInput = document.getElementById('min-usdc-out');
        const redeemButton = document.getElementById('redeem-button');
        const redeemFeePercentSpan = document.getElementById('redeem-fee-percent');

        // Pending Mints Elements
        const pendingMintsTableBody = document.getElementById('pending-mints-body'); // Added


        // Work Orders Elements
        const workOrdersTableBody = document.getElementById('work-orders-body');
        const filterMonthSelect = document.getElementById('filter-month');
        const filterYearSelect = document.getElementById('filter-year');


        // Admin Panel Elements
        const adminPanelDiv = document.getElementById('admin-panel');
        const proposeMintForm = document.getElementById('propose-mint-form');
        const executeMintIdInput = document.getElementById('execute-mint-id');
        const pendingMintDetailsDiv = document.getElementById('pending-mint-details');
        const executeMintButton = document.getElementById('execute-mint-button');
        const payoutOrderForm = document.getElementById('payout-order-form');
        const payoutTokenizedValueSpan = document.getElementById('payout-tokenized-value');
        const payoutIdInput = document.getElementById('payout-id'); // Defined here
        const cancelOrderForm = document.getElementById('cancel-order-form');
        const proposeFeeForm = document.getElementById('propose-fee-form');
        const executeFeeButton = document.getElementById('execute-fee-button');
        const pendingFeeDetailsDiv = document.getElementById('pending-fee-details');
        const currentRedeemFeeSpan = document.getElementById('current-redeem-fee');
        const collectedFeesSpan = document.getElementById('collected-fees');
        const withdrawFeesButton = document.getElementById('withdraw-fees-button');
        const adminApproveUsdcButton = document.getElementById('admin-approve-usdc-button');
        const emergencyWithdrawForm = document.getElementById('emergency-withdraw-form');
        const pauseButton = document.getElementById('pause-button');
        const unpauseButton = document.getElementById('unpause-button');
        const pauseStatusIndicator = document.getElementById('pause-status-indicator');
        const pausedOverlay = document.getElementById('paused-overlay');

        // --- State Variables ---
        let provider = null;
        let signer = null;
        let userAddress = null;
        let mtyldContract = null;
        let usdcContract = null;
        let contractOwner = null;
        let usdcDecimals = 6;
        let mtyldDecimals = 18;
        let allWorkOrders = [];
        let availableYears = new Set();
        let currentProposalDelay = null; // Store proposal delay (BigInt)
        let blockTimestamp = null; // Store latest block timestamp (BigInt)


        // --- Helper Functions ---
        // ... (showStatus, formatUnits, parseUnits, formatDate, setLoading, shortenAddress, formatSeconds, calculateTimeRemaining functions remain the same) ...
        function showStatus(message, type = 'info') {
            statusMessageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            statusMessageDiv.classList.remove('hidden');
            const timeout = (type === 'error' || type === 'warning') ? 8000 : 5000;
            setTimeout(() => { statusMessageDiv.classList.add('hidden'); }, timeout);
        }
        function formatUnits(amount, decimals) {
            if (amount === null || amount === undefined) return '...';
            try { return ethers.formatUnits(amount, decimals); }
            catch (error) { console.error("FmtErr:", error, amount, decimals); return 'Err'; }
         }
         function parseUnits(amount, decimals) {
             try {
                const amountStr = String(amount).trim();
                if (!amountStr) throw new Error("Input empty");
                return ethers.parseUnits(amountStr, decimals);
             } catch (error) {
                 console.error("ParseErr:", error, amount, decimals);
                 showStatus(`Invalid input: '${amount}'. Valid number needed.`, 'error');
                 return null;
             }
         }
        function formatDate(timestamp) {
            if (!timestamp || timestamp === 0n) return { dateStr: 'N/A', month: -1, year: -1, fullDate: null };
            try {
                const date = new Date(Number(timestamp) * 1000);
                const dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'});
                const month = date.getMonth();
                const year = date.getFullYear();
                return { dateStr, month, year, fullDate: date };
            } catch {
                return { dateStr: 'Invalid Date', month: -1, year: -1, fullDate: null };
            }
        }
        function setLoading(button, isLoading, originalText) {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<span class="loading-spinner"></span> Processing...`;
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        function shortenAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }
        function formatSeconds(seconds) {
             if (seconds === null || seconds === undefined) return '...';
             const totalSeconds = Number(seconds);
             const d = Math.floor(totalSeconds / 86400);
             const h = Math.floor((totalSeconds % 86400) / 3600);
             const m = Math.floor((totalSeconds % 3600) / 60);
             const s = Math.floor(totalSeconds % 60);
             let parts = [];
             if (d > 0) parts.push(`${d}d`);
             if (h > 0) parts.push(`${h}h`);
             if (m > 0) parts.push(`${m}m`);
             if (s > 0 || parts.length === 0) parts.push(`${s}s`);
             return parts.join(' ');
        }
        function calculateTimeRemaining(futureTimestamp) {
            if (!blockTimestamp || !futureTimestamp || futureTimestamp <= blockTimestamp) {
                return "Now";
            }
            const remainingSeconds = futureTimestamp - blockTimestamp;
            return formatSeconds(remainingSeconds);
        }


        // --- Blockchain Interaction ---

        async function connectWallet() { /* ... (same as before) ... */ }

        // Combined function to load data after connection
        async function loadInitialData() { /* ... (same as before) ... */ }


        function resetState() { /* ... (same as before) ... */ }


        async function checkAdminStatus() { /* ... (same as before) ... */ }

        async function updateAdminInfo() { /* ... (same as before) ... */ }

         // Combined proposal check function
         async function checkPendingProposals() { /* ... (same as before) ... */ }


        // Helper to check and display pending mint details based on input ID (Admin Panel ONLY)
         let checkMintTimeout;
        async function checkPendingMintDetails() { /* ... (same as before) ... */ }


        async function updateWalletInfo() { /* ... (same as before) ... */ }

        async function updateProtocolInfo() { /* ... (same as before) ... */ }

        // --- Buy/Redeem Logic ---
        async function updateBuyEstimate() { /* ... (same as before) ... */ }
        async function updateRedeemEstimate() { /* ... (same as before) ... */ }
        async function handleApproveUSDC(isAdmin = false) { /* ... (same as before) ... */ }
        async function handleBuyTokens(event) { /* ... (same as before) ... */ }
        async function handleRedeemTokens(event) { /* ... (same as before) ... */ }


        // --- Work Order & Pending Proposal Display ---
        async function fetchAndStoreAllWorkOrders() { /* ... (same as before) ... */ }
        function populateYearFilter() { /* ... (same as before) ... */ }
        function filterAndRenderOrders() { /* ... (same as before) ... */ }
        function renderWorkOrdersTable(ordersToRender) { /* ... (same as before) ... */ }

        // Fetch and Render Pending Mint Proposals (Public View) - ADJUSTED
        async function fetchPendingProposals() {
             // Ensure contract and necessary info like delay are available
             if (!mtyldContract || currentProposalDelay === null) {
                 pendingMintsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-secondary">Connect wallet first or refresh data.</td></tr>';
                 return;
             }
             pendingMintsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-secondary">Loading pending proposals...</td></tr>';
             let pendingFound = false;
             try {
                 // Fetch nextWorkOrderId inside the function to ensure it's up-to-date
                 const nextId = await mtyldContract.nextWorkOrderId();
                 console.log("Next Proposal/Work Order ID:", nextId.toString());

                 if (nextId <= 1n) {
                     pendingMintsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-secondary">No proposals found.</td></tr>';
                     return;
                 }

                 const proposalPromises = [];
                 // Check a reasonable range of past IDs. Start from nextId - 1 down.
                 // Limit the check range to avoid excessive calls on contracts with many proposals.
                 const MAX_PROPOSALS_TO_CHECK = 50; // Check up to 50 previous IDs
                 const startCheckId = (nextId - 1n) > BigInt(MAX_PROPOSALS_TO_CHECK)
                                     ? (nextId - 1n) - BigInt(MAX_PROPOSALS_TO_CHECK) + 1n
                                     : 1n; // Start checking from 1 or (nextId - MAX_PROPOSALS_TO_CHECK)

                console.log(`Checking pending proposals from ID ${startCheckId} up to ${nextId - 1n}`);


                 for (let i = nextId - 1n; i >= startCheckId; i--) {
                      proposalPromises.push(
                          mtyldContract.pendingMints(i)
                             .then(p => ({id: i, proposal: p}))
                             .catch(e => {
                                 console.warn(`Error fetching pending mint ${i}:`, e);
                                 return null; // Return null if fetching a specific proposal fails
                             })
                      );
                 }

                 const results = await Promise.all(proposalPromises);
                 pendingMintsTableBody.innerHTML = ''; // Clear loading message

                 results.forEach(result => {
                      // Check if result is not null and proposal exists
                      if (result && result.proposal && result.proposal.exists) {
                           pendingFound = true;
                           const proposal = result.proposal;
                           const proposalId = result.id;
                           const { fullDate: proposedTime } = formatDate(proposal.proposedAt); // Get Date object
                           const delaySeconds = Number(currentProposalDelay); // Use stored delay
                           const executableTimestamp = proposal.proposedAt + BigInt(delaySeconds);
                           const { fullDate: executableDate } = formatDate(executableTimestamp); // Get Date object

                           const row = pendingMintsTableBody.insertRow();
                           row.innerHTML = `
                              <td>${proposalId}</td>
                              <td class="max-w-xs truncate" title="${proposal.description}">${proposal.description}</td>
                              <td>${parseFloat(formatUnits(proposal.grossYield, Number(usdcDecimals))).toFixed(2)}</td>
                              <td>${proposedTime ? proposedTime.toLocaleString() : 'N/A'}</td>
                              <td>${executableDate ? executableDate.toLocaleString() : 'N/A'} (${calculateTimeRemaining(executableTimestamp)} left)</td>
                           `;
                      }
                 });

                 if (!pendingFound) {
                      pendingMintsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-secondary">No pending mint proposals found.</td></tr>';
                 }

             } catch (error) {
                 console.error("Error fetching pending proposals:", error);
                 pendingMintsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red">Error loading proposals.</td></tr>';
             }
         }


        // --- Admin Actions (Updated for Timelock & Pause) ---
        async function handleProposeMint(event) { /* ... (same as before) ... */ }
        async function handleExecuteMint() { /* ... (same as before) ... */ }
        async function handlePayoutOrder(event) { /* ... (same as before) ... */ }
        async function handleCancelOrder(event) { /* ... (same as before) ... */ }
        async function handleProposeFeeChange(event) { /* ... (same as before) ... */ }
        async function handleExecuteFeeChange() { /* ... (same as before) ... */ }
        async function handleWithdrawFees() { /* ... (same as before) ... */ }
        async function handleEmergencyWithdraw(event) { /* ... (same as before) ... */ }
         // --- Pause/Unpause Logic ---
         async function handlePause() { /* ... (same as before) ... */ }
        async function handleUnpause() { /* ... (same as before) ... */ }
        function updatePauseUI(isPaused) { /* ... (same as before) ... */ }
        function updatePauseButtons(isPaused) { /* ... (same as before) ... */ }


        // --- Event Listeners Setup ---
         function setupEventListeners() { /* ... (same as before) ... */ }
         function setupWalletListeners() { /* ... (same as before) ... */ }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => { /* ... (same as before) ... */
             connectButton.addEventListener('click', connectWallet);
             setupEventListeners();
             workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">Connect wallet to view orders.</td></tr>';
             pendingMintsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-secondary">Connect wallet to view proposals.</td></tr>'; // Init pending table
             populateYearFilter();
        });

    </script>
</body>
</html>

