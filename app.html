<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YieldWorks Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js" type="application/javascript"></script>

    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --accent: #00b894; /* Teal accent */
            --border-color: #3a3a3a;
            --red: #ef4444;
            --yellow: #facc15;
            --green: #4ade80;
        }
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem; /* 12px */
            padding: 1.5rem; /* 24px */
            margin-bottom: 1.5rem;
        }
        .btn {
            display: inline-block;
            font-weight: 600;
            text-align: center;
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s ease;
            border: 2px solid transparent;
            padding: 0.6rem 1.2rem;
            cursor: pointer;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: transparent;
            color: var(--accent);
        }
        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--bg-secondary);
            border-color: var(--text-secondary);
        }
         .btn-danger {
            background-color: var(--red);
            color: white;
            border-color: var(--red);
         }
         .btn-danger:hover:not(:disabled) {
            background-color: #dc2626; /* red-600 */
            border-color: #dc2626;
         }
        input[type="text"], input[type="number"], input[type="password"], textarea, select {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.375rem; /* 6px */
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.3);
        }
        label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem; /* 14px */
            color: var(--text-secondary);
            font-weight: 500;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            font-size: 0.875rem;
        }
        th {
            background-color: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        tbody tr:hover {
            background-color: var(--bg-tertiary);
        }
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        .alert-info { background-color: #0c4a6e; color: #bae6fd; } /* sky-900 / sky-200 */
        .alert-success { background-color: #166534; color: #bbf7d0; } /* green-800 / green-200 */
        .alert-warning { background-color: #854d0e; color: #fef08a; } /* amber-800 / amber-200 */
        .alert-error { background-color: #991b1b; color: #fecaca; } /* red-800 / red-200 */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .filter-select {
             background-color: var(--bg-tertiary);
             border: 1px solid var(--border-color);
             color: var(--text-primary);
             border-radius: 0.375rem; /* 6px */
             padding: 0.5rem 0.75rem;
             height: 42px; /* Match input height */
        }
         .filter-select:focus {
             outline: none;
             border-color: var(--accent);
             box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.3);
         }
        .paused-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
         .proposal-card {
            background-color: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            margin-top: 1rem;
            font-size: 0.875rem;
         }
    </style>
</head>
<body class="min-h-screen pb-16">

    <!-- Paused Overlay -->
    <div id="paused-overlay" class="paused-overlay hidden">
        <div class="bg-secondary p-8 rounded-lg shadow-xl max-w-md">
            <h2 class="text-2xl font-bold text-yellow mb-4">Contract Paused</h2>
            <p class="text-secondary mb-6">Contract operations are temporarily paused by the owner. Please check back later.</p>
            <p class="text-xs text-secondary">(Only view functions and unpausing by the owner are available.)</p>
        </div>
    </div>


    <nav class="bg-secondary sticky top-0 z-50 shadow-lg mb-8">
        <div class="container mx-auto max-w-7xl p-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold">
                YieldWorks
                <span class="text-sm font-normal text-secondary hidden sm:inline-block ml-2">Dashboard</span>
            </a>
            <div class="flex items-center space-x-4">
                 <span id="pause-status-indicator" class="hidden text-xs font-bold px-3 py-1 rounded-full"></span>
                 <button id="connect-button" class="btn btn-primary">Connect Wallet</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto max-w-7xl px-4">

        <!-- Status Messages -->
        <div id="status-message" class="hidden"></div>

        <!-- Wallet Info -->
        <div id="wallet-info" class="card hidden">
            <h2 class="text-xl font-bold mb-3">Wallet Connected</h2>
            <p class="text-sm"><strong>Network:</strong> <span id="network-name"></span></p>
            <p class="text-sm truncate"><strong>Address:</strong> <span id="user-address"></span></p>
            <p class="text-sm"><strong>USDC Balance:</strong> <span id="usdc-balance">Loading...</span></p>
            <p class="text-sm"><strong>MTYLD Balance:</strong> <span id="mtyld-balance">Loading...</span></p>
        </div>

        <!-- Protocol Info -->
        <div class="card">
            <h2 class="text-xl font-bold mb-4">Protocol Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div><strong>Token:</strong> <span id="token-name">Loading...</span> (<span id="token-symbol">---</span>)</div>
                <div><strong>Total Supply:</strong> <span id="total-supply">Loading...</span> MTYLD</div>
                <div class="md:col-span-2 lg:col-span-1"><strong>Contract Address:</strong> <a id="contract-address-link" href="#" target="_blank" rel="noopener noreferrer" class="text-accent hover:underline break-all">Loading...</a></div>
                <div><strong>Contract USDC:</strong> <span id="contract-usdc">Loading...</span> USDC</div>
                <div><strong>Current Price:</strong> <span id="mtyld-price">Loading...</span> USDC/MTYLD</div>
                <div><strong>Available for Sale:</strong> <span id="available-mtyld">Loading...</span> MTYLD</div>
                <div><strong>Proposal Delay:</strong> <span id="proposal-delay">Loading...</span> seconds</div>
            </div>
        </div>

        <!-- Buy / Redeem Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Buy Card -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Buy MTYLD</h2>
                <form id="buy-form">
                    <div class="mb-4">
                        <label for="buy-usdc-amount">USDC Amount to Spend</label>
                        <input type="number" id="buy-usdc-amount" step="0.01" min="0" placeholder="e.g., 100.00" required>
                        <p class="text-xs text-secondary mt-1">Your USDC Balance: <span id="buy-usdc-balance">--</span></p>
                    </div>
                     <div class="mb-4">
                        <label for="buy-slippage">Slippage Tolerance (%)</label>
                        <select id="buy-slippage" class="bg-tertiary">
                            <option value="0.5">0.5%</option>
                            <option value="1">1%</option>
                            <option value="2">2%</option>
                        </select>
                    </div>
                    <div class="mb-4 text-sm bg-tertiary p-3 rounded">
                        Estimated MTYLD to Receive: <span id="estimated-mtyld" class="font-bold">0.00</span>
                        <input type="hidden" id="min-tokens-out">
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="button" id="approve-usdc-button" class="btn btn-secondary flex-1">Approve USDC</button>
                        <button type="submit" id="buy-button" class="btn btn-primary flex-1" disabled>Buy MTYLD</button>
                    </div>
                </form>
            </div>

            <!-- Redeem Card -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Redeem MTYLD</h2>
                <form id="redeem-form">
                    <div class="mb-4">
                        <label for="redeem-mtyld-amount">MTYLD Amount to Redeem</label>
                        <input type="number" id="redeem-mtyld-amount" step="0.01" min="0" placeholder="e.g., 500.00" required>
                        <p class="text-xs text-secondary mt-1">Your MTYLD Balance: <span id="redeem-mtyld-balance">--</span></p>
                    </div>
                    <div class="mb-4">
                        <label for="redeem-slippage">Slippage Tolerance (%)</label>
                        <select id="redeem-slippage" class="bg-tertiary">
                            <option value="0.5">0.5%</option>
                            <option value="1">1%</option>
                            <option value="2">2%</option>
                        </select>
                    </div>
                    <div class="mb-4 text-sm bg-tertiary p-3 rounded">
                        Estimated USDC to Receive (after fee): <span id="estimated-usdc" class="font-bold">0.00</span>
                        <input type="hidden" id="min-usdc-out">
                         <p class="text-xs text-secondary mt-1">Redemption Fee: <span id="redeem-fee-percent">--</span>%</p>
                    </div>
                    <button type="submit" id="redeem-button" class="btn btn-primary w-full">Redeem MTYLD</button>
                </form>
            </div>
        </div>

        <!-- Work Orders Table Section -->
         <div class="card mt-6">
             <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                 <h2 class="text-xl font-bold mb-3 sm:mb-0">Recent Work Orders</h2>
                 <div class="flex items-center space-x-3">
                     <label for="filter-month" class="text-sm text-secondary whitespace-nowrap">Filter by:</label>
                     <select id="filter-month" class="filter-select w-32">
                         <option value="all">All Months</option>
                         <option value="0">January</option>
                         <option value="1">February</option>
                         <option value="2">March</option>
                         <option value="3">April</option>
                         <option value="4">May</option>
                         <option value="5">June</option>
                         <option value="6">July</option>
                         <option value="7">August</option>
                         <option value="8">September</option>
                         <option value="9">October</option>
                         <option value="10">November</option>
                         <option value="11">December</option>
                     </select>
                     <select id="filter-year" class="filter-select w-28">
                         <option value="all">All Years</option>
                     </select>
                 </div>
             </div>
             <div class="overflow-x-auto">
                 <table id="work-orders-table">
                     <thead>
                         <tr>
                             <th>ID</th>
                             <th>Description</th>
                             <th>Gross (USDC)</th>
                             <th>Tokenized (USDC)</th>
                             <th>Issued (MTYLD)</th>
                             <th>Status</th>
                             <th>Created</th>
                         </tr>
                     </thead>
                     <tbody id="work-orders-body">
                         <tr><td colspan="7" class="text-center py-4 text-secondary">Loading work orders...</td></tr>
                     </tbody>
                 </table>
             </div>
         </div>


        <!-- Admin Panel (Initially hidden) -->
        <div id="admin-panel" class="card mt-8 hidden">
            <h2 class="text-2xl font-bold mb-6 text-center text-accent">Admin Panel</h2>

            <!-- Pause/Unpause Controls -->
            <div class="bg-tertiary p-4 rounded-lg border border-border-color mb-6 text-center">
                 <h3 class="text-lg font-semibold mb-3">Pause Control</h3>
                 <p class="text-xs text-secondary mb-3">Pause contract interactions in case of emergency.</p>
                 <div class="flex justify-center gap-4">
                      <button id="pause-button" class="btn btn-danger w-40">Pause Contract</button>
                      <button id="unpause-button" class="btn btn-primary w-40">Unpause Contract</button>
                 </div>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Propose Mint Work Order -->
                <form id="propose-mint-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                    <h3 class="text-lg font-semibold mb-3">1. Propose New Work Order</h3>
                    <div class="mb-3">
                        <label for="propose-yield">Gross Yield (USDC)</label>
                        <input type="number" id="propose-yield" step="0.01" min="0.01" placeholder="e.g., 1000.00" required>
                    </div>
                    <div class="mb-3">
                        <label for="propose-desc">Description</label>
                        <input type="text" id="propose-desc" placeholder="e.g., Commercial HVAC Install #12345" required>
                    </div>
                    <button type="submit" class="btn btn-secondary w-full">Propose Mint</button>
                </form>

                 <!-- Execute Mint Work Order -->
                 <div class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">2. Execute Pending Mint</h3>
                     <div class="mb-3">
                          <label for="execute-mint-id">Proposal ID to Execute</label>
                          <input type="number" id="execute-mint-id" min="1" placeholder="Enter ID from proposal" required>
                     </div>
                     <div id="pending-mint-details" class="proposal-card hidden">
                          {/* Details loaded dynamically */}
                     </div>
                     <button id="execute-mint-button" class="btn btn-primary w-full mt-3" disabled>Execute Mint (after delay)</button>
                 </div>
            </div>

             <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                 <!-- Payout Work Order -->
                 <form id="payout-order-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Payout Work Order</h3>
                     <p class="text-xs text-secondary mb-3">Pay back the Tokenized Value to mark order as complete.</p>
                      <div class="mb-3">
                        <label for="payout-id">Work Order ID</label>
                        <input type="number" id="payout-id" min="1" placeholder="e.g., 1" required>
                    </div>
                    <div class="mb-3">
                        <label for="payout-amount">Payout Amount (USDC)</label>
                        <input type="number" id="payout-amount" step="0.01" min="0.01" placeholder="Must equal Tokenized Value" required>
                        <p class="text-xs text-secondary mt-1">Order Tokenized Value: <span id="payout-tokenized-value">--</span></p>
                    </div>
                     <p class="text-xs text-secondary mb-3">Note: Requires prior USDC approval.</p>
                      <div class="flex gap-3">
                           <button type="button" id="admin-approve-usdc-button" class="btn btn-secondary flex-1">Approve USDC</button>
                           <button type="submit" class="btn btn-primary flex-1">Submit Payout</button>
                      </div>
                 </form>

                 <!-- Cancel Work Order -->
                 <form id="cancel-order-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Cancel Work Order</h3>
                      <p class="text-xs text-secondary mb-3">Deactivate an order (does not burn tokens).</p>
                     <div class="mb-3">
                         <label for="cancel-id">Work Order ID</label>
                         <input type="number" id="cancel-id" min="1" placeholder="e.g., 1" required>
                     </div>
                     <button type="submit" class="btn btn-danger w-full">Cancel Order</button>
                 </form>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                 <!-- Propose Fee Change -->
                 <form id="propose-fee-form" class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">1. Propose Fee Change</h3>
                     <div class="mb-3">
                         <label for="propose-new-fee">New Fee Percentage (0-20)</label>
                         <input type="number" id="propose-new-fee" min="0" max="20" step="0.1" placeholder="e.g., 10" required>
                     </div>
                      <p class="text-xs text-secondary mb-3">Current Fee: <span id="current-redeem-fee">--</span>%</p>
                     <button type="submit" class="btn btn-secondary w-full">Propose Fee Change</button>
                 </form>

                 <!-- Execute Fee Change -->
                 <div class="bg-tertiary p-4 rounded-lg border border-border-color">
                      <h3 class="text-lg font-semibold mb-3">2. Execute Fee Change</h3>
                      <div id="pending-fee-details" class="proposal-card hidden">
                          {/* Details loaded dynamically */}
                      </div>
                      <button id="execute-fee-button" class="btn btn-primary w-full mt-3" disabled>Execute Fee Change (after delay)</button>
                 </div>

                 <!-- Withdraw Fees -->
                <div class="bg-tertiary p-4 rounded-lg border border-border-color">
                     <h3 class="text-lg font-semibold mb-3">Withdraw Fees</h3>
                     <p class="text-sm mb-3">Collected Fees: <span id="collected-fees" class="font-bold">Loading...</span> USDC</p>
                    <button id="withdraw-fees-button" class="btn btn-secondary w-full" disabled>Withdraw All Fees</button>
                 </div>
            </div>
             <!-- Emergency Withdraw -->
             <form id="emergency-withdraw-form" class="bg-tertiary p-4 rounded-lg border border-border-color mt-6">
                 <h3 class="text-lg font-semibold mb-3">Emergency Withdraw (Owner Only)</h3>
                 <p class="text-xs text-secondary mb-3">Withdraw non-USDC ERC20 tokens accidentally sent to this contract.</p>
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                     <div>
                         <label for="emergency-token">Token Address (Non-USDC)</label>
                         <input type="text" id="emergency-token" placeholder="0x..." required>
                     </div>
                     <div>
                         <label for="emergency-to">Recipient Address</label>
                         <input type="text" id="emergency-to" placeholder="0x..." required>
                     </div>
                      <div>
                         <label for="emergency-amount">Amount (Raw Units)</label>
                         <input type="number" id="emergency-amount" min="1" placeholder="e.g., 1000000000000000000" required>
                     </div>
                 </div>
                 <button type="submit" class="btn btn-danger w-full mt-3">Withdraw Other Token</button>
             </form>
        </div>

    </main>

    <script type="text/javascript">
        // --- CONFIGURATION ---
        const contractAddress = "0xae2C05f01DBCC6C8AF40EbFA3339Af10dbECdFD0"; // <-- NEW ADDRESS
        const contractABI = [{"inputs":[{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"target","type":"address"}],"name":"AddressCallToNonContract","type":"error"},{"inputs":[],"name":"AddressEmptyRevertData","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"AddressInsufficientBalance","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"inputs":[],"name":"ReentrancyGuardReentrantCall","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"burner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Burn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"FeeChangeExecuted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"proposedAt","type":"uint256"}],"name":"FeeChangeProposed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FeesWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalId","type":"uint256"}],"name":"MintExecuted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"proposalId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"grossYield","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"},{"indexed":false,"internalType":"uint256","name":"proposedAt","type":"uint256"}],"name":"MintProposed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"RedemptionFeeSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"reserveAmount","type":"uint256"}],"name":"ReserveFunded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"holder","type":"address"},{"indexed":false,"internalType":"uint256","name":"mtyldAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"usdcAmount","type":"uint256"}],"name":"TokensRedeemed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"}],"name":"WorkOrderCancelled","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"grossYield","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"indexed":false,"internalType":"string","name":"description","type":"string"}],"name":"WorkOrderMinted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"workOrderId","type":"uint256"},{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WorkOrderPaid","type":"event"},{"inputs":[],"name":"PROPOSAL_DELAY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"RESERVE_PERCENTAGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TOKENIZATION_PERCENTAGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"availableTokens","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount","type":"uint256"},{"internalType":"uint256","name":"minTokensOut","type":"uint256"}],"name":"buyTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"workOrderId","type":"uint256"}],"name":"cancelWorkOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"collectedFees","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"contractPaymentTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"tokenAddress","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"executeFeeChange","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"proposalId","type":"uint256"}],"name":"executeMint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"mtyldAmount","type":"uint256"}],"name":"getRedemptionValue","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"usdcAmount","type":"uint256"}],"name":"getTokensForUSDC","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"startId","type":"uint256"},{"internalType":"uint256","name":"endId","type":"uint256"}],"name":"getWorkOrderRange","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"internalType":"uint256","name":"reserveAmount","type":"uint256"},{"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isPaid","type":"bool"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"createdAt","type":"uint256"}],"internalType":"struct MechanicalTempYieldToken.WorkOrder[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextProposalId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextWorkOrderId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paymentToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"workOrderId","type":"uint256"},{"internalType":"uint256","name":"payoutAmount","type":"uint256"}],"name":"payoutWorkOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"pendingFeeChange","outputs":[{"internalType":"uint256","name":"newFeePercentage","type":"uint256"},{"internalType":"uint256","name":"proposedAt","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"pendingMints","outputs":[{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"proposedAt","type":"uint256"},{"internalType":"bool","name":"exists","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFeePercentage","type":"uint256"}],"name":"proposeFeeChange","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"string","name":"description","type":"string"}],"name":"proposeMint","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"mtyldAmount","type":"uint256"},{"internalType":"uint256","name":"minUsdcOut","type":"uint256"}],"name":"redeemTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"redemptionFeePercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalReserveFund","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"workOrders","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"grossYield","type":"uint256"},{"internalType":"uint256","name":"tokenizedValue","type":"uint256"},{"internalType":"uint256","name":"reserveAmount","type":"uint256"},{"internalType":"uint256","name":"tokensIssued","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isPaid","type":"bool"},{"internalType":"string","name":"description","type":"string"},{"internalType":"uint256","name":"createdAt","type":"uint256"}],"stateMutability":"view","type":"function"}]; // <-- NEW ABI
        const usdcAddress = "0xaf88d065e77c8cC2239327C5EDb3A432268e5831"; // Arbitrum Native USDC
        const arbitrumChainId = '0xa4b1'; // 42161 in hex

        // --- DOM Elements ---
        const connectButton = document.getElementById('connect-button');
        const statusMessageDiv = document.getElementById('status-message');
        const walletInfoDiv = document.getElementById('wallet-info');
        const networkNameSpan = document.getElementById('network-name');
        const userAddressSpan = document.getElementById('user-address');
        const usdcBalanceSpan = document.getElementById('usdc-balance');
        const mtyldBalanceSpan = document.getElementById('mtyld-balance');
        const buyUsdcBalanceSpan = document.getElementById('buy-usdc-balance');
        const redeemMtyldBalanceSpan = document.getElementById('redeem-mtyld-balance');

        // Protocol Info Elements
        const tokenNameSpan = document.getElementById('token-name');
        const tokenSymbolSpan = document.getElementById('token-symbol');
        const totalSupplySpan = document.getElementById('total-supply');
        const contractAddressLink = document.getElementById('contract-address-link');
        const contractUsdcSpan = document.getElementById('contract-usdc');
        const mtyldPriceSpan = document.getElementById('mtyld-price');
        const availableMtyldSpan = document.getElementById('available-mtyld');
        const proposalDelaySpan = document.getElementById('proposal-delay'); // Added

        // Buy Form Elements
        const buyForm = document.getElementById('buy-form');
        const buyUsdcAmountInput = document.getElementById('buy-usdc-amount');
        const buySlippageSelect = document.getElementById('buy-slippage');
        const estimatedMtyldSpan = document.getElementById('estimated-mtyld');
        const minTokensOutInput = document.getElementById('min-tokens-out');
        const approveUsdcButton = document.getElementById('approve-usdc-button');
        const buyButton = document.getElementById('buy-button');

        // Redeem Form Elements
        const redeemForm = document.getElementById('redeem-form');
        const redeemMtyldAmountInput = document.getElementById('redeem-mtyld-amount');
        const redeemSlippageSelect = document.getElementById('redeem-slippage');
        const estimatedUsdcSpan = document.getElementById('estimated-usdc');
        const minUsdcOutInput = document.getElementById('min-usdc-out');
        const redeemButton = document.getElementById('redeem-button');
        const redeemFeePercentSpan = document.getElementById('redeem-fee-percent');


        // Work Orders Elements
        const workOrdersTableBody = document.getElementById('work-orders-body');
        const filterMonthSelect = document.getElementById('filter-month');
        const filterYearSelect = document.getElementById('filter-year');


        // Admin Panel Elements
        const adminPanelDiv = document.getElementById('admin-panel');
        const proposeMintForm = document.getElementById('propose-mint-form'); // Renamed form ID
        const executeMintIdInput = document.getElementById('execute-mint-id'); // Added input ID
        const pendingMintDetailsDiv = document.getElementById('pending-mint-details'); // Added div ID
        const executeMintButton = document.getElementById('execute-mint-button'); // Added button ID
        const payoutOrderForm = document.getElementById('payout-order-form');
        const payoutTokenizedValueSpan = document.getElementById('payout-tokenized-value'); // Added span ID
        const cancelOrderForm = document.getElementById('cancel-order-form');
        const proposeFeeForm = document.getElementById('propose-fee-form'); // Renamed form ID
        const executeFeeButton = document.getElementById('execute-fee-button'); // Added button ID
        const pendingFeeDetailsDiv = document.getElementById('pending-fee-details'); // Added div ID
        const currentRedeemFeeSpan = document.getElementById('current-redeem-fee');
        const collectedFeesSpan = document.getElementById('collected-fees');
        const withdrawFeesButton = document.getElementById('withdraw-fees-button');
        const adminApproveUsdcButton = document.getElementById('admin-approve-usdc-button');
        const emergencyWithdrawForm = document.getElementById('emergency-withdraw-form');
        const pauseButton = document.getElementById('pause-button'); // Added button ID
        const unpauseButton = document.getElementById('unpause-button'); // Added button ID
        const pauseStatusIndicator = document.getElementById('pause-status-indicator'); // Added span ID
        const pausedOverlay = document.getElementById('paused-overlay'); // Added overlay ID

        // --- State Variables ---
        let provider = null;
        let signer = null;
        let userAddress = null;
        let mtyldContract = null;
        let usdcContract = null;
        let contractOwner = null;
        let usdcDecimals = 6;
        let mtyldDecimals = 18;
        let allWorkOrders = [];
        let availableYears = new Set();
        let currentProposalDelay = null; // Store proposal delay


        // --- Helper Functions ---
        function showStatus(message, type = 'info') {
            statusMessageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            statusMessageDiv.classList.remove('hidden');
            if (type !== 'error' && type !== 'warning') { // Keep warning/error visible longer
                setTimeout(() => { statusMessageDiv.classList.add('hidden'); }, 5000);
            } else {
                 setTimeout(() => { statusMessageDiv.classList.add('hidden'); }, 8000); // Longer timeout for errors/warnings
            }
        }
         function formatUnits(amount, decimals) {
            if (amount === null || amount === undefined) return '...';
            try { return ethers.formatUnits(amount, decimals); }
            catch (error) { console.error("FmtErr:", error, amount, decimals); return 'Err'; }
         }
         function parseUnits(amount, decimals) {
             try {
                const amountStr = String(amount).trim();
                if (!amountStr) throw new Error("Input empty");
                return ethers.parseUnits(amountStr, decimals);
             } catch (error) {
                 console.error("ParseErr:", error, amount, decimals);
                 showStatus(`Invalid input: '${amount}'. Valid number needed.`, 'error');
                 return null;
             }
         }
        function formatDate(timestamp) {
            if (!timestamp || timestamp === 0n) return { dateStr: 'N/A', month: -1, year: -1, fullDate: null };
            try {
                const date = new Date(Number(timestamp) * 1000);
                 const dateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                 const month = date.getMonth(); // 0-11
                 const year = date.getFullYear();
                 return { dateStr, month, year, fullDate: date };
            } catch {
                return { dateStr: 'Invalid Date', month: -1, year: -1, fullDate: null };
            }
        }
        function setLoading(button, isLoading, originalText) {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<span class="loading-spinner"></span> Processing...`;
            } else {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        function shortenAddress(address) {
            if (!address) return '';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }
        // Format seconds into readable time (days, hours, minutes)
        function formatSeconds(seconds) {
            const d = Math.floor(seconds / (3600*24));
            const h = Math.floor(seconds % (3600*24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);
            const s = Math.floor(seconds % 60);
            return `${d}d ${h}h ${m}m ${s}s`;
        }

        // --- Blockchain Interaction ---

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                return showStatus('MetaMask is not installed.', 'error');
            }
            const connectBtn = connectButton; // Use existing reference
            const originalConnectText = 'Connect Wallet';
            setLoading(connectBtn, true, originalConnectText);

            try {
                if (typeof ethers === 'undefined') { throw new Error('Ethers.js library not loaded.'); }
                provider = new ethers.BrowserProvider(window.ethereum, "any"); // Allow any network initially

                // Add listeners ONCE here, if not already attached
                if (!window.walletListenersAttached) {
                     setupWalletListeners();
                     window.walletListenersAttached = true;
                }


                const network = await provider.getNetwork();
                if (network.chainId !== BigInt(arbitrumChainId)) {
                     try {
                          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: arbitrumChainId }] });
                          provider = new ethers.BrowserProvider(window.ethereum); // Re-init after switch
                     } catch (switchError) {
                          if (switchError.code === 4902) {
                                try {
                                    await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [{ chainId: arbitrumChainId, chainName: 'Arbitrum One', nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 }, rpcUrls: ['https://arb1.arbitrum.io/rpc'], blockExplorerUrls: ['https://arbiscan.io'] }] });
                                     provider = new ethers.BrowserProvider(window.ethereum); // Re-init after add
                                } catch (addError) { throw new Error('Please add Arbitrum One network manually.'); }
                           } else { throw new Error('Please switch to Arbitrum One network.'); }
                     }
                }

                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                mtyldContract = new ethers.Contract(contractAddress, contractABI, signer);
                const usdcAbiMinimal = ["function decimals() view returns (uint8)","function balanceOf(address) view returns (uint256)","function allowance(address, address) view returns (uint256)","function approve(address, uint256) returns (bool)","function transferFrom(address, address, uint256) returns (bool)"];
                usdcContract = new ethers.Contract(usdcAddress, usdcAbiMinimal, signer);
                usdcDecimals = await usdcContract.decimals();

                connectButton.textContent = shortenAddress(userAddress);
                connectButton.disabled = true;
                walletInfoDiv.classList.remove('hidden');

                await updateWalletInfo();
                await updateProtocolInfo(); // Includes pause status check now
                await fetchAndStoreAllWorkOrders();
                await checkAdminStatus(); // Includes proposal checks

                showStatus('Wallet connected!', 'success');
                // Don't call setupEventListeners here - called by DOMContentLoaded

            } catch (error) {
                console.error("Connection failed:", error);
                showStatus(`Wallet connection failed: ${error.message}`, 'error');
                resetState(); // Reset UI on connection failure
            } finally {
                 // Final check on button state
                 if (userAddress) {
                      setLoading(connectBtn, false, shortenAddress(userAddress));
                      connectBtn.disabled = true;
                 } else {
                     setLoading(connectBtn, false, originalConnectText);
                     connectBtn.disabled = false;
                 }
            }
        }

        function resetState() {
             userAddress = null; signer = null; provider = null;
             contractOwner = null; allWorkOrders = []; availableYears.clear(); currentProposalDelay = null;
             walletInfoDiv.classList.add('hidden');
             connectButton.textContent = 'Connect Wallet';
             connectButton.disabled = false;
             adminPanelDiv.classList.add('hidden');
             workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">Connect wallet to view orders.</td></tr>';
             populateYearFilter();
             document.getElementById('usdc-balance').textContent = 'Disconnected';
             document.getElementById('mtyld-balance').textContent = 'Disconnected';
             buyUsdcBalanceSpan.textContent = '--';
             redeemMtyldBalanceSpan.textContent = '--';
             tokenNameSpan.textContent = 'Loading...'; // Reset protocol info
             // ... reset other fields ...
             pauseStatusIndicator.classList.add('hidden');
             pausedOverlay.classList.add('hidden');
        }


        async function checkAdminStatus() {
            if (!mtyldContract) return;
            try {
                contractOwner = await mtyldContract.owner();
                if (userAddress && contractOwner && userAddress.toLowerCase() === contractOwner.toLowerCase()) {
                    adminPanelDiv.classList.remove('hidden');
                    console.log("Admin connected");
                    await updateAdminInfo();
                    await checkPendingProposals(); // Fetch proposal status for admin
                } else {
                     adminPanelDiv.classList.add('hidden');
                     console.log("Connected user is not the admin");
                }
            } catch (error) {
                console.error("Error checking admin status:", error);
                 showStatus('Could not verify admin status.', 'error');
            }
        }

        async function updateAdminInfo() {
             if (!mtyldContract) return;
             try {
                  const fees = await mtyldContract.collectedFees();
                  collectedFeesSpan.textContent = parseFloat(formatUnits(fees, usdcDecimals)).toFixed(2);
                  withdrawFeesButton.disabled = fees === 0n;

                  const feePercent = await mtyldContract.redemptionFeePercentage();
                  currentRedeemFeeSpan.textContent = feePercent.toString();

                  const isPaused = await mtyldContract.paused();
                  updatePauseButtons(isPaused);

             } catch (error) {
                  console.error("Error fetching admin info:", error);
                  collectedFeesSpan.textContent = 'Error';
                  withdrawFeesButton.disabled = true;
             }
        }

         // Check pending mint and fee proposals
         async function checkPendingProposals() {
             if (!mtyldContract || !contractOwner || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return;

             try {
                 // Check pending fee change
                 const feeProposal = await mtyldContract.pendingFeeChange();
                 if (feeProposal.exists) {
                     pendingFeeDetailsDiv.classList.remove('hidden');
                     const proposedTime = new Date(Number(feeProposal.proposedAt) * 1000);
                     const now = new Date();
                     const delaySeconds = Number(currentProposalDelay || 0n); // Use fetched delay
                     const canExecuteFee = blockTimestamp ? blockTimestamp >= feeProposal.proposedAt + BigInt(delaySeconds) : false; // Use blockTimestamp if available
                      // Fallback estimate if blockTimestamp not available (less accurate)
                      const canExecuteFeeEstimate = now.getTime() / 1000 >= Number(feeProposal.proposedAt) + delaySeconds;

                     pendingFeeDetailsDiv.innerHTML = `
                         <p><strong>Proposed Fee:</strong> ${feeProposal.newFeePercentage}%</p>
                         <p><strong>Proposed At:</strong> ${proposedTime.toLocaleString()}</p>
                         <p><strong>Executable:</strong> ${canExecuteFee || canExecuteFeeEstimate ? '<span class="text-green">Yes</span>' : 'No (Wait)'}</p>
                     `;
                     executeFeeButton.disabled = !(canExecuteFee || canExecuteFeeEstimate);
                 } else {
                     pendingFeeDetailsDiv.classList.add('hidden');
                     pendingFeeDetailsDiv.innerHTML = '';
                     executeFeeButton.disabled = true;
                 }

                 // Check pending mint for the ID entered (if any)
                 checkPendingMintDetails(); // Call helper to check based on input field


             } catch (error) {
                 console.error("Error checking pending proposals:", error);
                 showStatus("Could not fetch pending proposals.", "error");
             }
         }

        // Helper to check and display pending mint details based on input ID
         let checkMintTimeout;
        async function checkPendingMintDetails() {
             if (!mtyldContract || !executeMintIdInput.value) {
                 pendingMintDetailsDiv.classList.add('hidden');
                 pendingMintDetailsDiv.innerHTML = '';
                 executeMintButton.disabled = true;
                 return;
             }

             const proposalId = BigInt(executeMintIdInput.value);

             try {
                  const mintProposal = await mtyldContract.pendingMints(proposalId);
                  if (mintProposal.exists) {
                       pendingMintDetailsDiv.classList.remove('hidden');
                       const proposedTime = new Date(Number(mintProposal.proposedAt) * 1000);
                       const now = new Date();
                       const delaySeconds = Number(currentProposalDelay || 0n);
                       const canExecuteMint = blockTimestamp ? blockTimestamp >= mintProposal.proposedAt + BigInt(delaySeconds) : false;
                       const canExecuteMintEstimate = now.getTime() / 1000 >= Number(mintProposal.proposedAt) + delaySeconds;


                       pendingMintDetailsDiv.innerHTML = `
                          <p><strong>ID:</strong> ${proposalId}</p>
                          <p><strong>Yield:</strong> ${parseFloat(formatUnits(mintProposal.grossYield, usdcDecimals)).toFixed(2)} USDC</p>
                          <p><strong>Desc:</strong> ${mintProposal.description}</p>
                          <p><strong>Proposed At:</strong> ${proposedTime.toLocaleString()}</p>
                          <p><strong>Executable:</strong> ${canExecuteMint || canExecuteMintEstimate ? '<span class="text-green">Yes</span>' : 'No (Wait)'}</p>
                       `;
                       executeMintButton.disabled = !(canExecuteMint || canExecuteMintEstimate);
                  } else {
                       pendingMintDetailsDiv.classList.add('hidden');
                       pendingMintDetailsDiv.innerHTML = '<p class="text-secondary text-center">No pending mint found for this ID.</p>';
                       executeMintButton.disabled = true;
                  }
             } catch (error) {
                  console.error(`Error checking pending mint ${proposalId}:`, error);
                  pendingMintDetailsDiv.classList.remove('hidden');
                  pendingMintDetailsDiv.innerHTML = '<p class="text-red-400 text-center">Error fetching details.</p>';
                  executeMintButton.disabled = true;
             }
        }
         // Debounce check on input change
         executeMintIdInput.addEventListener('input', () => {
             clearTimeout(checkMintTimeout);
             checkMintTimeout = setTimeout(checkPendingMintDetails, 500); // Check 500ms after user stops typing
         });


        async function updateWalletInfo() {
            if (!provider || !userAddress || !usdcContract || !mtyldContract) return;
            try {
                const network = await provider.getNetwork();
                networkNameSpan.textContent = network.name === 'arbitrum' ? 'Arbitrum One' : network.name;
                userAddressSpan.textContent = userAddress;

                const [usdcBal, mtyldBal] = await Promise.all([
                    usdcContract.balanceOf(userAddress),
                    mtyldContract.balanceOf(userAddress)
                ]);

                usdcBalanceSpan.textContent = `${parseFloat(formatUnits(usdcBal, Number(usdcDecimals))).toFixed(2)} USDC`;
                mtyldBalanceSpan.textContent = `${parseFloat(formatUnits(mtyldBal, mtyldDecimals)).toFixed(4)} MTYLD`;
                buyUsdcBalanceSpan.textContent = parseFloat(formatUnits(usdcBal, Number(usdcDecimals))).toFixed(2);
                redeemMtyldBalanceSpan.textContent = parseFloat(formatUnits(mtyldBal, mtyldDecimals)).toFixed(4);

            } catch (error) {
                console.error("Error updating wallet info:", error);
                showStatus('Failed to update wallet balances.', 'error');
                usdcBalanceSpan.textContent = 'Error'; mtyldBalanceSpan.textContent = 'Error';
            }
        }

        let blockTimestamp = null; // Store latest block timestamp
        async function updateProtocolInfo() {
             if (!mtyldContract || !usdcContract) return;
             try {
                // Fetch block timestamp for more accurate timelock checks
                const block = await provider.getBlock("latest");
                blockTimestamp = block ? BigInt(block.timestamp) : null;

                 const [name, symbol, supply, contractUSDCBalance, available, feePercent, isPaused, delaySeconds] = await Promise.all([
                     mtyldContract.name(),
                     mtyldContract.symbol(),
                     mtyldContract.totalSupply(),
                     mtyldContract.contractPaymentTokenBalance(),
                     mtyldContract.availableTokens(),
                     mtyldContract.redemptionFeePercentage(),
                     mtyldContract.paused(), // Check pause status
                     mtyldContract.PROPOSAL_DELAY() // Get delay from contract
                 ]);

                 tokenNameSpan.textContent = name;
                 tokenSymbolSpan.textContent = symbol;
                 totalSupplySpan.textContent = parseFloat(formatUnits(supply, mtyldDecimals)).toFixed(4);
                 contractAddressLink.textContent = shortenAddress(contractAddress);
                 contractAddressLink.href = `https://arbiscan.io/address/${contractAddress}`;
                 contractUsdcSpan.textContent = parseFloat(formatUnits(contractUSDCBalance, Number(usdcDecimals))).toFixed(2);
                 availableMtyldSpan.textContent = parseFloat(formatUnits(available, mtyldDecimals)).toFixed(4);
                 redeemFeePercentSpan.textContent = feePercent.toString();
                 currentProposalDelay = delaySeconds; // Store for later use
                 proposalDelaySpan.textContent = delaySeconds.toString(); // Display delay

                 // Update pause status UI
                 updatePauseUI(isPaused);

                 let price = 0;
                 if (supply > 0n && contractUSDCBalance >= 0n) {
                      const scaleFactor = 10n ** BigInt(18 - Number(usdcDecimals));
                      const priceBigInt = supply > 0n ? (contractUSDCBalance * scaleFactor) / supply : 0n; // Add check for supply > 0
                      price = parseFloat(formatUnits(priceBigInt, Number(usdcDecimals)));
                 }
                 mtyldPriceSpan.textContent = price > 0 ? price.toFixed(6) : '0.000000';

                 updateBuyEstimate();
                 updateRedeemEstimate();

             } catch (error) {
                 console.error("Error updating protocol info:", error);
                 showStatus('Failed to fetch protocol data.', 'error');
                 tokenNameSpan.textContent = 'Error';
                 // etc.
             }
         }

        // --- Buy/Redeem Logic (No changes needed, rely on whenNotPaused modifier) ---
        async function updateBuyEstimate() { /* ... */ }
        async function updateRedeemEstimate() { /* ... */ }
        async function handleApproveUSDC(isAdmin = false) { /* ... */ }
        async function handleBuyTokens(event) { /* ... check pause status before sending ... */
             event.preventDefault();
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
             // ... rest of the function ...
        }
        async function handleRedeemTokens(event) { /* ... check pause status before sending ... */
             event.preventDefault();
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
             // ... rest of the function ...
        }


        // --- Work Order Display & Filtering Logic ---
        async function fetchAndStoreAllWorkOrders() {
            if (!mtyldContract) return;
            workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">Fetching all work orders...</td></tr>';
            allWorkOrders = []; availableYears.clear();

            try {
                const nextId = await mtyldContract.nextWorkOrderId();
                if (nextId <= 1n) {
                    workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">No work orders found.</td></tr>';
                    populateYearFilter(); return;
                }

                // Consider fetching in batches if many orders exist
                const BATCH_SIZE = 100;
                let currentEndId = nextId - 1n;
                let fetchedOrdersBatch = [];

                showStatus('Fetching work orders (this may take a moment)...', 'info');

                while (currentEndId >= 1n) {
                    const currentStartId = currentEndId - BigInt(BATCH_SIZE) + 1n > 0n ? currentEndId - BigInt(BATCH_SIZE) + 1n : 1n;
                    console.log(`Fetching orders ${currentStartId} to ${currentEndId}`);
                    try {
                        // Use getWorkOrderRange for efficiency
                        const ordersBatchRaw = await mtyldContract.getWorkOrderRange(currentStartId, currentEndId);
                         const processedBatch = ordersBatchRaw.map(order => {
                              if (order && order.id !== 0n) {
                                  const { dateStr, month, year } = formatDate(order.createdAt);
                                  if (year !== -1) availableYears.add(year);
                                  return {
                                       id: order.id.toString(),
                                       description: order.description,
                                       grossYield: order.grossYield,
                                       tokenizedValue: order.tokenizedValue, // Added field
                                       reserveAmount: order.reserveAmount,
                                       tokensIssued: order.tokensIssued,
                                       isActive: order.isActive,
                                       isPaid: order.isPaid,
                                       createdAt: order.createdAt,
                                       createdDateStr: dateStr,
                                       createdMonth: month,
                                       createdYear: year
                                  };
                              } return null;
                         }).filter(o => o !== null);
                         fetchedOrdersBatch = fetchedOrdersBatch.concat(processedBatch);
                    } catch (batchError) {
                         console.error(`Error fetching batch ${currentStartId}-${currentEndId}:`, batchError);
                         showStatus(`Error fetching some orders (${currentStartId}-${currentEndId}). Data may be incomplete.`, 'warning');
                    }

                    if (currentStartId === 1n) break; // Reached the beginning
                    currentEndId = currentStartId - 1n;
                 }


                allWorkOrders = fetchedOrdersBatch.sort((a, b) => parseInt(b.id) - parseInt(a.id)); // Ensure final sort

                populateYearFilter();
                filterAndRenderOrders();
                showStatus(`Loaded ${allWorkOrders.length} work orders.`, 'success');

            } catch (error) {
                console.error("Error fetching all work orders:", error);
                workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-400">Error fetching work orders.</td></tr>';
                populateYearFilter();
            }
        }
        function populateYearFilter() {
            filterYearSelect.innerHTML = '<option value="all">All Years</option>';
             const years = Array.from(availableYears).sort((a, b) => b - a);
             years.forEach(year => {
                  const option = document.createElement('option'); option.value = year; option.textContent = year;
                  filterYearSelect.appendChild(option);
             });
        }
        function filterAndRenderOrders() {
            const selectedMonth = filterMonthSelect.value;
            const selectedYear = filterYearSelect.value;
            const filteredOrders = allWorkOrders.filter(order => {
                const monthMatch = selectedMonth === 'all' || order.createdMonth == selectedMonth;
                const yearMatch = selectedYear === 'all' || order.createdYear == selectedYear;
                return monthMatch && yearMatch;
            });
            renderWorkOrdersTable(filteredOrders);
        }
        function renderWorkOrdersTable(ordersToRender) {
             workOrdersTableBody.innerHTML = '';
             if (ordersToRender.length === 0) {
                  workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">No work orders match filters.</td></tr>';
                  return;
             }
             ordersToRender.forEach(order => {
                 const row = workOrdersTableBody.insertRow();
                 row.innerHTML = `
                     <td>${order.id}</td>
                     <td class="max-w-xs truncate" title="${order.description}">${order.description}</td>
                     <td>${parseFloat(formatUnits(order.grossYield, Number(usdcDecimals))).toFixed(2)}</td>
                     <td>${parseFloat(formatUnits(order.tokenizedValue, Number(usdcDecimals))).toFixed(2)}</td> {/* Display Tokenized Value */}
                     <td>${parseFloat(formatUnits(order.tokensIssued, mtyldDecimals)).toFixed(4)}</td>
                     <td>${order.isPaid ? '<span class="text-green font-semibold">Paid</span>' : (order.isActive ? '<span class="text-yellow font-semibold">Active</span>' : '<span class="text-red font-semibold">Cancelled</span>')}</td>
                     <td>${order.createdDateStr}</td>
                 `;
             });
         }


        // --- Admin Actions (Updated for Timelock & Pause) ---

        async function handleProposeMint(event) {
             event.preventDefault();
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");

             const yieldStr = document.getElementById('propose-yield').value;
             const description = document.getElementById('propose-desc').value;
             const button = event.target.querySelector('button[type="submit"]');
             const originalText = 'Propose Mint';

             if (!yieldStr || parseFloat(yieldStr) <= 0 || !description) return showStatus('Valid yield & description required.', 'error');
             const grossYield = parseUnits(yieldStr, Number(usdcDecimals));
             if (grossYield === null) return;

             setLoading(button, true, originalText);
             showStatus('Sending propose mint transaction...');
             try {
                 const tx = await mtyldContract.proposeMint(grossYield, description);
                 showStatus('Propose mint sent. Waiting...', 'info');
                 const receipt = await tx.wait();
                 console.log("Propose Mint Receipt:", receipt);

                 let proposalId = 'N/A';
                 // Find MintProposed event
                 const eventInterface = new ethers.Interface(contractABI);
                 if(receipt && receipt.logs) {
                      for (const log of receipt.logs) {
                           if (log.topics && log.data && log.address.toLowerCase() === contractAddress.toLowerCase()) {
                                try {
                                    const parsedLog = eventInterface.parseLog({ topics: [...log.topics], data: log.data });
                                    if (parsedLog && parsedLog.name === "MintProposed") {
                                        proposalId = parsedLog.args.proposalId.toString();
                                        break;
                                    }
                                } catch (e) { console.warn("Could not parse log for proposal ID:", log, e); }
                           }
                      }
                 }

                 showStatus(`Mint proposal #${proposalId} created successfully! Execution possible after delay.`, 'success');
                 proposeMintForm.reset();
                 await checkPendingProposals(); // Update admin UI
             } catch (error) {
                  console.error("Propose Mint failed:", error);
                  showStatus(`Propose mint failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                  setLoading(button, false, originalText);
             }
         }

        async function handleExecuteMint() {
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");

             const proposalIdStr = executeMintIdInput.value;
             const button = executeMintButton;
             const originalText = 'Execute Mint (after delay)';

             if (!proposalIdStr || parseInt(proposalIdStr) < 1) return showStatus('Enter valid Proposal ID.', 'error');
             const proposalId = BigInt(proposalIdStr);

             // Double check executability (client-side)
             try {
                  const mintProposal = await mtyldContract.pendingMints(proposalId);
                  if (!mintProposal.exists) return showStatus(`Proposal ${proposalId} not found or already executed.`, 'error');
                  const delaySeconds = Number(currentProposalDelay || 0n);
                  const canExecute = blockTimestamp ? blockTimestamp >= mintProposal.proposedAt + BigInt(delaySeconds) : false;
                  const canExecuteEstimate = (Date.now() / 1000) >= Number(mintProposal.proposedAt) + delaySeconds;

                  if (!(canExecute || canExecuteEstimate)) {
                       return showStatus(`Proposal ${proposalId} not yet executable. Wait for delay.`, 'warning');
                  }
             } catch (e) { return showStatus('Error checking proposal status.', 'error'); }


             setLoading(button, true, originalText);
             showStatus(`Executing mint proposal #${proposalId}...`);
             try {
                 const tx = await mtyldContract.executeMint(proposalId);
                 showStatus('Execute mint sent. Waiting...', 'info');
                 const receipt = await tx.wait();
                 console.log("Execute Mint Receipt:", receipt);
                 showStatus(`Mint proposal #${proposalId} executed successfully! Work order created.`, 'success');
                 executeMintIdInput.value = ''; // Clear input
                 await checkPendingProposals(); // Update admin UI
                 await updateProtocolInfo();
                 await fetchAndStoreAllWorkOrders(); // Refresh orders
             } catch (error) {
                  console.error("Execute Mint failed:", error);
                  showStatus(`Execute mint failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                  setLoading(button, false, originalText);
                 // Re-check proposal status after execution attempt
                 await checkPendingMintDetails();
             }
         }


        // Update Payout form to show expected tokenized value
         payoutIdInput = document.getElementById('payout-id');
         payoutIdInput.addEventListener('input', async () => {
             const orderIdStr = payoutIdInput.value;
              payoutTokenizedValueSpan.textContent = '--'; // Reset
              if (!orderIdStr || parseInt(orderIdStr) < 1 || !mtyldContract) return;
             const orderId = BigInt(orderIdStr);
             try {
                  const order = await mtyldContract.workOrders(orderId);
                  if (order.id !== 0n) {
                       payoutTokenizedValueSpan.textContent = `${parseFloat(formatUnits(order.tokenizedValue, usdcDecimals)).toFixed(2)} USDC`;
                       // Optionally pre-fill payout amount
                       // document.getElementById('payout-amount').value = parseFloat(formatUnits(order.tokenizedValue, usdcDecimals)).toFixed(2);
                  } else {
                       payoutTokenizedValueSpan.textContent = 'Not Found';
                  }
             } catch {
                  payoutTokenizedValueSpan.textContent = 'Error';
             }
         });
         const payoutIdInput = document.getElementById('payout-id'); // Assign here


        async function handlePayoutOrder(event) {
             event.preventDefault();
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");

             const orderIdStr = payoutIdInput.value;
             const amountStr = document.getElementById('payout-amount').value;
             const button = event.target.querySelector('button[type="submit"]');
             const originalText = 'Submit Payout';

              if (!orderIdStr || parseInt(orderIdStr) < 1 || !amountStr || parseFloat(amountStr) <= 0) return showStatus('Valid ID & Amount required.', 'error');
             const orderId = BigInt(orderIdStr);
             const payoutAmount = parseUnits(amountStr, Number(usdcDecimals));
              if (payoutAmount === null) return;

              // Client-side check against expected value (contract enforces it too)
              try {
                  const order = await mtyldContract.workOrders(orderId);
                  if (order.id === 0n) return showStatus('Work order not found.', 'error');
                  if (order.isPaid) return showStatus('Work order already paid.', 'warning');
                  if (payoutAmount !== order.tokenizedValue) {
                      return showStatus(`Payout Amount (${amountStr}) must exactly match Tokenized Value (${formatUnits(order.tokenizedValue, usdcDecimals)}).`, 'error');
                  }
                   const allowance = await usdcContract.allowance(userAddress, contractAddress);
                   if (allowance < payoutAmount) return showStatus('Insufficient USDC allowance. Please approve.', 'error');
              } catch (e) { return showStatus('Error checking order or allowance.', 'error'); }


             setLoading(button, true, originalText);
             showStatus(`Sending payout for order #${orderId}...`);
             try {
                 const tx = await mtyldContract.payoutWorkOrder(orderId, payoutAmount);
                 showStatus('Payout sent. Waiting...', 'info');
                 const receipt = await tx.wait();
                 console.log("Payout Receipt:", receipt);
                 showStatus(`Work order #${orderId} paid out!`, 'success');
                 payoutOrderForm.reset();
                 payoutTokenizedValueSpan.textContent = '--'; // Reset helper text
                 await updateProtocolInfo();
                 await updateWalletInfo();
                 await fetchAndStoreAllWorkOrders();
             } catch (error) {
                 console.error("Payout failed:", error);
                 showStatus(`Payout failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                 setLoading(button, false, originalText);
             }
         }


        async function handleCancelOrder(event) {
             event.preventDefault();
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");

              const orderIdStr = document.getElementById('cancel-id').value;
              const button = event.target.querySelector('button[type="submit"]');
              const originalText = 'Cancel Order';

              if (!orderIdStr || parseInt(orderIdStr) < 1) return showStatus('Valid ID required.', 'error');
              const orderId = BigInt(orderIdStr);

              if (!confirm(`Cancel Work Order #${orderId}? Cannot be undone.`)) return;

             setLoading(button, true, originalText);
             showStatus(`Cancelling order #${orderId}...`);
             try {
                 const tx = await mtyldContract.cancelWorkOrder(orderId);
                 showStatus('Cancel sent. Waiting...', 'info');
                 const receipt = await tx.wait();
                 console.log("Cancel Receipt:", receipt);
                 showStatus(`Order #${orderId} cancelled!`, 'success');
                 cancelOrderForm.reset();
                 await fetchAndStoreAllWorkOrders();
             } catch (error) {
                 console.error("Cancel failed:", error);
                 showStatus(`Cancel failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                 setLoading(button, false, originalText);
             }
         }


        async function handleProposeFeeChange(event) {
             event.preventDefault();
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");

             const feeStr = document.getElementById('propose-new-fee').value;
             const button = event.target.querySelector('button[type="submit"]');
             const originalText = 'Propose Fee Change';

             const fee = parseFloat(feeStr);
             if (isNaN(fee) || fee < 0 || fee > 20) return showStatus('Fee must be between 0 and 20.', 'error');
             const feeBigInt = BigInt(Math.round(fee));

             setLoading(button, true, originalText);
             showStatus(`Proposing fee change to ${fee}%...`);
             try {
                 const tx = await mtyldContract.proposeFeeChange(feeBigInt);
                 showStatus('Propose fee sent. Waiting...', 'info');
                 const receipt = await tx.wait();
                 console.log("Propose Fee Receipt:", receipt);
                 showStatus(`Fee change to ${fee}% proposed! Execution possible after delay.`, 'success');
                 proposeFeeForm.reset();
                 await checkPendingProposals();
             } catch (error) {
                  console.error("Propose Fee failed:", error);
                  showStatus(`Propose fee failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                  setLoading(button, false, originalText);
             }
         }

        async function handleExecuteFeeChange() {
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");

             const button = executeFeeButton;
             const originalText = 'Execute Fee Change (after delay)';

             // Client-side check
             try {
                  const feeProposal = await mtyldContract.pendingFeeChange();
                  if (!feeProposal.exists) return showStatus('No pending fee proposal.', 'error');
                   const delaySeconds = Number(currentProposalDelay || 0n);
                   const canExecute = blockTimestamp ? blockTimestamp >= feeProposal.proposedAt + BigInt(delaySeconds) : false;
                   const canExecuteEstimate = (Date.now() / 1000) >= Number(feeProposal.proposedAt) + delaySeconds;

                   if (!(canExecute || canExecuteEstimate)) {
                        return showStatus('Proposal not yet executable. Wait for delay.', 'warning');
                   }
             } catch (e) { return showStatus('Error checking fee proposal status.', 'error'); }


             setLoading(button, true, originalText);
             showStatus('Executing fee change...');
             try {
                 const tx = await mtyldContract.executeFeeChange();
                 showStatus('Execute fee sent. Waiting...', 'info');
                 const receipt = await tx.wait();
                 console.log("Execute Fee Receipt:", receipt);
                 showStatus('Redemption fee updated successfully!', 'success');
                 await checkPendingProposals();
                 await updateAdminInfo();
                 await updateProtocolInfo();
             } catch (error) {
                  console.error("Execute Fee failed:", error);
                  showStatus(`Execute fee failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                  setLoading(button, false, originalText);
                  // Re-check proposal status
                  await checkPendingProposals();
             }
         }


        async function handleWithdrawFees() {
            if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning');
            if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");
            // ... (rest of function is okay)
            const button = withdrawFeesButton;
            const originalText = 'Withdraw All Fees';
            const feesAvailable = await mtyldContract.collectedFees();
            if (feesAvailable === 0n) return showStatus('No fees to withdraw.', 'info');

            setLoading(button, true, originalText);
            showStatus(`Withdrawing ${formatUnits(feesAvailable, Number(usdcDecimals))} USDC...`);
            try {
                const tx = await mtyldContract.withdrawFees();
                showStatus('Withdraw sent. Waiting...', 'info');
                const receipt = await tx.wait();
                console.log("Withdraw Fees Receipt:", receipt);
                showStatus('Fees withdrawn!', 'success');
                await updateAdminInfo();
                await updateWalletInfo();
            } catch (error) {
                console.error("Withdraw fees failed:", error);
                showStatus(`Withdraw failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
            } finally {
                setLoading(button, false, originalText);
            }
        }

        async function handleEmergencyWithdraw(event) {
            event.preventDefault();
             if (await mtyldContract.paused()) return showStatus('Contract is paused.', 'warning'); // Check pause
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");
             // ... (rest of function is okay)
             const tokenAddress = document.getElementById('emergency-token').value;
             const toAddress = document.getElementById('emergency-to').value;
             const amountStr = document.getElementById('emergency-amount').value;
             const button = event.target.querySelector('button[type="submit"]');
             const originalText = 'Withdraw Other Token';

              let amount;
              try { amount = BigInt(amountStr); if (amount <= 0n) throw new Error(); }
              catch { return showStatus('Valid positive amount needed.', 'error'); }
             if (!ethers.isAddress(tokenAddress) || !ethers.isAddress(toAddress)) return showStatus('Valid addresses needed.', 'error');
             if (tokenAddress.toLowerCase() === usdcAddress.toLowerCase()) return showStatus('Cannot withdraw core USDC token via emergency function.', 'error'); // Double check

             setLoading(button, true, originalText);
             showStatus(`Emergency withdrawing ${shortenAddress(tokenAddress)}...`);
             try {
                  const tx = await mtyldContract.emergencyWithdraw(tokenAddress, toAddress, amount);
                  showStatus('Emergency withdraw sent. Waiting...', 'info');
                  const receipt = await tx.wait();
                   console.log("Emergency Withdraw Receipt:", receipt);
                  showStatus('Emergency withdraw success!', 'success');
                  emergencyWithdrawForm.reset();
             } catch (error) {
                  console.error("Emergency withdraw failed:", error);
                  showStatus(`Emergency withdraw failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                  setLoading(button, false, originalText);
             }
        }

         // --- Pause/Unpause Logic ---
         async function handlePause() {
             if (await mtyldContract.paused()) return showStatus('Contract is already paused.', 'warning');
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");

             const button = pauseButton;
             const originalText = 'Pause Contract';

             if (!confirm("Are you sure you want to PAUSE the contract? This will halt buys, redeems, mints, payouts, etc.")) return;

             setLoading(button, true, originalText);
             showStatus('Sending pause transaction...');
             try {
                  const tx = await mtyldContract.pause();
                  showStatus('Pause sent. Waiting...', 'info');
                  const receipt = await tx.wait();
                  console.log("Pause Receipt:", receipt);
                  showStatus('Contract paused successfully!', 'success');
                  updatePauseUI(true);
                  updatePauseButtons(true);
             } catch (error) {
                  console.error("Pause failed:", error);
                  showStatus(`Pause failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                  setLoading(button, false, originalText);
                  // Refresh pause status just in case
                   const isPaused = await mtyldContract.paused();
                   updatePauseUI(isPaused);
                   updatePauseButtons(isPaused);
             }
         }

        async function handleUnpause() {
             // No need to check paused() modifier here, button state handles it mostly
             if (!mtyldContract || !signer || !contractOwner || !userAddress || userAddress.toLowerCase() !== contractOwner.toLowerCase()) return showStatus("Admin only.", "error");

             const button = unpauseButton;
             const originalText = 'Unpause Contract';

             if (!confirm("Are you sure you want to UNPAUSE the contract?")) return;

             setLoading(button, true, originalText);
             showStatus('Sending unpause transaction...');
             try {
                  const tx = await mtyldContract.unpause();
                  showStatus('Unpause sent. Waiting...', 'info');
                  const receipt = await tx.wait();
                  console.log("Unpause Receipt:", receipt);
                  showStatus('Contract unpaused successfully!', 'success');
                  updatePauseUI(false);
                  updatePauseButtons(false);
             } catch (error) {
                  console.error("Unpause failed:", error);
                  showStatus(`Unpause failed: ${error?.data?.message || error?.reason || error.message || error}`, 'error');
             } finally {
                  setLoading(button, false, originalText);
                   const isPaused = await mtyldContract.paused();
                   updatePauseUI(isPaused);
                   updatePauseButtons(isPaused);
             }
         }

        function updatePauseUI(isPaused) {
             if (isPaused) {
                  pausedOverlay.classList.remove('hidden');
                  pauseStatusIndicator.textContent = 'PAUSED';
                  pauseStatusIndicator.classList.remove('hidden', 'bg-green', 'text-green-foreground');
                  pauseStatusIndicator.classList.add('bg-yellow', 'text-yellow-foreground'); // Adjust colors if needed
             } else {
                  pausedOverlay.classList.add('hidden');
                  pauseStatusIndicator.textContent = 'Active';
                   pauseStatusIndicator.classList.remove('hidden', 'bg-yellow', 'text-yellow-foreground');
                   pauseStatusIndicator.classList.add('bg-green', 'text-green-foreground'); // Adjust colors
             }
              // Disable/enable forms based on pause state
             buyButton.disabled = isPaused || buyButton.textContent.includes('Processing'); // Keep disabled if processing
             redeemButton.disabled = isPaused || redeemButton.textContent.includes('Processing');
             // Admin buttons also disabled by setLoading, but ensure they respect pause state
             if (adminPanelDiv && !adminPanelDiv.classList.contains('hidden')) {
                  adminPanelDiv.querySelectorAll('button[type="submit"], button[type="button"]').forEach(btn => {
                      // Don't disable unpause button, or buttons currently loading
                      if (btn.id !== 'unpause-button' && !btn.textContent.includes('Processing')) {
                          btn.disabled = isPaused;
                      }
                  });
                   // Special handling for pause/unpause buttons themselves
                  updatePauseButtons(isPaused);
             }
         }

         function updatePauseButtons(isPaused) {
              if (pauseButton) pauseButton.disabled = isPaused;
              if (unpauseButton) unpauseButton.disabled = !isPaused;
         }


        // --- Event Listeners Setup ---
         function setupEventListeners() {
            if (window.eventListenersAttached) return;

             // Input listeners
             buyUsdcAmountInput.addEventListener('input', updateBuyEstimate);
             buySlippageSelect.addEventListener('change', updateBuyEstimate);
             redeemMtyldAmountInput.addEventListener('input', updateRedeemEstimate);
             redeemSlippageSelect.addEventListener('change', updateRedeemEstimate);

             // Button listeners
             approveUsdcButton.addEventListener('click', () => handleApproveUSDC(false));
             buyForm.addEventListener('submit', handleBuyTokens);
             redeemForm.addEventListener('submit', handleRedeemTokens);

            // Filter listeners
            filterMonthSelect.addEventListener('change', filterAndRenderOrders);
            filterYearSelect.addEventListener('change', filterAndRenderOrders);

             // Admin listeners
             if (adminApproveUsdcButton) adminApproveUsdcButton.addEventListener('click', () => handleApproveUSDC(true));
             if (proposeMintForm) proposeMintForm.addEventListener('submit', handleProposeMint);
             if (executeMintButton) executeMintButton.addEventListener('click', handleExecuteMint); // Changed to click
             if (payoutOrderForm) payoutOrderForm.addEventListener('submit', handlePayoutOrder);
             if (cancelOrderForm) cancelOrderForm.addEventListener('submit', handleCancelOrder);
             if (proposeFeeForm) proposeFeeForm.addEventListener('submit', handleProposeFeeChange);
             if (executeFeeButton) executeFeeButton.addEventListener('click', handleExecuteFeeChange); // Changed to click
             if (withdrawFeesButton) withdrawFeesButton.addEventListener('click', handleWithdrawFees);
             if (emergencyWithdrawForm) emergencyWithdrawForm.addEventListener('submit', handleEmergencyWithdraw);
             if (pauseButton) pauseButton.addEventListener('click', handlePause);
             if (unpauseButton) unpauseButton.addEventListener('click', handleUnpause);


             window.eventListenersAttached = true;
         }

         function setupWalletListeners() {
              if (window.ethereum && window.ethereum.on) {
                 window.ethereum.on('accountsChanged', (accounts) => {
                     console.log('Accounts changed:', accounts);
                     if (accounts.length === 0) {
                         showStatus('Wallet disconnected. Please reconnect.', 'warning');
                         resetState();
                     } else if (!userAddress || accounts[0].toLowerCase() !== userAddress.toLowerCase()) {
                          showStatus('Account switched. Reconnecting...', 'info');
                          resetState(); // Reset before reconnecting
                          connectWallet();
                     }
                 });

                 window.ethereum.on('chainChanged', (chainId) => {
                     console.log('Network changed to:', chainId);
                      if (chainId !== arbitrumChainId) {
                           showStatus('Incorrect network. Please switch to Arbitrum One.', 'error');
                           resetState();
                           connectButton.textContent = 'Wrong Network';
                           connectButton.disabled = true;
                      } else {
                           // Correct network detected or switched back
                           showStatus('Arbitrum One network detected. Reconnecting or refresh page...', 'info');
                           resetState(); // Reset state
                           connectWallet(); // Attempt to reconnect on correct chain
                           // Consider window.location.reload(); if reconnect logic is complex
                      }
                 });
             } else {
                  console.warn("MetaMask event listeners not available.");
             }
         }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
             connectButton.addEventListener('click', connectWallet);
             setupEventListeners(); // Setup form/button listeners on load
             workOrdersTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-secondary">Connect wallet to view orders.</td></tr>';
             populateYearFilter();
        });

    </script>
</body>
</html>

